<?xml version="1.0" encoding="UTF-8" standalone="yes"?><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" xmlns:yandex="http://news.yandex.ru" xmlns:turbo="http://turbo.yandex.ru"><channel><title>windows / Library Online</title><link>https://lib.onl/ru/tags/windows/</link><description>Заметки на тему администрирования и разработки различных систем, приложений и серверов.</description><language>ru-RU</language><sy:updatePeriod>weekly</sy:updatePeriod><sy:updateFrequency>1</sy:updateFrequency><image><link>https://lib.onl/ru/tags/windows/</link><url>https://lib.onl/favicon-128.png</url><width>128</width><height>128</height><title>windows / Library Online</title><description>Заметки на тему администрирования и разработки различных систем, приложений и серверов.</description></image><lastBuildDate>Sun, 22 Oct 2023 14:06:44 +0000</lastBuildDate><atom:link href="https://lib.onl/ru/tags/windows/index.xml" rel="self" type="application/rss+xml"/><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>PowerShell: Сжатие видео при помощи FFmpeg</title><link>https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/</guid><description>Когда то в далёкой далёкой галактике&amp;hellip; Ко мне на работе обратились с просьбой как то уменьшить видео, записанное на камеру в формате .mov. Естественно, я воспользовался библиотекой FFmpeg. Но скрипт автоматизации решил написать только сейчас&amp;hellip;</description><media:content medium="image" url="https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d" width="1600" height="900"/><content:encoded><![CDATA[<p>Когда то в далёкой далёкой галактике&hellip; Ко мне на работе обратились с просьбой как то уменьшить видео, записанное на камеру в формате <code>.mov</code>. Естественно, я воспользовался библиотекой FFmpeg. Но скрипт автоматизации решил написать только сейчас&hellip;</p>
<p>Скрипт прост как лапоть. Состоит из небольшого количества вводных параметров, большинство из которых изменять не требуется. Предназначен скрипт для быстрого пакетного конвертирования файлов видео из одного формата в другой, в основном, с целью уменьшения размера. Скрипт не предназначен для сложного редактирования видео!</p>
<h2 id="параметры">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b">Параметры</a>
</h2><ul>
<li><code>-F</code> <code>-Files</code> - массив входящих файлов.</li>
<li><code>-CV</code> <code>-vCodec</code> - видео кодек, используемый для конвертации. По умолчанию: <code>libx265</code>. Поддерживаемые кодеки:
<ul>
<li><code>libx264</code> - кодек &ldquo;H.264&rdquo;.</li>
<li><code>libx265</code> - кодек &ldquo;H.265&rdquo;.</li>
<li><code>libvpx-vp9</code> - кодек &ldquo;VP9&rdquo; (&ldquo;WebM&rdquo;).</li>
<li><code>libaom-av1</code> - кодек &ldquo;AV1&rdquo;.</li>
</ul>
</li>
<li><code>-CA</code> <code>-aCodec</code> - аудио кодек, используемый для конвертации. По умолчанию: <code>copy</code>. Поддерживаемые кодеки:
<ul>
<li><code>libfdk_aac</code> - кодек &ldquo;Fraunhofer FDK AAC&rdquo;.</li>
<li><code>aac</code> - кодек &ldquo;FFmpeg AAC&rdquo;.</li>
<li><code>libmp3lame</code> - кодек &ldquo;FFmpeg MP3&rdquo;.</li>
</ul>
</li>
<li><code>-R</code> <code>-Framerate</code> - частота кадров выходящего файла (FPS). Сжатие кадров с учётом движения, где сцены движения кодируются с меньшим качеством, чем статичные сцены, что субъективно приводит к восприятию, как качественного, ибо визуально человек различает больше деталей в неподвижных объектах, чем в движущихся. Если параметр не указан, то значение берётся из входящего файла.</li>
<li><code>-C</code> <code>-CRF</code> - постоянный коэффициент потока (Constant Rate Factor). Это режим кодирования для кодеков &ldquo;H.264&rdquo; и &ldquo;H.265&rdquo; с постоянным воспринимаемым качеством, осуществляемый с помощью настройки качества (и управления скоростью). Если параметр не указан, то значение берётся по умолчанию, обычно это <code>28</code> при кодеке <code>libx265</code> и <code>23</code> при <code>libx264</code>.</li>
<li><code>-P</code> <code>-Preset</code> - пресеты. Это набор параметров, которые обеспечивают определённую скорость кодирования с степень сжатия. У каждого кодека видео свой набор пресетов. Нужно смотреть <a title="" href="https://trac.ffmpeg.org/wiki" target="_blank" rel="noopener noreferrer nofollow">документацию</a>.</li>
<li><code>-EXT</code> <code>-Extension</code> - расширение выходящих файлов.</li>
</ul>
<h2 id="примеры">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80%d1%8b">Примеры</a>
</h2><p>Конвертировать файлы <code>file_01.mov</code>, <code>file_02.mov</code> и <code>file_03.mov</code> в формат <code>mp4</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-072b945737064c4785052af16fe34e4a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">ffmpeg</span><span class="p">.</span><span class="py">video</span><span class="p">.</span><span class="py">compress</span><span class="p">.</span><span class="py">ps1</span> <span class="o">-F</span> <span class="s1">&#39;file_01.mov&#39;</span><span class="p">,</span> <span class="s1">&#39;file_02.mov&#39;</span><span class="p">,</span> <span class="s1">&#39;file_03.mov&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-072b945737064c4785052af16fe34e4a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Пакетная конвертация всех файлов с расширением <code>.mov</code> в формат <code>mp4</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f74a0a1d17a67c81782f01a80e71a699"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">ffmpeg</span><span class="p">.</span><span class="py">video</span><span class="p">.</span><span class="py">compress</span><span class="p">.</span><span class="py">ps1</span> <span class="o">-F</span> <span class="s1">&#39;*.mov&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f74a0a1d17a67c81782f01a80e71a699"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h2 id="алгоритм-работы">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b">Алгоритм работы</a>
</h2><p>Скрипт предназначен для быстрого пакетного преобразования файлов видео из одного формата в другой.</p>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для работы скрипта необходим файл <code>ffmpeg.exe</code>, архив которого можно скачать с сайта <a title="" href="https://www.gyan.dev/ffmpeg/builds/" target="_blank" rel="noopener noreferrer nofollow">gyan.dev</a>, распаковать и разместить рядом с файлом скрипта или в любую дочернюю директорию. Скрипт сам найдёт файл <code>ffmpeg.exe</code> и начнёт его использовать.</p>

    </div>
  </div>
</div>

<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>ffmpeg.video.compress.ps1</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-9cfad56b1add0a097a46d073546e5739"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="ffmpeg.video.compress.ps1" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="ffmpeg.video.compress.ps1" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-9cfad56b1add0a097a46d073546e5739"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps1" data-lang="ps1"><span class="line"><span class="cl"><span class="cm">&lt;#PSScriptInfo
</span></span></span><span class="line"><span class="cl"><span class="cm">  .VERSION      0.1.0
</span></span></span><span class="line"><span class="cl"><span class="cm">  .GUID         b95fb1ac-6878-4451-bb49-434d51d9555d
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOR       Kitsune Solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COMPANYNAME  iHub TO
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm">  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PROJECTURI   https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#</span><span class="k">Requires</span><span class="w"> </span><span class="kd">-Version</span><span class="na"> 7.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">&lt;#
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">SYNOPSIS</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  Video compression script based on FFmpeg.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">DESCRIPTION</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  FFmpeg is a free and open-source software project consisting of a suite of libraries and programs for handling video, audio, and other multimedia files and streams.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Files
</span></span></span><span class="line"><span class="cl"><span class="cm">  An array of input files.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER vCodec
</span></span></span><span class="line"><span class="cl"><span class="cm">  The video codec.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;libx265&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER aCodec
</span></span></span><span class="line"><span class="cl"><span class="cm">  The audio codec.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;copy&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Framerate
</span></span></span><span class="line"><span class="cl"><span class="cm">  FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate. The output duration of the video will stay the same.
</span></span></span><span class="line"><span class="cl"><span class="cm">  This is useful when working with, for example, high-framerate input video that needs to be temporally scaled down for devices that do not support high FPS.
</span></span></span><span class="line"><span class="cl"><span class="cm">  When the frame rate is changed, FFmpeg will drop or duplicate frames as necessary to achieve the targeted output frame rate.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER CRF
</span></span></span><span class="line"><span class="cl"><span class="cm">  Constant Rate Factor.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Use this rate control mode if you want to keep the best quality and care less about the file size. This is the recommended rate control mode for most uses.
</span></span></span><span class="line"><span class="cl"><span class="cm">  This method allows the encoder to attempt to achieve a certain output quality for the whole file when output file size is of less importance. This provides maximum compression efficiency with a single pass. By adjusting the so-called quantizer for each frame, it gets the bitrate it needs to keep the requested quality level. The downside is that you can&#39;t tell it to get a specific filesize or not go over a specific size or bitrate, which means that this method is not recommended for encoding videos for streaming.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Preset
</span></span></span><span class="line"><span class="cl"><span class="cm">  A preset is a collection of options that will provide a certain encoding speed to compression ratio. A slower preset will provide better compression (compression is quality per filesize). This means that, for example, if you target a certain file size or constant bit rate, you will achieve better quality with a slower preset. Similarly, for constant quality encoding, you will simply save bitrate by choosing a slower preset.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Extension
</span></span></span><span class="line"><span class="cl"><span class="cm">  The extension of the resulting files.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;mp4&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\ffmpeg.video.compress.ps1 -F &#39;file_01.mov&#39;, &#39;file_02.mov&#39;, &#39;file_03.mov&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\ffmpeg.video.compress.ps1 -F &#39;*.mov&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">LINK</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Param</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">Mandatory</span><span class="p">,</span> <span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;An array of input files.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)][</span><span class="no">string[]</span><span class="p">]</span><span class="nv">$Files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The video codec.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$vCodec</span> <span class="p">=</span> <span class="s1">&#39;libx265&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The audio codec.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CA&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$aCodec</span> <span class="p">=</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$Framerate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Constant Rate Factor. Use this rate control mode if you want to keep the best quality and care less about the file size.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$CRF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;A preset is a collection of options that will provide a certain encoding speed to compression ratio.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Preset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The extension of the resulting files.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;EXT&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Extension</span> <span class="p">=</span> <span class="s1">&#39;mp4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CONFIGURATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># New line separator.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$NL</span> <span class="p">=</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">NewLine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># INITIALIZATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-Script</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Compress-Video</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># COMPRESS.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Compress-Video</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">ForEach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="nv">$Files</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start-FFmpeg</span> <span class="n">-I</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># FFmpeg.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-FFmpeg</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$In</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$FFmpegExe</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#34;</span> <span class="n">-Filter</span> <span class="s1">&#39;ffmpeg.exe&#39;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="p">!</span><span class="nv">$_PSIsContainer</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${FFmpegExe}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="p">(</span><span class="s2">&#34;&#39;ffmpeg.exe&#39; not found!</span><span class="nv">${NL}${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;1. Download FFmpeg from &#39;https://www.gyan.dev/ffmpeg/builds/&#39;.</span><span class="nv">${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;2. Extract &#39;ffmpeg.exe&#39; into a directory &#39;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-WarningAction</span> <span class="s1">&#39;Stop&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-hide_banner&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${In}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-c:v&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${vCodec}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$CRF</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-crf&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${CRF}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$Preset</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-preset&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Preset}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$Framerate</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Framerate}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-c:a&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${aCodec}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$In</span> <span class="p">+</span> <span class="s1">&#39;.&#39;</span> <span class="p">+</span> <span class="nv">$Extension</span><span class="p">)</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">&amp;</span> <span class="s2">&#34;</span><span class="nv">${FFmpegExe}</span><span class="s2">&#34;</span> <span class="nv">$Params</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Start-Script</span>
</span></span></code></pre></div></div>
      </div>
    </div>]]></content:encoded><turbo:source/><turbo:topic>PowerShell: Сжатие видео при помощи FFmpeg</turbo:topic><turbo:content><![CDATA[<p>Когда то в далёкой далёкой галактике&hellip; Ко мне на работе обратились с просьбой как то уменьшить видео, записанное на камеру в формате <code>.mov</code>. Естественно, я воспользовался библиотекой FFmpeg. Но скрипт автоматизации решил написать только сейчас&hellip;</p>
<p>Скрипт прост как лапоть. Состоит из небольшого количества вводных параметров, большинство из которых изменять не требуется. Предназначен скрипт для быстрого пакетного конвертирования файлов видео из одного формата в другой, в основном, с целью уменьшения размера. Скрипт не предназначен для сложного редактирования видео!</p>
<h2 id="параметры">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b">Параметры</a>
</h2><ul>
<li><code>-F</code> <code>-Files</code> - массив входящих файлов.</li>
<li><code>-CV</code> <code>-vCodec</code> - видео кодек, используемый для конвертации. По умолчанию: <code>libx265</code>. Поддерживаемые кодеки:
<ul>
<li><code>libx264</code> - кодек &ldquo;H.264&rdquo;.</li>
<li><code>libx265</code> - кодек &ldquo;H.265&rdquo;.</li>
<li><code>libvpx-vp9</code> - кодек &ldquo;VP9&rdquo; (&ldquo;WebM&rdquo;).</li>
<li><code>libaom-av1</code> - кодек &ldquo;AV1&rdquo;.</li>
</ul>
</li>
<li><code>-CA</code> <code>-aCodec</code> - аудио кодек, используемый для конвертации. По умолчанию: <code>copy</code>. Поддерживаемые кодеки:
<ul>
<li><code>libfdk_aac</code> - кодек &ldquo;Fraunhofer FDK AAC&rdquo;.</li>
<li><code>aac</code> - кодек &ldquo;FFmpeg AAC&rdquo;.</li>
<li><code>libmp3lame</code> - кодек &ldquo;FFmpeg MP3&rdquo;.</li>
</ul>
</li>
<li><code>-R</code> <code>-Framerate</code> - частота кадров выходящего файла (FPS). Сжатие кадров с учётом движения, где сцены движения кодируются с меньшим качеством, чем статичные сцены, что субъективно приводит к восприятию, как качественного, ибо визуально человек различает больше деталей в неподвижных объектах, чем в движущихся. Если параметр не указан, то значение берётся из входящего файла.</li>
<li><code>-C</code> <code>-CRF</code> - постоянный коэффициент потока (Constant Rate Factor). Это режим кодирования для кодеков &ldquo;H.264&rdquo; и &ldquo;H.265&rdquo; с постоянным воспринимаемым качеством, осуществляемый с помощью настройки качества (и управления скоростью). Если параметр не указан, то значение берётся по умолчанию, обычно это <code>28</code> при кодеке <code>libx265</code> и <code>23</code> при <code>libx264</code>.</li>
<li><code>-P</code> <code>-Preset</code> - пресеты. Это набор параметров, которые обеспечивают определённую скорость кодирования с степень сжатия. У каждого кодека видео свой набор пресетов. Нужно смотреть <a title="" href="https://trac.ffmpeg.org/wiki" target="_blank" rel="noopener noreferrer nofollow">документацию</a>.</li>
<li><code>-EXT</code> <code>-Extension</code> - расширение выходящих файлов.</li>
</ul>
<h2 id="примеры">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80%d1%8b">Примеры</a>
</h2><p>Конвертировать файлы <code>file_01.mov</code>, <code>file_02.mov</code> и <code>file_03.mov</code> в формат <code>mp4</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-072b945737064c4785052af16fe34e4a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">ffmpeg</span><span class="p">.</span><span class="py">video</span><span class="p">.</span><span class="py">compress</span><span class="p">.</span><span class="py">ps1</span> <span class="o">-F</span> <span class="s1">&#39;file_01.mov&#39;</span><span class="p">,</span> <span class="s1">&#39;file_02.mov&#39;</span><span class="p">,</span> <span class="s1">&#39;file_03.mov&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-072b945737064c4785052af16fe34e4a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Пакетная конвертация всех файлов с расширением <code>.mov</code> в формат <code>mp4</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f74a0a1d17a67c81782f01a80e71a699"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">ffmpeg</span><span class="p">.</span><span class="py">video</span><span class="p">.</span><span class="py">compress</span><span class="p">.</span><span class="py">ps1</span> <span class="o">-F</span> <span class="s1">&#39;*.mov&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f74a0a1d17a67c81782f01a80e71a699"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h2 id="алгоритм-работы">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b">Алгоритм работы</a>
</h2><p>Скрипт предназначен для быстрого пакетного преобразования файлов видео из одного формата в другой.</p>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для работы скрипта необходим файл <code>ffmpeg.exe</code>, архив которого можно скачать с сайта <a title="" href="https://www.gyan.dev/ffmpeg/builds/" target="_blank" rel="noopener noreferrer nofollow">gyan.dev</a>, распаковать и разместить рядом с файлом скрипта или в любую дочернюю директорию. Скрипт сам найдёт файл <code>ffmpeg.exe</code> и начнёт его использовать.</p>

    </div>
  </div>
</div>

<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>ffmpeg.video.compress.ps1</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-9cfad56b1add0a097a46d073546e5739"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="ffmpeg.video.compress.ps1" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="ffmpeg.video.compress.ps1" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-9cfad56b1add0a097a46d073546e5739"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps1" data-lang="ps1"><span class="line"><span class="cl"><span class="cm">&lt;#PSScriptInfo
</span></span></span><span class="line"><span class="cl"><span class="cm">  .VERSION      0.1.0
</span></span></span><span class="line"><span class="cl"><span class="cm">  .GUID         b95fb1ac-6878-4451-bb49-434d51d9555d
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOR       Kitsune Solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COMPANYNAME  iHub TO
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm">  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PROJECTURI   https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#</span><span class="k">Requires</span><span class="w"> </span><span class="kd">-Version</span><span class="na"> 7.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">&lt;#
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">SYNOPSIS</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  Video compression script based on FFmpeg.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">DESCRIPTION</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  FFmpeg is a free and open-source software project consisting of a suite of libraries and programs for handling video, audio, and other multimedia files and streams.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Files
</span></span></span><span class="line"><span class="cl"><span class="cm">  An array of input files.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER vCodec
</span></span></span><span class="line"><span class="cl"><span class="cm">  The video codec.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;libx265&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER aCodec
</span></span></span><span class="line"><span class="cl"><span class="cm">  The audio codec.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;copy&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Framerate
</span></span></span><span class="line"><span class="cl"><span class="cm">  FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate. The output duration of the video will stay the same.
</span></span></span><span class="line"><span class="cl"><span class="cm">  This is useful when working with, for example, high-framerate input video that needs to be temporally scaled down for devices that do not support high FPS.
</span></span></span><span class="line"><span class="cl"><span class="cm">  When the frame rate is changed, FFmpeg will drop or duplicate frames as necessary to achieve the targeted output frame rate.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER CRF
</span></span></span><span class="line"><span class="cl"><span class="cm">  Constant Rate Factor.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Use this rate control mode if you want to keep the best quality and care less about the file size. This is the recommended rate control mode for most uses.
</span></span></span><span class="line"><span class="cl"><span class="cm">  This method allows the encoder to attempt to achieve a certain output quality for the whole file when output file size is of less importance. This provides maximum compression efficiency with a single pass. By adjusting the so-called quantizer for each frame, it gets the bitrate it needs to keep the requested quality level. The downside is that you can&#39;t tell it to get a specific filesize or not go over a specific size or bitrate, which means that this method is not recommended for encoding videos for streaming.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Preset
</span></span></span><span class="line"><span class="cl"><span class="cm">  A preset is a collection of options that will provide a certain encoding speed to compression ratio. A slower preset will provide better compression (compression is quality per filesize). This means that, for example, if you target a certain file size or constant bit rate, you will achieve better quality with a slower preset. Similarly, for constant quality encoding, you will simply save bitrate by choosing a slower preset.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Extension
</span></span></span><span class="line"><span class="cl"><span class="cm">  The extension of the resulting files.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;mp4&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\ffmpeg.video.compress.ps1 -F &#39;file_01.mov&#39;, &#39;file_02.mov&#39;, &#39;file_03.mov&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\ffmpeg.video.compress.ps1 -F &#39;*.mov&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">LINK</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Param</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">Mandatory</span><span class="p">,</span> <span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;An array of input files.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)][</span><span class="no">string[]</span><span class="p">]</span><span class="nv">$Files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The video codec.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$vCodec</span> <span class="p">=</span> <span class="s1">&#39;libx265&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The audio codec.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CA&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$aCodec</span> <span class="p">=</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$Framerate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Constant Rate Factor. Use this rate control mode if you want to keep the best quality and care less about the file size.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$CRF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;A preset is a collection of options that will provide a certain encoding speed to compression ratio.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Preset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;The extension of the resulting files.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;EXT&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Extension</span> <span class="p">=</span> <span class="s1">&#39;mp4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CONFIGURATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># New line separator.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$NL</span> <span class="p">=</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">NewLine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># INITIALIZATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-Script</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Compress-Video</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># COMPRESS.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Compress-Video</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">ForEach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="nv">$Files</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start-FFmpeg</span> <span class="n">-I</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># FFmpeg.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-FFmpeg</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$In</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$FFmpegExe</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#34;</span> <span class="n">-Filter</span> <span class="s1">&#39;ffmpeg.exe&#39;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="p">!</span><span class="nv">$_PSIsContainer</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${FFmpegExe}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="p">(</span><span class="s2">&#34;&#39;ffmpeg.exe&#39; not found!</span><span class="nv">${NL}${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;1. Download FFmpeg from &#39;https://www.gyan.dev/ffmpeg/builds/&#39;.</span><span class="nv">${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;2. Extract &#39;ffmpeg.exe&#39; into a directory &#39;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-WarningAction</span> <span class="s1">&#39;Stop&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-hide_banner&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${In}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-c:v&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${vCodec}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$CRF</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-crf&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${CRF}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$Preset</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-preset&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Preset}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$Framerate</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Framerate}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;-c:a&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${aCodec}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">+=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$In</span> <span class="p">+</span> <span class="s1">&#39;.&#39;</span> <span class="p">+</span> <span class="nv">$Extension</span><span class="p">)</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">&amp;</span> <span class="s2">&#34;</span><span class="nv">${FFmpegExe}</span><span class="s2">&#34;</span> <span class="nv">$Params</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Start-Script</span>
</span></span></code></pre></div></div>
      </div>
    </div>]]></turbo:content><pubDate>Sun, 22 Oct 2023 14:06:44 +0000</pubDate><category>MS Windows</category><category>Терминал</category><category>Скрипты</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>PowerShell: Определение разрядности ОС Windows</title><link>https://lib.onl/ru/posts/2023/10/0028821e-c96c-5014-a1dd-8963c161b170/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/0028821e-c96c-5014-a1dd-8963c161b170/</guid><description>Нашёл на Stack Overflow хорошую функцию по определению разрядности ОС и процесса PowerShell. Запишу, обязательно пригодится.</description><media:content medium="image" url="https://images.unsplash.com/photo-1642176849879-92f85770f212" width="1600" height="900"/><content:encoded><![CDATA[<p>Нашёл на Stack Overflow хорошую функцию по определению разрядности ОС и процесса PowerShell. Запишу, обязательно пригодится.</p>
<h2 id="разрядность-ос">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b7%d1%80%d1%8f%d0%b4%d0%bd%d0%be%d1%81%d1%82%d1%8c-%d0%be%d1%81">Разрядность ОС</a>
</h2><p>Разрядность ОС можно определить следующей функцией:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-013c5222bb33db95e3b8cee59654876c"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Get-Architecture</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does Windows use.</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span> <span class="p">{</span> <span class="c"># Needs &#39;.NET 4&#39;.</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$true</span>   <span class="p">{</span> <span class="mf">64</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$false</span>  <span class="p">{</span> <span class="mf">32</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="py">OSArchitecture</span> <span class="o">-replace</span> <span class="s1">&#39;\D&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_Processor).AddressWidth # This is slow...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-013c5222bb33db95e3b8cee59654876c"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p>
<h3 id="результат">
  <a class="link-body-emphasis" href="#%d1%80%d0%b5%d0%b7%d1%83%d0%bb%d1%8c%d1%82%d0%b0%d1%82">Результат</a>
</h3>





<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a8dd510fd9b4aa857ce28430cf542b6b"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-a8dd510fd9b4aa857ce28430cf542b6b"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">.\arch.ps1
64</code></pre></div>
  </div>
</div>
<h2 id="разрядность-ос-и-powershell">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b7%d1%80%d1%8f%d0%b4%d0%bd%d0%be%d1%81%d1%82%d1%8c-%d0%be%d1%81-%d0%b8-powershell">Разрядность ОС и PowerShell</a>
</h2><p>Расширенная версия, которая позволяет определить разрядность ОС и процесса PowerShell, под которым выполняется функция.</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e5a00e3be1246b0aba8fa0224b1fcd25"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Get-Architecture</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does Windows use.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$windowsBitness</span> <span class="p">=</span> <span class="k">switch</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span> <span class="p">{</span> <span class="c"># Needs &#39;.NET 4&#39;.</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$true</span>   <span class="p">{</span> <span class="mf">64</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$false</span>  <span class="p">{</span> <span class="mf">32</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="py">OSArchitecture</span> <span class="o">-replace</span> <span class="s1">&#39;\D&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_Processor).AddressWidth # Slow...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does this PowerShell process use.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$processBitness</span> <span class="p">=</span> <span class="p">[</span><span class="no">IntPtr</span><span class="p">]::</span><span class="n">Size</span> <span class="p">*</span> <span class="mf">8</span>
</span></span><span class="line"><span class="cl">  <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">  <span class="c"># $processBitness = $env:PROCESSOR_ARCHITECTURE -replace &#39;\D&#39; -replace &#39;86|ARM&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># $processBitness = if ([Environment]::Is64BitProcess) { 64 } else { 32 }</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Return the info as object.</span>
</span></span><span class="line"><span class="cl">  <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">PSObject</span> <span class="n">-Property</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ProcessArchitecture&#39;</span> <span class="p">=</span> <span class="s2">&#34;{0} bit&#34;</span> <span class="o">-f</span> <span class="nv">$processBitness</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;WindowsArchitecture&#39;</span> <span class="p">=</span> <span class="s2">&#34;{0} bit&#34;</span> <span class="o">-f</span> <span class="nv">$windowsBitness</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e5a00e3be1246b0aba8fa0224b1fcd25"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p>
<h3 id="результат-1">
  <a class="link-body-emphasis" href="#%d1%80%d0%b5%d0%b7%d1%83%d0%bb%d1%8c%d1%82%d0%b0%d1%82-1">Результат</a>
</h3>





<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-fc7b74e0835684c7d51c493b3e3f1178"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-fc7b74e0835684c7d51c493b3e3f1178"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">.\arch.ps1

ProcessArchitecture WindowsArchitecture
------------------- -------------------
64 bit              64 bit</code></pre></div>
  </div>
</div>]]></content:encoded><turbo:source/><turbo:topic>PowerShell: Определение разрядности ОС Windows</turbo:topic><turbo:content><![CDATA[<p>Нашёл на Stack Overflow хорошую функцию по определению разрядности ОС и процесса PowerShell. Запишу, обязательно пригодится.</p>
<h2 id="разрядность-ос">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b7%d1%80%d1%8f%d0%b4%d0%bd%d0%be%d1%81%d1%82%d1%8c-%d0%be%d1%81">Разрядность ОС</a>
</h2><p>Разрядность ОС можно определить следующей функцией:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-013c5222bb33db95e3b8cee59654876c"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Get-Architecture</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does Windows use.</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span> <span class="p">{</span> <span class="c"># Needs &#39;.NET 4&#39;.</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$true</span>   <span class="p">{</span> <span class="mf">64</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$false</span>  <span class="p">{</span> <span class="mf">32</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="py">OSArchitecture</span> <span class="o">-replace</span> <span class="s1">&#39;\D&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_Processor).AddressWidth # This is slow...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-013c5222bb33db95e3b8cee59654876c"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p>
<h3 id="результат">
  <a class="link-body-emphasis" href="#%d1%80%d0%b5%d0%b7%d1%83%d0%bb%d1%8c%d1%82%d0%b0%d1%82">Результат</a>
</h3>





<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a8dd510fd9b4aa857ce28430cf542b6b"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-a8dd510fd9b4aa857ce28430cf542b6b"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">.\arch.ps1
64</code></pre></div>
  </div>
</div>
<h2 id="разрядность-ос-и-powershell">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b7%d1%80%d1%8f%d0%b4%d0%bd%d0%be%d1%81%d1%82%d1%8c-%d0%be%d1%81-%d0%b8-powershell">Разрядность ОС и PowerShell</a>
</h2><p>Расширенная версия, которая позволяет определить разрядность ОС и процесса PowerShell, под которым выполняется функция.</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e5a00e3be1246b0aba8fa0224b1fcd25"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Get-Architecture</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does Windows use.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$windowsBitness</span> <span class="p">=</span> <span class="k">switch</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">Is64BitOperatingSystem</span><span class="p">)</span> <span class="p">{</span> <span class="c"># Needs &#39;.NET 4&#39;.</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$true</span>   <span class="p">{</span> <span class="mf">64</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="vm">$false</span>  <span class="p">{</span> <span class="mf">32</span><span class="p">;</span> <span class="k">break</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="py">OSArchitecture</span> <span class="o">-replace</span> <span class="s1">&#39;\D&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c"># (Get-WmiObject -Class Win32_Processor).AddressWidth # Slow...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># What bitness does this PowerShell process use.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$processBitness</span> <span class="p">=</span> <span class="p">[</span><span class="no">IntPtr</span><span class="p">]::</span><span class="n">Size</span> <span class="p">*</span> <span class="mf">8</span>
</span></span><span class="line"><span class="cl">  <span class="c"># Or do any of these:</span>
</span></span><span class="line"><span class="cl">  <span class="c"># $processBitness = $env:PROCESSOR_ARCHITECTURE -replace &#39;\D&#39; -replace &#39;86|ARM&#39;, &#39;32&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># $processBitness = if ([Environment]::Is64BitProcess) { 64 } else { 32 }</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Return the info as object.</span>
</span></span><span class="line"><span class="cl">  <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">PSObject</span> <span class="n">-Property</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ProcessArchitecture&#39;</span> <span class="p">=</span> <span class="s2">&#34;{0} bit&#34;</span> <span class="o">-f</span> <span class="nv">$processBitness</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;WindowsArchitecture&#39;</span> <span class="p">=</span> <span class="s2">&#34;{0} bit&#34;</span> <span class="o">-f</span> <span class="nv">$windowsBitness</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e5a00e3be1246b0aba8fa0224b1fcd25"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p>
<h3 id="результат-1">
  <a class="link-body-emphasis" href="#%d1%80%d0%b5%d0%b7%d1%83%d0%bb%d1%8c%d1%82%d0%b0%d1%82-1">Результат</a>
</h3>





<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-fc7b74e0835684c7d51c493b3e3f1178"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-fc7b74e0835684c7d51c493b3e3f1178"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">.\arch.ps1

ProcessArchitecture WindowsArchitecture
------------------- -------------------
64 bit              64 bit</code></pre></div>
  </div>
</div>]]></turbo:content><pubDate>Sat, 21 Oct 2023 17:42:05 +0000</pubDate><category>MS Windows</category><category>Терминал</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>PowerShell Vault</title><link>https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/</guid><description>На работе в локальной сети использовалась задача, которая перемещала старые, по долгу не использовавшиеся, файлы из главного файлового хранилища в резервное. Но так как организация являлась проектной, то старые файлы могли понадобиться в любое время.</description><media:content medium="image" url="https://images.unsplash.com/photo-1609358905581-e5381612486e" width="1600" height="900"/><content:encoded><![CDATA[<p>На работе в локальной сети использовалась задача, которая перемещала старые, по долгу не использовавшиеся, файлы из главного файлового хранилища в резервное. Но так как организация являлась проектной, то старые файлы могли понадобиться в любое время.</p>
<p>Задача использовала простой скрипт с фильтрацией файлов по параметрам <em>время создания</em> и <em>время изменения</em>. Я чуть доработали скрипт и решил опубликовать его для других администраторов. Вдруг, пригодится. Только перед использованием прошу проверить скрипт в какой-нибудь песочнице.</p>










    
    




<div class="shortcode shortcode-alert">
  <div class="alert alert-danger d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-circle-radiation fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Есть вероятность, что скрипт удалит все файлы в вашем файловом хранилище, из-за того, что автор может оказаться <em>рукожопом</em>! Поэтому, перед боевой задачей, проверьте скрипт в какой-нибудь песочнице. А кто хорошо разбирается в PowerShell - автор будет благодарен за оптимизацию и корректировку скрипта.</p>

    </div>
  </div>
</div>

<h2 id="параметры">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b">Параметры</a>
</h2><ul>
<li><code>-M</code> <code>-Mode</code> - режим работы скрипта. По умолчанию <code>'MV'</code>.
<ul>
<li><code>'CP'</code> - копировать файлы из источника в хранилище.</li>
<li><code>'MV'</code> - перемещать файлы из источника в хранилище.</li>
<li><code>'RM'</code> - только удалять файлы из источника без копирования или перемещения куда-либо.</li>
</ul>
</li>
<li><code>-SRC</code> <code>-Source</code> - путь к директории откуда перемещать файлы. Например, <code>-SRC 'C:\Data\Source'</code>. По умолчанию: <code>${PSScriptRoot}\Source</code>.</li>
<li><code>-DST</code> <code>-Destination</code> - путь к директории куда перемещать файлы. Например, <code>-DST 'C:\Data\Vault'</code>. По умолчанию: <code>${PSScriptRoot}\Vault</code>.</li>
<li><code>-CT</code> <code>-Create</code> <code>-CreationTime</code> - время создания файла в секундах. Например, <code>-CT 5270400</code>. По умолчанию: <code>5270400</code> (61 день).</li>
<li><code>-WT</code> <code>-Modify</code> <code>-LastWriteTime</code> - время изменения файла в секундах. Например, <code>-WT 5270400</code>. По умолчанию: <code>5270400</code> (61 день).</li>
<li><code>-FS</code> <code>-Size</code> <code>-FileSize</code> - размер файла. Например, <code>-FS '5kb'</code> или <code>-FS '12mb'</code>. По умолчанию: <code>'0kb'</code>.</li>
<li><code>-E</code> <code>-Exclude</code> - путь к файлу с исключениями. Например, <code>-E 'C:\Data\exclude.txt'</code>. По умолчанию: <code>${PSScriptRoot}\vault.exclude.txt</code>.</li>
<li><code>-L</code> <code>-Logs</code> - путь к директории с журналами работы скрипта. Например, <code>-L 'C:\Data\Logs'</code>. По умолчанию: <code>${PSScriptRoot}\Logs</code>.</li>
<li><code>-RD</code> <code>-RemoveDirs</code> - удалять пустые каталоги.</li>
<li><code>-O</code> <code>-Overwrite</code> - перезаписать файлы в Vault.</li>
</ul>
<h2 id="примеры">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80%d1%8b">Примеры</a>
</h2><p>Запустить перемещение файлов из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8085cdf18cc0bd33d05c2a1d7bf986ea"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8085cdf18cc0bd33d05c2a1d7bf986ea"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-da6563d52854870f74442233929bb7c8"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-da6563d52854870f74442233929bb7c8"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) и размером более 32 мегабайта (<code>32mb</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e833234cb18ee8af67e5377fdd708ec7"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-FS</span> <span class="s1">&#39;32mb&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e833234cb18ee8af67e5377fdd708ec7"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>), и с перезаписью файлов с одинаковыми названиями (<code>-O</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8de5dadda9904dc8b939136f76daae8e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-O</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8de5dadda9904dc8b939136f76daae8e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Параметр <code>-O</code> означает, что не нужно архивировать старый файл при перемещении нового с таким же названием. Старый файл в хранилище перезапишется новым.</p>
<h2 id="алгоритм-работы">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b">Алгоритм работы</a>
</h2><p>Скрипт создаёт хранилище старых файлов. Это, своего рода, аналог резервного копирования. При перемещении файлов из источника в хранилище, скрипт обрабатывает несколько заданных параметров и фильтров. Всё настроить можно под себя. По умолчанию, скрипт перемещает файлы из источника в хранилище, и если в хранилище уже имеется старый файл с названием кау у нового перемещаемого, то старый файл архивируется с меткой <code>VAULT.yyyy-MM-dd.HH-mm-ss</code>.</p>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для работы скрипта необходим архиватор <strong>7-Zip</strong>, а конкретно его облегчённая версия <code>7za.exe</code> с библиотеками из <strong>7-Zip Extra</strong>. Скачать можно с <a title="" href="https://www.7-zip.org/download.html" target="_blank" rel="noopener noreferrer nofollow">официального сайта</a>. После скачивания архива, файлы <code>7za.exe</code>, <code>7za.dll</code> и <code>7zxa.dll</code> нужно разместить рядом со скриптом, или в любую дочернюю директорию. Скрипт сам найдёт путь к <code>7za.exe</code>.</p>

    </div>
  </div>
</div>

<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>vault.ps1</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c5956e515a611c58412b47d2cdcea117"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="vault.ps1" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="vault.ps1" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-c5956e515a611c58412b47d2cdcea117"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps1" data-lang="ps1"><span class="line"><span class="cl"><span class="cm">&lt;#PSScriptInfo
</span></span></span><span class="line"><span class="cl"><span class="cm">  .VERSION      0.1.1
</span></span></span><span class="line"><span class="cl"><span class="cm">  .GUID         8fd0ce2c-0288-4d9c-805f-703a0c659ade
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOR       Kitsune Solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COMPANYNAME  iHub TO
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm">  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PROJECTURI   https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#</span><span class="k">Requires</span><span class="w"> </span><span class="kd">-Version</span><span class="na"> 7.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">&lt;#
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">SYNOPSIS</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  PowerShell &#34;Vault&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">DESCRIPTION</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  The script moves files to Vault based on various criteria.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Mode
</span></span></span><span class="line"><span class="cl"><span class="cm">  Script operation mode.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;MV&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Source
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the source. E.g.: &#39;C:\Data\Source&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Source&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Destination
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Vault&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER CreationTime
</span></span></span><span class="line"><span class="cl"><span class="cm">  Time since file creation (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;5270400&#39; (61 day).
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER LastWriteTime
</span></span></span><span class="line"><span class="cl"><span class="cm">  Time since file modification (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;5270400&#39; (61 day).
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER FileSize
</span></span></span><span class="line"><span class="cl"><span class="cm">  File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;0kb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Exclude
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\vault.exclude.txt&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Logs
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Logs&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER RemoveDirs
</span></span></span><span class="line"><span class="cl"><span class="cm">  Removing empty directories.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;false&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Overwrite
</span></span></span><span class="line"><span class="cl"><span class="cm">  Overwrite existing files in Vault.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;false&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39; -FS &#39;32mb&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">LINK</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Param</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Script operation mode. Default: &#39;MV&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">ValidateSet</span><span class="p">(</span><span class="s1">&#39;CP&#39;</span><span class="p">,</span> <span class="s1">&#39;MV&#39;</span><span class="p">,</span> <span class="s1">&#39;RM&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Mode</span> <span class="p">=</span> <span class="s1">&#39;MV&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the source. E.g.: &#39;C:\Data\Source&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;SRC&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Source</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Source&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;DST&#39;</span><span class="p">,</span> <span class="s1">&#39;Vault&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Destination</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Vault&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Time since file creation (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (5270400 sec.).&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CT&#39;</span><span class="p">,</span> <span class="s1">&#39;Create&#39;</span><span class="p">)][</span><span class="no">long</span><span class="p">]</span><span class="nv">$CreationTime</span> <span class="p">=</span> <span class="mf">5270400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Time since file modification (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (&#39;5270400&#39; sec.).&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;WT&#39;</span><span class="p">,</span> <span class="s1">&#39;Modify&#39;</span><span class="p">)][</span><span class="no">long</span><span class="p">]</span><span class="nv">$LastWriteTime</span> <span class="p">=</span> <span class="mf">5270400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;. Default: &#39;0kb&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;FS&#39;</span><span class="p">,</span> <span class="s1">&#39;Size&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$FileSize</span> <span class="p">=</span> <span class="s1">&#39;0kb&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Exclude</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\vault.exclude.txt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Logs</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Logs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Removing empty directories.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;RD&#39;</span><span class="p">)][</span><span class="no">switch</span><span class="p">]</span><span class="nv">$RemoveDirs</span> <span class="p">=</span> <span class="vm">$false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Overwrite existing files in Vault.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)][</span><span class="no">switch</span><span class="p">]</span><span class="nv">$Overwrite</span> <span class="p">=</span> <span class="vm">$false</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CONFIGURATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Timestamp.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$TS</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s1">&#39;yyyy-MM-dd.HH-mm-ss&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># New line separator.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$NL</span> <span class="p">=</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">NewLine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># INITIALIZATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-Script</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Start-VaultCheck</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Start-VaultGetFiles</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$RemoveDirs</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Start-VaultRemoveDirs</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CREATE VAULT DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultCheck</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Dirs</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Files</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">${Exclude}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Dir</span> <span class="k">in</span> <span class="nv">$Dirs</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span> <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;Directory&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="nv">$Files</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span> <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;File&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># MOVE FILES TO VAULT.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultGetFiles</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;HL&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Moving files to Vault&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Items</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span> <span class="n">-Recurse</span> <span class="n">-Exclude</span> <span class="p">(</span><span class="nb">Get-Content</span> <span class="s2">&#34;</span><span class="nv">${Exclude}</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span><span class="p">))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">CreationTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$CreationTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">LastWriteTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$LastWriteTime</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">-ge</span> <span class="s2">&#34;</span><span class="nv">${FileSize}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;I&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Required files were not found in the source!&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Item</span> <span class="k">in</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="nv">$Item</span><span class="p">.</span><span class="py">FullName</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">-ge</span> <span class="mf">245</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;W&#39;</span> <span class="n">-M</span> <span class="s2">&#34;&#39;</span><span class="nv">${Item}</span><span class="s2">&#39; has over 250 characters in path! Skip...&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$Dir</span>  <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="py">Directory</span><span class="p">.</span><span class="py">ToString</span><span class="p">())</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$File</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="py">FullName</span><span class="p">.</span><span class="py">Remove</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="nv">$Source</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Path</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${Destination}${File}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nv">$Mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;CP&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-SimilarDirectory</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Backup-SimilarFile</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">.VAULT.</span><span class="nv">${TS}</span><span class="s2">.7z&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[CP] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39; -&gt; &#39;</span><span class="nv">${Path}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Destination</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;MV&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-SimilarDirectory</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Backup-SimilarFile</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">.VAULT.</span><span class="nv">${TS}</span><span class="s2">.7z&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[MV] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39; -&gt; &#39;</span><span class="nv">${Path}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Move-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Destination</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;RM&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[RM] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Remove-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># REMOVE EMPTY DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultRemoveDirs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;HL&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Removing empty directories&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Items</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">CreationTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$CreationTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">LastWriteTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$LastWriteTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;I&#39;</span> <span class="n">-M</span> <span class="s1">&#39;No empty directories were found in the source!&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Item</span> <span class="k">in</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(((</span><span class="nb">Get-ChildItem</span> <span class="s2">&#34;</span><span class="nv">${Item}</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="nb">Measure-Object</span><span class="p">).</span><span class="n">Count</span><span class="p">)</span> <span class="o">-eq</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[RM] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Remove-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Item}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CREATE SIMILAR DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">New-SimilarDirectory</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Name</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;Directory&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">    <span class="n">-Name</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Name</span><span class="p">.</span><span class="py">Remove</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="nv">$Source</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span><span class="s2">&#34;</span> <span class="n">-ErrorAction</span> <span class="s1">&#39;SilentlyContinue&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># BACKUP SIMILAR FILES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Backup-SimilarFile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Name</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Overwrite</span> <span class="o">-and</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Start</span><span class="p">-</span><span class="n">7z</span> <span class="n">-T</span> <span class="s1">&#39;7z&#39;</span> <span class="n">-L</span> <span class="mf">9</span> <span class="n">-I</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-O</span> <span class="s2">&#34;</span><span class="nv">${Name}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># MESSAGES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Write-VaultMsg</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Action</span> <span class="p">=</span> <span class="s1">&#39;Continue&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="nv">$Type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;HL&#39;</span>    <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="nv">${NL}</span><span class="s2">--- </span><span class="nv">${Message}</span><span class="s2">&#34;</span><span class="p">.</span><span class="py">ToUpper</span><span class="p">()</span> <span class="n">-ForegroundColor</span> <span class="n">Blue</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;I&#39;</span>     <span class="p">{</span> <span class="nb">Write-Information</span> <span class="n">-MessageData</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-InformationAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;W&#39;</span>     <span class="p">{</span> <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-WarningAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;E&#39;</span>     <span class="p">{</span> <span class="nb">Write-Error</span> <span class="n">-Message</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-ErrorAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># 7-ZIP.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-7z</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$In</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Out</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">ValidateSet</span><span class="p">(</span><span class="s1">&#39;7z&#39;</span><span class="p">,</span> <span class="s1">&#39;BZIP2&#39;</span><span class="p">,</span> <span class="s1">&#39;GZIP&#39;</span><span class="p">,</span> <span class="s1">&#39;TAR&#39;</span><span class="p">,</span> <span class="s1">&#39;WIM&#39;</span><span class="p">,</span> <span class="s1">&#39;XZ&#39;</span><span class="p">,</span> <span class="s1">&#39;ZIP&#39;</span><span class="p">)][</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Type</span> <span class="p">=</span> <span class="s1">&#39;7z&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">ValidateRange</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="mf">9</span><span class="p">)][</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$Level</span> <span class="p">=</span> <span class="mf">5</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># File list for &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7z</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;7za.exe&#39;</span><span class="p">,</span> <span class="s1">&#39;7za.dll&#39;</span><span class="p">,</span> <span class="s1">&#39;7zxa.dll&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Search &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7zExe</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#34;</span> <span class="n">-Filter</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$7z</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="s2">&#34;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="p">!</span><span class="nv">$_PSIsContainer</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Getting &#39;7za.exe&#39; directory.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7zDir</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$7zExe</span><span class="p">.</span><span class="n">Directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Checking the location of files.</span>
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="nv">$7z</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${7zDir}</span><span class="s2">\</span><span class="nv">${File}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;W&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-M</span> <span class="p">(</span><span class="s2">&#34;&#39;</span><span class="nv">${File}</span><span class="s2">&#39; not found!</span><span class="nv">${NL}${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;1. Download 7-Zip Extra from &#39;https://www.7-zip.org/download.html&#39;.</span><span class="nv">${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;2. Extract all contents into a directory &#39;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-A</span> <span class="s1">&#39;Stop&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Specifying &#39;7za.exe&#39; parameters.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s2">&#34;-t</span><span class="nv">${Type}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;-mx</span><span class="nv">${Level}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Out}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${In}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Running &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="p">&amp;</span> <span class="s2">&#34;</span><span class="nv">${7zExe}</span><span class="s2">&#34;</span> <span class="nv">$Params</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Start-Transcript</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Logs}</span><span class="s2">\</span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">Year</span><span class="p">)</span><span class="s2">\</span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">Month</span><span class="p">)</span><span class="s2">\</span><span class="nv">${TS}</span><span class="s2">.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Script</span>
</span></span><span class="line"><span class="cl"><span class="nb">Stop-Transcript</span>
</span></span></code></pre></div></div>
      </div>
    </div>]]></content:encoded><turbo:source/><turbo:topic>PowerShell Vault</turbo:topic><turbo:content><![CDATA[<p>На работе в локальной сети использовалась задача, которая перемещала старые, по долгу не использовавшиеся, файлы из главного файлового хранилища в резервное. Но так как организация являлась проектной, то старые файлы могли понадобиться в любое время.</p>
<p>Задача использовала простой скрипт с фильтрацией файлов по параметрам <em>время создания</em> и <em>время изменения</em>. Я чуть доработали скрипт и решил опубликовать его для других администраторов. Вдруг, пригодится. Только перед использованием прошу проверить скрипт в какой-нибудь песочнице.</p>










    
    




<div class="shortcode shortcode-alert">
  <div class="alert alert-danger d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-circle-radiation fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Есть вероятность, что скрипт удалит все файлы в вашем файловом хранилище, из-за того, что автор может оказаться <em>рукожопом</em>! Поэтому, перед боевой задачей, проверьте скрипт в какой-нибудь песочнице. А кто хорошо разбирается в PowerShell - автор будет благодарен за оптимизацию и корректировку скрипта.</p>

    </div>
  </div>
</div>

<h2 id="параметры">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b">Параметры</a>
</h2><ul>
<li><code>-M</code> <code>-Mode</code> - режим работы скрипта. По умолчанию <code>'MV'</code>.
<ul>
<li><code>'CP'</code> - копировать файлы из источника в хранилище.</li>
<li><code>'MV'</code> - перемещать файлы из источника в хранилище.</li>
<li><code>'RM'</code> - только удалять файлы из источника без копирования или перемещения куда-либо.</li>
</ul>
</li>
<li><code>-SRC</code> <code>-Source</code> - путь к директории откуда перемещать файлы. Например, <code>-SRC 'C:\Data\Source'</code>. По умолчанию: <code>${PSScriptRoot}\Source</code>.</li>
<li><code>-DST</code> <code>-Destination</code> - путь к директории куда перемещать файлы. Например, <code>-DST 'C:\Data\Vault'</code>. По умолчанию: <code>${PSScriptRoot}\Vault</code>.</li>
<li><code>-CT</code> <code>-Create</code> <code>-CreationTime</code> - время создания файла в секундах. Например, <code>-CT 5270400</code>. По умолчанию: <code>5270400</code> (61 день).</li>
<li><code>-WT</code> <code>-Modify</code> <code>-LastWriteTime</code> - время изменения файла в секундах. Например, <code>-WT 5270400</code>. По умолчанию: <code>5270400</code> (61 день).</li>
<li><code>-FS</code> <code>-Size</code> <code>-FileSize</code> - размер файла. Например, <code>-FS '5kb'</code> или <code>-FS '12mb'</code>. По умолчанию: <code>'0kb'</code>.</li>
<li><code>-E</code> <code>-Exclude</code> - путь к файлу с исключениями. Например, <code>-E 'C:\Data\exclude.txt'</code>. По умолчанию: <code>${PSScriptRoot}\vault.exclude.txt</code>.</li>
<li><code>-L</code> <code>-Logs</code> - путь к директории с журналами работы скрипта. Например, <code>-L 'C:\Data\Logs'</code>. По умолчанию: <code>${PSScriptRoot}\Logs</code>.</li>
<li><code>-RD</code> <code>-RemoveDirs</code> - удалять пустые каталоги.</li>
<li><code>-O</code> <code>-Overwrite</code> - перезаписать файлы в Vault.</li>
</ul>
<h2 id="примеры">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80%d1%8b">Примеры</a>
</h2><p>Запустить перемещение файлов из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8085cdf18cc0bd33d05c2a1d7bf986ea"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8085cdf18cc0bd33d05c2a1d7bf986ea"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-da6563d52854870f74442233929bb7c8"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-da6563d52854870f74442233929bb7c8"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) и размером более 32 мегабайта (<code>32mb</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e833234cb18ee8af67e5377fdd708ec7"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-FS</span> <span class="s1">&#39;32mb&#39;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e833234cb18ee8af67e5377fdd708ec7"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>), и с перезаписью файлов с одинаковыми названиями (<code>-O</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8de5dadda9904dc8b939136f76daae8e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">.\</span><span class="n">vault</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-SRC</span> <span class="s1">&#39;C:\Data\Source&#39;</span> <span class="n">-DST</span> <span class="s1">&#39;C:\Data\Vault&#39;</span> <span class="n">-CT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-WT</span> <span class="s1">&#39;864000&#39;</span> <span class="n">-O</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8de5dadda9904dc8b939136f76daae8e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Параметр <code>-O</code> означает, что не нужно архивировать старый файл при перемещении нового с таким же названием. Старый файл в хранилище перезапишется новым.</p>
<h2 id="алгоритм-работы">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b">Алгоритм работы</a>
</h2><p>Скрипт создаёт хранилище старых файлов. Это, своего рода, аналог резервного копирования. При перемещении файлов из источника в хранилище, скрипт обрабатывает несколько заданных параметров и фильтров. Всё настроить можно под себя. По умолчанию, скрипт перемещает файлы из источника в хранилище, и если в хранилище уже имеется старый файл с названием кау у нового перемещаемого, то старый файл архивируется с меткой <code>VAULT.yyyy-MM-dd.HH-mm-ss</code>.</p>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для работы скрипта необходим архиватор <strong>7-Zip</strong>, а конкретно его облегчённая версия <code>7za.exe</code> с библиотеками из <strong>7-Zip Extra</strong>. Скачать можно с <a title="" href="https://www.7-zip.org/download.html" target="_blank" rel="noopener noreferrer nofollow">официального сайта</a>. После скачивания архива, файлы <code>7za.exe</code>, <code>7za.dll</code> и <code>7zxa.dll</code> нужно разместить рядом со скриптом, или в любую дочернюю директорию. Скрипт сам найдёт путь к <code>7za.exe</code>.</p>

    </div>
  </div>
</div>

<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>vault.ps1</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c5956e515a611c58412b47d2cdcea117"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="vault.ps1" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="vault.ps1" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-c5956e515a611c58412b47d2cdcea117"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ps1" data-lang="ps1"><span class="line"><span class="cl"><span class="cm">&lt;#PSScriptInfo
</span></span></span><span class="line"><span class="cl"><span class="cm">  .VERSION      0.1.1
</span></span></span><span class="line"><span class="cl"><span class="cm">  .GUID         8fd0ce2c-0288-4d9c-805f-703a0c659ade
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOR       Kitsune Solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COMPANYNAME  iHub TO
</span></span></span><span class="line"><span class="cl"><span class="cm">  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm">  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PROJECTURI   https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#</span><span class="k">Requires</span><span class="w"> </span><span class="kd">-Version</span><span class="na"> 7.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">&lt;#
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">SYNOPSIS</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  PowerShell &#34;Vault&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">DESCRIPTION</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  The script moves files to Vault based on various criteria.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Mode
</span></span></span><span class="line"><span class="cl"><span class="cm">  Script operation mode.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;MV&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Source
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the source. E.g.: &#39;C:\Data\Source&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Source&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Destination
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Vault&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER CreationTime
</span></span></span><span class="line"><span class="cl"><span class="cm">  Time since file creation (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;5270400&#39; (61 day).
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER LastWriteTime
</span></span></span><span class="line"><span class="cl"><span class="cm">  Time since file modification (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;5270400&#39; (61 day).
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER FileSize
</span></span></span><span class="line"><span class="cl"><span class="cm">  File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;0kb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Exclude
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\vault.exclude.txt&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Logs
</span></span></span><span class="line"><span class="cl"><span class="cm">  Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;${PSScriptRoot}\Logs&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER RemoveDirs
</span></span></span><span class="line"><span class="cl"><span class="cm">  Removing empty directories.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;false&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .PARAMETER Overwrite
</span></span></span><span class="line"><span class="cl"><span class="cm">  Overwrite existing files in Vault.
</span></span></span><span class="line"><span class="cl"><span class="cm">  Default: &#39;false&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">EXAMPLE</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .\vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39; -FS &#39;32mb&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  .</span><span class="sd">LINK</span><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class="line"><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Param</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Script operation mode. Default: &#39;MV&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">ValidateSet</span><span class="p">(</span><span class="s1">&#39;CP&#39;</span><span class="p">,</span> <span class="s1">&#39;MV&#39;</span><span class="p">,</span> <span class="s1">&#39;RM&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Mode</span> <span class="p">=</span> <span class="s1">&#39;MV&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the source. E.g.: &#39;C:\Data\Source&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;SRC&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Source</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Source&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;DST&#39;</span><span class="p">,</span> <span class="s1">&#39;Vault&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Destination</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Vault&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Time since file creation (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (5270400 sec.).&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;CT&#39;</span><span class="p">,</span> <span class="s1">&#39;Create&#39;</span><span class="p">)][</span><span class="no">long</span><span class="p">]</span><span class="nv">$CreationTime</span> <span class="p">=</span> <span class="mf">5270400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Time since file modification (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (&#39;5270400&#39; sec.).&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;WT&#39;</span><span class="p">,</span> <span class="s1">&#39;Modify&#39;</span><span class="p">)][</span><span class="no">long</span><span class="p">]</span><span class="nv">$LastWriteTime</span> <span class="p">=</span> <span class="mf">5270400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;. Default: &#39;0kb&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;FS&#39;</span><span class="p">,</span> <span class="s1">&#39;Size&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$FileSize</span> <span class="p">=</span> <span class="s1">&#39;0kb&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Exclude</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\vault.exclude.txt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Logs</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">\Logs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Removing empty directories.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;RD&#39;</span><span class="p">)][</span><span class="no">switch</span><span class="p">]</span><span class="nv">$RemoveDirs</span> <span class="p">=</span> <span class="vm">$false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">HelpMessage</span><span class="p">=</span><span class="s2">&#34;Overwrite existing files in Vault.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)][</span><span class="no">switch</span><span class="p">]</span><span class="nv">$Overwrite</span> <span class="p">=</span> <span class="vm">$false</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CONFIGURATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Timestamp.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$TS</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s1">&#39;yyyy-MM-dd.HH-mm-ss&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># New line separator.</span>
</span></span><span class="line"><span class="cl"><span class="nv">$NL</span> <span class="p">=</span> <span class="p">([</span><span class="no">Environment</span><span class="p">]::</span><span class="n">NewLine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># INITIALIZATION.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-Script</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Start-VaultCheck</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Start-VaultGetFiles</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nv">$RemoveDirs</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Start-VaultRemoveDirs</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CREATE VAULT DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultCheck</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Dirs</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Files</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">${Exclude}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Dir</span> <span class="k">in</span> <span class="nv">$Dirs</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span> <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;Directory&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="nv">$Files</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span> <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${File}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;File&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># MOVE FILES TO VAULT.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultGetFiles</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;HL&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Moving files to Vault&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Items</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span> <span class="n">-Recurse</span> <span class="n">-Exclude</span> <span class="p">(</span><span class="nb">Get-Content</span> <span class="s2">&#34;</span><span class="nv">${Exclude}</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span><span class="p">))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">CreationTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$CreationTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">LastWriteTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$LastWriteTime</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">-ge</span> <span class="s2">&#34;</span><span class="nv">${FileSize}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;I&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Required files were not found in the source!&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Item</span> <span class="k">in</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="nv">$Item</span><span class="p">.</span><span class="py">FullName</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">-ge</span> <span class="mf">245</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;W&#39;</span> <span class="n">-M</span> <span class="s2">&#34;&#39;</span><span class="nv">${Item}</span><span class="s2">&#39; has over 250 characters in path! Skip...&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$Dir</span>  <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="py">Directory</span><span class="p">.</span><span class="py">ToString</span><span class="p">())</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$File</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="py">FullName</span><span class="p">.</span><span class="py">Remove</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="nv">$Source</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Path</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">${Destination}${File}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nv">$Mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;CP&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-SimilarDirectory</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Backup-SimilarFile</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">.VAULT.</span><span class="nv">${TS}</span><span class="s2">.7z&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[CP] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39; -&gt; &#39;</span><span class="nv">${Path}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Destination</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;MV&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-SimilarDirectory</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Destination}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Dir}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Backup-SimilarFile</span> <span class="n">-P</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-N</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">.VAULT.</span><span class="nv">${TS}</span><span class="s2">.7z&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[MV] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39; -&gt; &#39;</span><span class="nv">${Path}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Move-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Destination</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;RM&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[RM] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Remove-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Item</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># REMOVE EMPTY DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-VaultRemoveDirs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;HL&#39;</span> <span class="n">-M</span> <span class="s1">&#39;Removing empty directories&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$Items</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Source}</span><span class="s2">&#34;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">CreationTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$CreationTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">        <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">LastWriteTime</span><span class="p">)</span> <span class="o">-lt</span> <span class="p">((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddSeconds</span><span class="p">(-</span><span class="nv">$LastWriteTime</span><span class="p">)))</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;I&#39;</span> <span class="n">-M</span> <span class="s1">&#39;No empty directories were found in the source!&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Item</span> <span class="k">in</span> <span class="nv">$Items</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(((</span><span class="nb">Get-ChildItem</span> <span class="s2">&#34;</span><span class="nv">${Item}</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="nb">Measure-Object</span><span class="p">).</span><span class="n">Count</span><span class="p">)</span> <span class="o">-eq</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Write-VaultMsg</span> <span class="n">-M</span> <span class="s2">&#34;[RM] &#39;</span><span class="nv">${Item}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">Remove-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Item}</span><span class="s2">&#34;</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># CREATE SIMILAR DIRECTORIES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">New-SimilarDirectory</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Name</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-ItemType</span> <span class="s1">&#39;Directory&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">    <span class="n">-Name</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$Name</span><span class="p">.</span><span class="py">Remove</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="nv">$Source</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span><span class="s2">&#34;</span> <span class="n">-ErrorAction</span> <span class="s1">&#39;SilentlyContinue&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># BACKUP SIMILAR FILES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Backup-SimilarFile</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Name</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$Overwrite</span> <span class="o">-and</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Start</span><span class="p">-</span><span class="n">7z</span> <span class="n">-T</span> <span class="s1">&#39;7z&#39;</span> <span class="n">-L</span> <span class="mf">9</span> <span class="n">-I</span> <span class="s2">&#34;</span><span class="nv">${Path}</span><span class="s2">&#34;</span> <span class="n">-O</span> <span class="s2">&#34;</span><span class="nv">${Name}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># MESSAGES.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Write-VaultMsg</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Action</span> <span class="p">=</span> <span class="s1">&#39;Continue&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="nv">$Type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;HL&#39;</span>    <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="nv">${NL}</span><span class="s2">--- </span><span class="nv">${Message}</span><span class="s2">&#34;</span><span class="p">.</span><span class="py">ToUpper</span><span class="p">()</span> <span class="n">-ForegroundColor</span> <span class="n">Blue</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;I&#39;</span>     <span class="p">{</span> <span class="nb">Write-Information</span> <span class="n">-MessageData</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-InformationAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;W&#39;</span>     <span class="p">{</span> <span class="nb">Write-Warning</span> <span class="n">-Message</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-WarningAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;E&#39;</span>     <span class="p">{</span> <span class="nb">Write-Error</span> <span class="n">-Message</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="n">-ErrorAction</span> <span class="s2">&#34;</span><span class="nv">${Action}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="nv">${Message}</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># 7-ZIP.</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Start-7z</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$In</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Out</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">ValidateSet</span><span class="p">(</span><span class="s1">&#39;7z&#39;</span><span class="p">,</span> <span class="s1">&#39;BZIP2&#39;</span><span class="p">,</span> <span class="s1">&#39;GZIP&#39;</span><span class="p">,</span> <span class="s1">&#39;TAR&#39;</span><span class="p">,</span> <span class="s1">&#39;WIM&#39;</span><span class="p">,</span> <span class="s1">&#39;XZ&#39;</span><span class="p">,</span> <span class="s1">&#39;ZIP&#39;</span><span class="p">)][</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)][</span><span class="no">string</span><span class="p">]</span><span class="nv">$Type</span> <span class="p">=</span> <span class="s1">&#39;7z&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nb">ValidateRange</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="mf">9</span><span class="p">)][</span><span class="nb">Alias</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)][</span><span class="no">int</span><span class="p">]</span><span class="nv">$Level</span> <span class="p">=</span> <span class="mf">5</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># File list for &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7z</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;7za.exe&#39;</span><span class="p">,</span> <span class="s1">&#39;7za.dll&#39;</span><span class="p">,</span> <span class="s1">&#39;7zxa.dll&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Search &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7zExe</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#34;</span> <span class="n">-Filter</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$7z</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="s2">&#34;</span> <span class="n">-Recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="p">!</span><span class="nv">$_PSIsContainer</span> <span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-First</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Getting &#39;7za.exe&#39; directory.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$7zDir</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$7zExe</span><span class="p">.</span><span class="n">Directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Checking the location of files.</span>
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$File</span> <span class="k">in</span> <span class="nv">$7z</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;</span><span class="nv">${7zDir}</span><span class="s2">\</span><span class="nv">${File}</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-VaultMsg</span> <span class="n">-T</span> <span class="s1">&#39;W&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-M</span> <span class="p">(</span><span class="s2">&#34;&#39;</span><span class="nv">${File}</span><span class="s2">&#39; not found!</span><span class="nv">${NL}${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;1. Download 7-Zip Extra from &#39;https://www.7-zip.org/download.html&#39;.</span><span class="nv">${NL}</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;2. Extract all contents into a directory &#39;</span><span class="nv">${PSScriptRoot}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">      <span class="n">-A</span> <span class="s1">&#39;Stop&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Specifying &#39;7za.exe&#39; parameters.</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$Params</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s2">&#34;-t</span><span class="nv">${Type}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;-mx</span><span class="nv">${Level}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${Out}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">${In}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># Running &#39;7za.exe&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="p">&amp;</span> <span class="s2">&#34;</span><span class="nv">${7zExe}</span><span class="s2">&#34;</span> <span class="nv">$Params</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Start-Transcript</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">${Logs}</span><span class="s2">\</span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">Year</span><span class="p">)</span><span class="s2">\</span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">Month</span><span class="p">)</span><span class="s2">\</span><span class="nv">${TS}</span><span class="s2">.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Script</span>
</span></span><span class="line"><span class="cl"><span class="nb">Stop-Transcript</span>
</span></span></code></pre></div></div>
      </div>
    </div>]]></turbo:content><pubDate>Fri, 20 Oct 2023 09:57:21 +0000</pubDate><category>MS Windows</category><category>Терминал</category><category>Скрипты</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Дефрагментация в ОС Windows</title><link>https://lib.onl/ru/posts/2023/10/eb39e3f7-b194-53d4-8bad-01edf9fdac47/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/eb39e3f7-b194-53d4-8bad-01edf9fdac47/</guid><description>При работе с оборудованием, мне приходится сталкиваться с довольно старыми устройствами, их их работу нужно как-нибудь оптимизировать. Одним из вариантов оптимизации является дефрагментация HDD.</description><media:content medium="image" url="https://images.unsplash.com/photo-1591913139332-f8172ef511da" width="1600" height="900"/><content:encoded><![CDATA[<p>При работе с оборудованием, мне приходится сталкиваться с довольно старыми устройствами, их их работу нужно как-нибудь оптимизировать. Одним из вариантов оптимизации является дефрагментация HDD.</p>
<h2 id="powershell">
  <a class="link-body-emphasis" href="#powershell">PowerShell</a>
</h2><p>Командлет по дефрагментации для PowerShell называется <code>Optimize-Volume</code> и может принимать следующие параметры:</p>
<ul>
<li><code>-Analyze</code> - выполнение анализа указанного тома.</li>
<li><code>-Defrag</code> - выполнение дефрагментации указанного тома.</li>
<li><code>-DriveLetter</code> - буква тома.</li>
<li><code>-NormalPriority</code> - выполнение процесса с нормальным приоритетом (по умолчанию приоритет пониженный).</li>
<li><code>-ReTrim</code> - выполнение TRIM-операции для SSD.</li>
</ul>
<p>Это наиболее востребованные параметры. Остальные параметры можно посмотреть в <a title="" href="https://learn.microsoft.com/en-us/powershell/module/storage/optimize-volume" target="_blank" rel="noopener noreferrer nofollow">официальной документации</a>.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для всех команд можно добавить параметр <code>-Verbose</code>, который выводит подробную информацию о происходящем процессе.</p>

    </div>
  </div>
</div>

<h3 id="анализ-тома">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7-%d1%82%d0%be%d0%bc%d0%b0">Анализ тома</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-96f5c2eb147aeacdf83dd2c5610431e5"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-Analyze</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-96f5c2eb147aeacdf83dd2c5610431e5"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-Analyze</code> - анализ.</li>
</ul>
<h3 id="дефрагментация">
  <a class="link-body-emphasis" href="#%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f">Дефрагментация</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-16e5d73955c781a9d1d513acffc2e1fd"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-Defrag</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-16e5d73955c781a9d1d513acffc2e1fd"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-Defrag</code> - дефрагментация.</li>
</ul>
<h3 id="trim-операция-для-ssd">
  <a class="link-body-emphasis" href="#trim-%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%b4%d0%bb%d1%8f-ssd">TRIM-операция для SSD</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-a09a1c9d8edb05859560fc7e1c367194"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-ReTrim</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a09a1c9d8edb05859560fc7e1c367194"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-ReTrim</code> - на дисках SSD запускает TRIM-операцию.</li>
</ul>
<h2 id="cmd-defrag">
  <a class="link-body-emphasis" href="#cmd-defrag">CMD Defrag</a>
</h2><p>Утилита <code>defrag.exe</code> выполняет анализ и оптимизацию томов через командную строку. Утилита может принимать следующие параметры:</p>
<ul>
<li>Тома:
<ul>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/e</code> - выполнение операции на всех томах, кроме указанных.</li>
</ul>
</li>
<li>Операции:
<ul>
<li><code>/a</code> - анализ указанных томов.</li>
<li><code>/d</code> - выполнение традиционной дефрагментации (по умолчанию). На многоуровневом томе традиционная дефрагментация выполняется только на уровне ёмкости.</li>
<li><code>/l</code> - выполнение TRIM-операции для SSD.</li>
<li><code>/o</code> - выполнение правильной оптимизации для каждого типа носителя.</li>
<li><code>/u</code> - отображение хода операции.</li>
</ul>
</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для всех команд можно добавить параметр <code>/v</code>, который выводит подробную информацию о происходящем процессе.</p>

    </div>
  </div>
</div>

<h3 id="анализ-тома-1">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7-%d1%82%d0%be%d0%bc%d0%b0-1">Анализ тома</a>
</h3><p>Анализ тома, с отображением хода выполнения и выводом результатов в подробном формате:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-57d462cfdef32371597617090d7638da"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag c: /u /a</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-57d462cfdef32371597617090d7638da"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>c:</code> - буква тома (диск <code>C:</code>).</li>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/a</code> - анализ.</li>
</ul>
<h3 id="параллельная-дефрагментация">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bb%d0%bb%d0%b5%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f">Параллельная дефрагментация</a>
</h3><p>Параллельная дефрагментация томов <code>C:</code> и <code>D:</code> в фоновом режиме:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-a13f199e6b3e388c2d0e1b2ed3acfb1f"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag c: d: /m</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a13f199e6b3e388c2d0e1b2ed3acfb1f"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>c:</code> - буква тома (диск <code>C:</code>).</li>
<li><code>d:</code> - буква тома (диск <code>D:</code>).</li>
<li><code>/m</code> - выполнение операции с каждым томом параллельно в фоновом режиме.</li>
</ul>
<h3 id="дефрагментация-всех-томах">
  <a class="link-body-emphasis" href="#%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f-%d0%b2%d1%81%d0%b5%d1%85-%d1%82%d0%be%d0%bc%d0%b0%d1%85">Дефрагментация всех томах</a>
</h3><p>Выполнить дефрагментацию на всех локальных томах с нормальным приоритетом:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-d406928c28e066c07c40f57a123dd2a5"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag /u /c /h</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-d406928c28e066c07c40f57a123dd2a5"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/h</code> - выполнение операции с нормальным приоритетом (по умолчанию приоритет пониженный).</li>
</ul>
<h3 id="trim-операция-для-ssd-1">
  <a class="link-body-emphasis" href="#trim-%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%b4%d0%bb%d1%8f-ssd-1">TRIM-операция для SSD</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-c78ca74da3141cf505147c73d648b80a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag /u /c /l</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c78ca74da3141cf505147c73d648b80a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/l</code> или <code>/retrim</code> - на дисках SSD запускает TRIM-операцию.</li>
</ul>]]></content:encoded><turbo:source/><turbo:topic>Дефрагментация в ОС Windows</turbo:topic><turbo:content><![CDATA[<p>При работе с оборудованием, мне приходится сталкиваться с довольно старыми устройствами, их их работу нужно как-нибудь оптимизировать. Одним из вариантов оптимизации является дефрагментация HDD.</p>
<h2 id="powershell">
  <a class="link-body-emphasis" href="#powershell">PowerShell</a>
</h2><p>Командлет по дефрагментации для PowerShell называется <code>Optimize-Volume</code> и может принимать следующие параметры:</p>
<ul>
<li><code>-Analyze</code> - выполнение анализа указанного тома.</li>
<li><code>-Defrag</code> - выполнение дефрагментации указанного тома.</li>
<li><code>-DriveLetter</code> - буква тома.</li>
<li><code>-NormalPriority</code> - выполнение процесса с нормальным приоритетом (по умолчанию приоритет пониженный).</li>
<li><code>-ReTrim</code> - выполнение TRIM-операции для SSD.</li>
</ul>
<p>Это наиболее востребованные параметры. Остальные параметры можно посмотреть в <a title="" href="https://learn.microsoft.com/en-us/powershell/module/storage/optimize-volume" target="_blank" rel="noopener noreferrer nofollow">официальной документации</a>.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для всех команд можно добавить параметр <code>-Verbose</code>, который выводит подробную информацию о происходящем процессе.</p>

    </div>
  </div>
</div>

<h3 id="анализ-тома">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7-%d1%82%d0%be%d0%bc%d0%b0">Анализ тома</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-96f5c2eb147aeacdf83dd2c5610431e5"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-Analyze</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-96f5c2eb147aeacdf83dd2c5610431e5"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-Analyze</code> - анализ.</li>
</ul>
<h3 id="дефрагментация">
  <a class="link-body-emphasis" href="#%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f">Дефрагментация</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-16e5d73955c781a9d1d513acffc2e1fd"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-Defrag</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-16e5d73955c781a9d1d513acffc2e1fd"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-Defrag</code> - дефрагментация.</li>
</ul>
<h3 id="trim-операция-для-ssd">
  <a class="link-body-emphasis" href="#trim-%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%b4%d0%bb%d1%8f-ssd">TRIM-операция для SSD</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-a09a1c9d8edb05859560fc7e1c367194"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Optimize-Volume</span> <span class="n">-DriveLetter</span> <span class="n">C</span> <span class="n">-ReTrim</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a09a1c9d8edb05859560fc7e1c367194"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>-DriveLetter C</code> - буква тома (диск C:).</li>
<li><code>-ReTrim</code> - на дисках SSD запускает TRIM-операцию.</li>
</ul>
<h2 id="cmd-defrag">
  <a class="link-body-emphasis" href="#cmd-defrag">CMD Defrag</a>
</h2><p>Утилита <code>defrag.exe</code> выполняет анализ и оптимизацию томов через командную строку. Утилита может принимать следующие параметры:</p>
<ul>
<li>Тома:
<ul>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/e</code> - выполнение операции на всех томах, кроме указанных.</li>
</ul>
</li>
<li>Операции:
<ul>
<li><code>/a</code> - анализ указанных томов.</li>
<li><code>/d</code> - выполнение традиционной дефрагментации (по умолчанию). На многоуровневом томе традиционная дефрагментация выполняется только на уровне ёмкости.</li>
<li><code>/l</code> - выполнение TRIM-операции для SSD.</li>
<li><code>/o</code> - выполнение правильной оптимизации для каждого типа носителя.</li>
<li><code>/u</code> - отображение хода операции.</li>
</ul>
</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Для всех команд можно добавить параметр <code>/v</code>, который выводит подробную информацию о происходящем процессе.</p>

    </div>
  </div>
</div>

<h3 id="анализ-тома-1">
  <a class="link-body-emphasis" href="#%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7-%d1%82%d0%be%d0%bc%d0%b0-1">Анализ тома</a>
</h3><p>Анализ тома, с отображением хода выполнения и выводом результатов в подробном формате:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-57d462cfdef32371597617090d7638da"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag c: /u /a</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-57d462cfdef32371597617090d7638da"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>c:</code> - буква тома (диск <code>C:</code>).</li>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/a</code> - анализ.</li>
</ul>
<h3 id="параллельная-дефрагментация">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b0%d1%80%d0%b0%d0%bb%d0%bb%d0%b5%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f">Параллельная дефрагментация</a>
</h3><p>Параллельная дефрагментация томов <code>C:</code> и <code>D:</code> в фоновом режиме:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-a13f199e6b3e388c2d0e1b2ed3acfb1f"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag c: d: /m</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a13f199e6b3e388c2d0e1b2ed3acfb1f"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>c:</code> - буква тома (диск <code>C:</code>).</li>
<li><code>d:</code> - буква тома (диск <code>D:</code>).</li>
<li><code>/m</code> - выполнение операции с каждым томом параллельно в фоновом режиме.</li>
</ul>
<h3 id="дефрагментация-всех-томах">
  <a class="link-body-emphasis" href="#%d0%b4%d0%b5%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f-%d0%b2%d1%81%d0%b5%d1%85-%d1%82%d0%be%d0%bc%d0%b0%d1%85">Дефрагментация всех томах</a>
</h3><p>Выполнить дефрагментацию на всех локальных томах с нормальным приоритетом:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-d406928c28e066c07c40f57a123dd2a5"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag /u /c /h</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-d406928c28e066c07c40f57a123dd2a5"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/h</code> - выполнение операции с нормальным приоритетом (по умолчанию приоритет пониженный).</li>
</ul>
<h3 id="trim-операция-для-ssd-1">
  <a class="link-body-emphasis" href="#trim-%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%b4%d0%bb%d1%8f-ssd-1">TRIM-операция для SSD</a>
</h3>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-c78ca74da3141cf505147c73d648b80a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">defrag /u /c /l</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c78ca74da3141cf505147c73d648b80a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/u</code> - отображение хода выполнения операции.</li>
<li><code>/c</code> - выполнение операции на всех томах.</li>
<li><code>/l</code> или <code>/retrim</code> - на дисках SSD запускает TRIM-операцию.</li>
</ul>]]></turbo:content><pubDate>Fri, 20 Oct 2023 00:46:16 +0000</pubDate><category>MS Windows</category><category>Терминал</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Установка сертификата НУЦ Минцифры</title><link>https://lib.onl/ru/posts/2023/10/75075788-9308-56b7-b531-2008cb35f7d0/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/75075788-9308-56b7-b531-2008cb35f7d0/</guid><description>Рассказываю о нескольких способах установки сертификатов от НУЦ Минцифры. Установка производится в ОС MS Windows и Linux.</description><media:content medium="image" url="https://images.unsplash.com/photo-1570610159825-ec5d3823660c" width="1600" height="900"/><content:encoded><![CDATA[<p>Рассказываю о нескольких способах установки сертификатов от НУЦ Минцифры. Установка производится в ОС MS Windows и Linux.</p>
<h2 id="ms-windows">
  <a class="link-body-emphasis" href="#ms-windows">MS Windows</a>
</h2><h3 id="установка-корневого-сертификата">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d0%bd%d0%b5%d0%b2%d0%be%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0">Установка корневого сертификата</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russian_trusted_root_ca.cer" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> корневой сертификат.</li>
<li>Открыть скаченный файл <code>russian_trusted_root_ca.cer</code> и нажать кнопку <span class="shortcode shortcode-key"><kbd>Установить сертификат...</kbd></span>.</li>
<li>В <strong>Мастере импорта сертификатов</strong> выбрать <em>Текущий пользователь</em>.
<ul>
<li>Выбрать <em>Поместить все сертификаты в следующее хранилище</em>.</li>
<li>Нажать <span class="shortcode shortcode-key"><kbd>Обзор</kbd></span> и выбрать <em>Доверенные корневые центры сертификации</em>.</li>
<li>В окне <strong>Завершение мастера импорта сертификатов</strong> нажать <span class="shortcode shortcode-key"><kbd>Готово</kbd></span>.</li>
</ul>
</li>
</ul>
<h3 id="установка-выпускающего-сертификата">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%b2%d1%8b%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d1%8e%d1%89%d0%b5%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0">Установка выпускающего сертификата</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russian_trusted_sub_ca.cer" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> выпускающий сертификат.</li>
<li>Открыть скаченный файл <code>russian_trusted_sub_ca.cer</code> и нажать кнопку <span class="shortcode shortcode-key"><kbd>Установить сертификат...</kbd></span>.</li>
<li>В <strong>Мастере импорта сертификатов</strong> выбрать <em>Текущий пользователь</em>.
<ul>
<li>Выбрать <em>Автоматически выбрать хранилище на основе типа сертификата</em>.</li>
<li>В окне <strong>Завершение мастера импорта сертификатов</strong> нажать <span class="shortcode shortcode-key"><kbd>Готово</kbd></span>.</li>
</ul>
</li>
</ul>
<h3 id="powershell">
  <a class="link-body-emphasis" href="#powershell">PowerShell</a>
</h3><p>При помощи PowerShell можно установить сертификат одной строчкой, состоящей из нескольких команд:</p>
<ul>
<li><code>Invoke-WebRequest</code> - скачивает файл с внешнего веб-ресурса.</li>
<li><code>Import-Certificate</code> - импортирует сертификат в указанное хранилище.</li>
<li><code>${DIR}</code> - переменная, определяющая директорию <code>Downloads</code> (<code>Загрузки</code>) для текущего пользователя.</li>
</ul>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-be3f5c70ef3c9d50a9a740b7399cb4d7"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">${</span><span class="n">CERT_ROOT</span><span class="p">}</span> <span class="p">=</span> <span class="s1">&#39;russian_trusted_root_ca.cer&#39;</span><span class="p">;</span> <span class="p">${</span><span class="n">CERT_SUB</span><span class="p">}</span> <span class="p">=</span> <span class="s1">&#39;russian_trusted_sub_ca.cer&#39;</span><span class="p">;</span> <span class="p">${</span><span class="n">DIR</span><span class="p">}</span> <span class="p">=</span> <span class="p">(</span><span class="nb">New-Object</span> <span class="n">-ComObject</span> <span class="n">Shell</span><span class="p">.</span><span class="n">Application</span><span class="p">).</span><span class="py">NameSpace</span><span class="p">(</span><span class="s1">&#39;shell:Downloads&#39;</span><span class="p">).</span><span class="py">Self</span><span class="p">.</span><span class="n">Path</span><span class="p">;</span> <span class="nb">Invoke-WebRequest</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span> <span class="n">-OutFile</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="nb">Import-Certificate</span> <span class="n">-FilePath</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span> <span class="n">-CertStoreLocation</span> <span class="s1">&#39;Cert:\CurrentUser\Root&#39;</span><span class="p">;</span> <span class="nb">Invoke-WebRequest</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span> <span class="n">-OutFile</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="nb">Import-Certificate</span> <span class="n">-FilePath</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span> <span class="n">-CertStoreLocation</span> <span class="s1">&#39;Cert:\CurrentUser\CA&#39;</span><span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-be3f5c70ef3c9d50a9a740b7399cb4d7"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h2 id="linux">
  <a class="link-body-emphasis" href="#linux">Linux</a>
</h2><p>Для Linux можно воспользоваться пакетом сертификатов в формате <code>.PEM</code> от <strong>MacOS</strong>. Положительным моментом подобного пакета является то, что PEM содержит в себе сразу два сертификата: корневой и выпускающий.</p>
<h3 id="установка-корневого-и-выпускающего-сертификатов">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d0%bd%d0%b5%d0%b2%d0%be%d0%b3%d0%be-%d0%b8-%d0%b2%d1%8b%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d1%8e%d1%89%d0%b5%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2">Установка корневого и выпускающего сертификатов</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russiantrustedca.pem" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> файл с корневым и выпускающим сертификатами.</li>
<li>Добавить скаченный файл <code>russiantrustedca.pem</code> в хранилище доверенных сертификатов в зависимости от дистрибутива Linux.
<ul>
<li>DEB-based: <code>/usr/local/share/ca-certificates/</code>.</li>
<li>RHEL-based: <code>/etc/pki/ca-trust/source/anchors/</code>.</li>
<li>Arch Linux: <code>/etc/ca-certificates/trust-source/anchors/</code>.</li>
</ul>
</li>
<li>Обновить хранилище сертификатов следующими командами.
<ul>
<li>DEB-based: <code>update-ca-certificates --fresh</code>.</li>
<li>RHEL-based: <code>update-ca-trust force-enable</code> и <code>update-ca-trust extract</code>.</li>
</ul>
</li>
</ul>
<h3 id="bash">
  <a class="link-body-emphasis" href="#bash">Bash</a>
</h3><p>Установить сертификат можно одной командой. Команды вводится от пользователя <code>root</code>. Как выше приводилось, для DEB-based и RHEL-based дистрибутивов, пути хранилища сертификатов различаются. Поэтому, я привожу две команды под каждые версии дистрибутивов.</p>
<h4 id="deb-based-дистрибутивы">
  <a class="link-body-emphasis" href="#deb-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d1%8b">DEB-based дистрибутивы</a>
</h4>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-53470f70cf43a221c87977d09a287d68"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CERT</span><span class="o">=</span><span class="s1">&#39;russiantrustedca.pem&#39;</span><span class="p">;</span> curl -o <span class="s2">&#34;/usr/local/share/ca-certificates/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> update-ca-certificates --fresh<span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-53470f70cf43a221c87977d09a287d68"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h4 id="rhel-based-дистрибутивы">
  <a class="link-body-emphasis" href="#rhel-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d1%8b">RHEL-based дистрибутивы</a>
</h4>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-c06193f379cb39cef166f622da2c3e32"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CERT</span><span class="o">=</span><span class="s1">&#39;russiantrustedca.pem&#39;</span><span class="p">;</span> curl -o <span class="s2">&#34;/etc/pki/ca-trust/source/anchors/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> update-ca-trust force-enable <span class="o">&amp;&amp;</span> update-ca-trust extract<span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c06193f379cb39cef166f622da2c3e32"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>]]></content:encoded><turbo:source/><turbo:topic>Установка сертификата НУЦ Минцифры</turbo:topic><turbo:content><![CDATA[<p>Рассказываю о нескольких способах установки сертификатов от НУЦ Минцифры. Установка производится в ОС MS Windows и Linux.</p>
<h2 id="ms-windows">
  <a class="link-body-emphasis" href="#ms-windows">MS Windows</a>
</h2><h3 id="установка-корневого-сертификата">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d0%bd%d0%b5%d0%b2%d0%be%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0">Установка корневого сертификата</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russian_trusted_root_ca.cer" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> корневой сертификат.</li>
<li>Открыть скаченный файл <code>russian_trusted_root_ca.cer</code> и нажать кнопку <span class="shortcode shortcode-key"><kbd>Установить сертификат...</kbd></span>.</li>
<li>В <strong>Мастере импорта сертификатов</strong> выбрать <em>Текущий пользователь</em>.
<ul>
<li>Выбрать <em>Поместить все сертификаты в следующее хранилище</em>.</li>
<li>Нажать <span class="shortcode shortcode-key"><kbd>Обзор</kbd></span> и выбрать <em>Доверенные корневые центры сертификации</em>.</li>
<li>В окне <strong>Завершение мастера импорта сертификатов</strong> нажать <span class="shortcode shortcode-key"><kbd>Готово</kbd></span>.</li>
</ul>
</li>
</ul>
<h3 id="установка-выпускающего-сертификата">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%b2%d1%8b%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d1%8e%d1%89%d0%b5%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0">Установка выпускающего сертификата</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russian_trusted_sub_ca.cer" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> выпускающий сертификат.</li>
<li>Открыть скаченный файл <code>russian_trusted_sub_ca.cer</code> и нажать кнопку <span class="shortcode shortcode-key"><kbd>Установить сертификат...</kbd></span>.</li>
<li>В <strong>Мастере импорта сертификатов</strong> выбрать <em>Текущий пользователь</em>.
<ul>
<li>Выбрать <em>Автоматически выбрать хранилище на основе типа сертификата</em>.</li>
<li>В окне <strong>Завершение мастера импорта сертификатов</strong> нажать <span class="shortcode shortcode-key"><kbd>Готово</kbd></span>.</li>
</ul>
</li>
</ul>
<h3 id="powershell">
  <a class="link-body-emphasis" href="#powershell">PowerShell</a>
</h3><p>При помощи PowerShell можно установить сертификат одной строчкой, состоящей из нескольких команд:</p>
<ul>
<li><code>Invoke-WebRequest</code> - скачивает файл с внешнего веб-ресурса.</li>
<li><code>Import-Certificate</code> - импортирует сертификат в указанное хранилище.</li>
<li><code>${DIR}</code> - переменная, определяющая директорию <code>Downloads</code> (<code>Загрузки</code>) для текущего пользователя.</li>
</ul>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-be3f5c70ef3c9d50a9a740b7399cb4d7"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">${</span><span class="n">CERT_ROOT</span><span class="p">}</span> <span class="p">=</span> <span class="s1">&#39;russian_trusted_root_ca.cer&#39;</span><span class="p">;</span> <span class="p">${</span><span class="n">CERT_SUB</span><span class="p">}</span> <span class="p">=</span> <span class="s1">&#39;russian_trusted_sub_ca.cer&#39;</span><span class="p">;</span> <span class="p">${</span><span class="n">DIR</span><span class="p">}</span> <span class="p">=</span> <span class="p">(</span><span class="nb">New-Object</span> <span class="n">-ComObject</span> <span class="n">Shell</span><span class="p">.</span><span class="n">Application</span><span class="p">).</span><span class="py">NameSpace</span><span class="p">(</span><span class="s1">&#39;shell:Downloads&#39;</span><span class="p">).</span><span class="py">Self</span><span class="p">.</span><span class="n">Path</span><span class="p">;</span> <span class="nb">Invoke-WebRequest</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span> <span class="n">-OutFile</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="nb">Import-Certificate</span> <span class="n">-FilePath</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_ROOT}</span><span class="s2">&#34;</span> <span class="n">-CertStoreLocation</span> <span class="s1">&#39;Cert:\CurrentUser\Root&#39;</span><span class="p">;</span> <span class="nb">Invoke-WebRequest</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span> <span class="n">-OutFile</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="nb">Import-Certificate</span> <span class="n">-FilePath</span> <span class="s2">&#34;</span><span class="nv">${DIR}</span><span class="s2">\</span><span class="nv">${CERT_SUB}</span><span class="s2">&#34;</span> <span class="n">-CertStoreLocation</span> <span class="s1">&#39;Cert:\CurrentUser\CA&#39;</span><span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-be3f5c70ef3c9d50a9a740b7399cb4d7"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h2 id="linux">
  <a class="link-body-emphasis" href="#linux">Linux</a>
</h2><p>Для Linux можно воспользоваться пакетом сертификатов в формате <code>.PEM</code> от <strong>MacOS</strong>. Положительным моментом подобного пакета является то, что PEM содержит в себе сразу два сертификата: корневой и выпускающий.</p>
<h3 id="установка-корневого-и-выпускающего-сертификатов">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d0%bd%d0%b5%d0%b2%d0%be%d0%b3%d0%be-%d0%b8-%d0%b2%d1%8b%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d1%8e%d1%89%d0%b5%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2">Установка корневого и выпускающего сертификатов</a>
</h3><ul>
<li><a title="" href="https://gu-st.ru/content/Other/doc/russiantrustedca.pem" target="_blank" rel="noopener noreferrer nofollow">Скачать</a> файл с корневым и выпускающим сертификатами.</li>
<li>Добавить скаченный файл <code>russiantrustedca.pem</code> в хранилище доверенных сертификатов в зависимости от дистрибутива Linux.
<ul>
<li>DEB-based: <code>/usr/local/share/ca-certificates/</code>.</li>
<li>RHEL-based: <code>/etc/pki/ca-trust/source/anchors/</code>.</li>
<li>Arch Linux: <code>/etc/ca-certificates/trust-source/anchors/</code>.</li>
</ul>
</li>
<li>Обновить хранилище сертификатов следующими командами.
<ul>
<li>DEB-based: <code>update-ca-certificates --fresh</code>.</li>
<li>RHEL-based: <code>update-ca-trust force-enable</code> и <code>update-ca-trust extract</code>.</li>
</ul>
</li>
</ul>
<h3 id="bash">
  <a class="link-body-emphasis" href="#bash">Bash</a>
</h3><p>Установить сертификат можно одной командой. Команды вводится от пользователя <code>root</code>. Как выше приводилось, для DEB-based и RHEL-based дистрибутивов, пути хранилища сертификатов различаются. Поэтому, я привожу две команды под каждые версии дистрибутивов.</p>
<h4 id="deb-based-дистрибутивы">
  <a class="link-body-emphasis" href="#deb-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d1%8b">DEB-based дистрибутивы</a>
</h4>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-53470f70cf43a221c87977d09a287d68"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CERT</span><span class="o">=</span><span class="s1">&#39;russiantrustedca.pem&#39;</span><span class="p">;</span> curl -o <span class="s2">&#34;/usr/local/share/ca-certificates/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> update-ca-certificates --fresh<span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-53470f70cf43a221c87977d09a287d68"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<h4 id="rhel-based-дистрибутивы">
  <a class="link-body-emphasis" href="#rhel-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d1%8b">RHEL-based дистрибутивы</a>
</h4>







  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-c06193f379cb39cef166f622da2c3e32"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CERT</span><span class="o">=</span><span class="s1">&#39;russiantrustedca.pem&#39;</span><span class="p">;</span> curl -o <span class="s2">&#34;/etc/pki/ca-trust/source/anchors/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;https://gu-st.ru/content/Other/doc/</span><span class="si">${</span><span class="nv">CERT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> update-ca-trust force-enable <span class="o">&amp;&amp;</span> update-ca-trust extract<span class="p">;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c06193f379cb39cef166f622da2c3e32"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>]]></turbo:content><pubDate>Fri, 06 Oct 2023 11:42:15 +0000</pubDate><category>Linux</category><category>MS Windows</category><category>Безопасность</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Получение и установка MS Office 2021 LTSC</title><link>https://lib.onl/ru/posts/2023/09/dd5a3e1a-596b-50d5-b070-b2a065f99f32/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/09/dd5a3e1a-596b-50d5-b070-b2a065f99f32/</guid><description>MS Office является самым популярным набором приложений для офисной работы. На момент написания этой статьи, актуальной версией MS Office является 2021. Её можно купить в магазине. Но здесь я расскажу как получить актуальную версию MS Office 2021 LTSC с серверов Microsoft.</description><media:content medium="image" url="https://images.unsplash.com/photo-1649433391420-542fcd3835ea" width="1600" height="900"/><content:encoded><![CDATA[<p>MS Office является самым популярным набором приложений для офисной работы. На момент написания этой статьи, актуальной версией MS Office является 2021. Её можно купить в магазине. Но здесь я расскажу как получить актуальную версию MS Office 2021 LTSC с серверов Microsoft.</p>
<p>MS Office 2021 LTSC просто так не купить, это программное обеспечение распространяется для организаций по соглашению о корпоративном лицензировании. MS Office 2021 LTSC поддерживает устройства только с операционными системами <strong>MS Windows 10</strong> или <strong>MS Windows 11</strong>.</p>
<h2 id="получение-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-ms-office-2021-ltsc">Получение MS Office 2021 LTSC</a>
</h2><p>Для получения установочного дистрибутива необходимо выполнить подготовительные шаги:</p>
<ol>
<li>Скачать и запустить <a title="" href="https://www.microsoft.com/download/details.aspx?id=49117" target="_blank" rel="noopener noreferrer nofollow">Office Deployment Tool</a>.</li>
<li>Во время установки, выбрать директорию для распаковки <strong>Office Deployment Tool</strong>. В эту директорию будет в дальнейшем загружен установочный дистрибутив MS Office 2021 LTSC.</li>
<li>После завершения процесса установки, открыть консоль и перейти в директорию (<code>cd &lt;path&gt;</code>), куда был установлен Office Deployment Tool.</li>
<li>В корне директории Office Deployment Tool создать файл <code>office.2021.xml</code> следующего содержания:</li>
</ol>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>office.2021.xml</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-9aa514d1ccd0498ab48526dc8822ae56"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="office.2021.xml" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="office.2021.xml" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-9aa514d1ccd0498ab48526dc8822ae56"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Configuration</span> <span class="na">ID=</span><span class="s">&#34;42865718-c416-4c72-990b-20b6972cb9af&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Add</span> <span class="na">OfficeClientEdition=</span><span class="s">&#34;64&#34;</span> <span class="na">Channel=</span><span class="s">&#34;PerpetualVL2021&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProPlus2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FXYTK-NJJ8C-GB6DW-3DYQT-6F7TH&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;VisioPro2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;KNH8D-FGHT4-T8RK3-CTDYJ-K2HT4&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProjectPro2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FTNWT-C6WBT-8HMGF-K9PRX-QV9H8&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;LanguagePack&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProofingTools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Add&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SharedComputerLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;FORCEAPPSHUTDOWN&#34;</span> <span class="na">Value=</span><span class="s">&#34;FALSE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;DeviceBasedLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SCLCacheOverride&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;AUTOACTIVATE&#34;</span> <span class="na">Value=</span><span class="s">&#34;1&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Updates</span> <span class="na">Enabled=</span><span class="s">&#34;TRUE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;RemoveMSI</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Configuration&gt;</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Далее, в консоли выполните команду <code>setup.exe /download office.2021.xml</code>. Команда запускает формирование и скачивание установочного дистрибутива MS Office 2021 LTCS с серверов Microsoft. Команда может не отображать процесс своей работы. После завершения команды, консоль вернёт управление пользователю, тем самым можно контролировать завершение получения установочного дистрибутива.</p>
<h2 id="установка-полной-версии-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%bf%d0%be%d0%bb%d0%bd%d0%be%d0%b9-%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d0%b8-ms-office-2021-ltsc">Установка полной версии MS Office 2021 LTSC</a>
</h2><p>После получения установочного дистрибутива MS Office 2021 LTCS, в той же консоли необходимо выполнить команду <code>setup.exe /configure office.2021.xml</code>. Эта команда запускает процесс установки <strong>полной версии</strong> MS Office 2021 LTCS на компьютер пользователя со всеми дополнительными модулями.</p>
<h2 id="установка-минимальной-версии-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%bc%d0%b8%d0%bd%d0%b8%d0%bc%d0%b0%d0%bb%d1%8c%d0%bd%d0%be%d0%b9-%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d0%b8-ms-office-2021-ltsc">Установка минимальной версии MS Office 2021 LTSC</a>
</h2><p>Для администраторов, которые хотят установить на компьютер пользователя только самые необходимые компоненты (Access, Excel, Outlook, PowerPoint и World), предлагаю следующий конфигурационный файл:</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>office.2021.minimal.xml</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-cdd890edb447637ba6047a38b30644cf"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="office.2021.minimal.xml" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="office.2021.minimal.xml" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-cdd890edb447637ba6047a38b30644cf"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Configuration</span> <span class="na">ID=</span><span class="s">&#34;42865718-c416-4c72-990b-20b6972cb9af&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Add</span> <span class="na">OfficeClientEdition=</span><span class="s">&#34;64&#34;</span> <span class="na">Channel=</span><span class="s">&#34;PerpetualVL2021&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProPlus2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FXYTK-NJJ8C-GB6DW-3DYQT-6F7TH&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Lync&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;OneDrive&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;OneNote&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Publisher&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Teams&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;LanguagePack&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProofingTools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Add&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SharedComputerLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;FORCEAPPSHUTDOWN&#34;</span> <span class="na">Value=</span><span class="s">&#34;FALSE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;DeviceBasedLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SCLCacheOverride&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;AUTOACTIVATE&#34;</span> <span class="na">Value=</span><span class="s">&#34;1&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Updates</span> <span class="na">Enabled=</span><span class="s">&#34;TRUE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;RemoveMSI</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Configuration&gt;</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Сохраните его под названием <code>office.2021.minimal.xml</code> и запустите процесс установки при помощи команды <code>setup.exe /configure office.2021.minimal.xml</code>.</p>
<h2 id="создание-собственных-конфигураций">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d1%8b%d1%85-%d0%ba%d0%be%d0%bd%d1%84%d0%b8%d0%b3%d1%83%d1%80%d0%b0%d1%86%d0%b8%d0%b9">Создание собственных конфигураций</a>
</h2><p>Приведённые выше XML-файлы это файлы конфигураций. Их можно создавать самому при помощи веб-инструмента <a title="" href="https://config.office.com/deploymentsettings" target="_blank" rel="noopener noreferrer nofollow">Office Deployment Center</a>. На странице создания конфигураций укажите необходимые параметры и настройки, и нажмите кнопку <span class="shortcode shortcode-key"><kbd>Импорт</kbd></span>.</p>
<p>Полученный XML-файл можно указывать в командах <code>setup.exe /download &lt;XML_FILE&gt;</code> и <code>setup.exe /configure &lt;XML_FILE&gt;</code> для конфигурирования установочного дистрибутива.</p>
<h2 id="активация-при-помощи-kms-сервера">
  <a class="link-body-emphasis" href="#%d0%b0%d0%ba%d1%82%d0%b8%d0%b2%d0%b0%d1%86%d0%b8%d1%8f-%d0%bf%d1%80%d0%b8-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d0%b8-kms-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0">Активация при помощи KMS-сервера</a>
</h2><p>Если в сети вашей организации присутствует KMS-сервер, установленный MS Office 2021 можно активировать при помощи этого сервера.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Подобным способом активируются следующие версии MS Office:</p>
<ul>
<li>Microsoft Office 2016 Volume License Pack.</li>
<li>Microsoft Office 2019 Volume License Pack.</li>
<li>Microsoft Office LTSC 2021 Volume License Pack.</li>
</ul>

    </div>
  </div>
</div>

<p>Для активации MS Office при помощи KMS-сервера, необходимо открыть консоль и перейти в директорию с файлом <code>ospp.vbs</code>. Обычно, этот файл находится в директории <code>\Program Files\Microsoft Office\Office16</code>. После того, как консоль будет находится в необходимой директории с файлом <code>ospp.vbs</code>, можно выполнять следующие команды в зависимости от задачи.</p>
<ol>
<li>Указать адрес KMS-сервера для клиента MS Office:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0d0ce0f53c1e2d84b4ed65973eaafcc2"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /sethst:kms.example.com</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0d0ce0f53c1e2d84b4ed65973eaafcc2"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="2">
<li>Указать нестандартный порт (<code>1689</code>) KMS-сервера:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f9a848bfe0902259d9c3ff7f553938ca"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /setprt:1689</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f9a848bfe0902259d9c3ff7f553938ca"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="3">
<li>Выполнить активацию MS Office на KMS-сервере:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-01ce6a8b7efca157453832140ed4770e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /act</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-01ce6a8b7efca157453832140ed4770e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="4">
<li>Узнать текущий статус активации MS Office:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-ba16de8abb69de7be48375d0d17af318"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /dstatusall</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-ba16de8abb69de7be48375d0d17af318"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>В интернете можно найти открытые KMS-серверы для нелегальной активации MS Office. Но подобные действия имеют противоправный характер. <span class="shortcode shortcode-emoji">😜</span></p>]]></content:encoded><turbo:source/><turbo:topic>Получение и установка MS Office 2021 LTSC</turbo:topic><turbo:content><![CDATA[<p>MS Office является самым популярным набором приложений для офисной работы. На момент написания этой статьи, актуальной версией MS Office является 2021. Её можно купить в магазине. Но здесь я расскажу как получить актуальную версию MS Office 2021 LTSC с серверов Microsoft.</p>
<p>MS Office 2021 LTSC просто так не купить, это программное обеспечение распространяется для организаций по соглашению о корпоративном лицензировании. MS Office 2021 LTSC поддерживает устройства только с операционными системами <strong>MS Windows 10</strong> или <strong>MS Windows 11</strong>.</p>
<h2 id="получение-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-ms-office-2021-ltsc">Получение MS Office 2021 LTSC</a>
</h2><p>Для получения установочного дистрибутива необходимо выполнить подготовительные шаги:</p>
<ol>
<li>Скачать и запустить <a title="" href="https://www.microsoft.com/download/details.aspx?id=49117" target="_blank" rel="noopener noreferrer nofollow">Office Deployment Tool</a>.</li>
<li>Во время установки, выбрать директорию для распаковки <strong>Office Deployment Tool</strong>. В эту директорию будет в дальнейшем загружен установочный дистрибутив MS Office 2021 LTSC.</li>
<li>После завершения процесса установки, открыть консоль и перейти в директорию (<code>cd &lt;path&gt;</code>), куда был установлен Office Deployment Tool.</li>
<li>В корне директории Office Deployment Tool создать файл <code>office.2021.xml</code> следующего содержания:</li>
</ol>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>office.2021.xml</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-9aa514d1ccd0498ab48526dc8822ae56"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="office.2021.xml" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="office.2021.xml" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-9aa514d1ccd0498ab48526dc8822ae56"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Configuration</span> <span class="na">ID=</span><span class="s">&#34;42865718-c416-4c72-990b-20b6972cb9af&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Add</span> <span class="na">OfficeClientEdition=</span><span class="s">&#34;64&#34;</span> <span class="na">Channel=</span><span class="s">&#34;PerpetualVL2021&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProPlus2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FXYTK-NJJ8C-GB6DW-3DYQT-6F7TH&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;VisioPro2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;KNH8D-FGHT4-T8RK3-CTDYJ-K2HT4&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProjectPro2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FTNWT-C6WBT-8HMGF-K9PRX-QV9H8&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;LanguagePack&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProofingTools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Add&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SharedComputerLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;FORCEAPPSHUTDOWN&#34;</span> <span class="na">Value=</span><span class="s">&#34;FALSE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;DeviceBasedLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SCLCacheOverride&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;AUTOACTIVATE&#34;</span> <span class="na">Value=</span><span class="s">&#34;1&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Updates</span> <span class="na">Enabled=</span><span class="s">&#34;TRUE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;RemoveMSI</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Configuration&gt;</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Далее, в консоли выполните команду <code>setup.exe /download office.2021.xml</code>. Команда запускает формирование и скачивание установочного дистрибутива MS Office 2021 LTCS с серверов Microsoft. Команда может не отображать процесс своей работы. После завершения команды, консоль вернёт управление пользователю, тем самым можно контролировать завершение получения установочного дистрибутива.</p>
<h2 id="установка-полной-версии-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%bf%d0%be%d0%bb%d0%bd%d0%be%d0%b9-%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d0%b8-ms-office-2021-ltsc">Установка полной версии MS Office 2021 LTSC</a>
</h2><p>После получения установочного дистрибутива MS Office 2021 LTCS, в той же консоли необходимо выполнить команду <code>setup.exe /configure office.2021.xml</code>. Эта команда запускает процесс установки <strong>полной версии</strong> MS Office 2021 LTCS на компьютер пользователя со всеми дополнительными модулями.</p>
<h2 id="установка-минимальной-версии-ms-office-2021-ltsc">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%bc%d0%b8%d0%bd%d0%b8%d0%bc%d0%b0%d0%bb%d1%8c%d0%bd%d0%be%d0%b9-%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d0%b8-ms-office-2021-ltsc">Установка минимальной версии MS Office 2021 LTSC</a>
</h2><p>Для администраторов, которые хотят установить на компьютер пользователя только самые необходимые компоненты (Access, Excel, Outlook, PowerPoint и World), предлагаю следующий конфигурационный файл:</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>office.2021.minimal.xml</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-cdd890edb447637ba6047a38b30644cf"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="office.2021.minimal.xml" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="office.2021.minimal.xml" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-cdd890edb447637ba6047a38b30644cf"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Configuration</span> <span class="na">ID=</span><span class="s">&#34;42865718-c416-4c72-990b-20b6972cb9af&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Add</span> <span class="na">OfficeClientEdition=</span><span class="s">&#34;64&#34;</span> <span class="na">Channel=</span><span class="s">&#34;PerpetualVL2021&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProPlus2021Volume&#34;</span> <span class="na">PIDKEY=</span><span class="s">&#34;FXYTK-NJJ8C-GB6DW-3DYQT-6F7TH&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Lync&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;OneDrive&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;OneNote&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Publisher&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExcludeApp</span> <span class="na">ID=</span><span class="s">&#34;Teams&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;LanguagePack&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Product</span> <span class="na">ID=</span><span class="s">&#34;ProofingTools&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;en-us&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Language</span> <span class="na">ID=</span><span class="s">&#34;ru-ru&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Add&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SharedComputerLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;FORCEAPPSHUTDOWN&#34;</span> <span class="na">Value=</span><span class="s">&#34;FALSE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;DeviceBasedLicensing&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;SCLCacheOverride&#34;</span> <span class="na">Value=</span><span class="s">&#34;0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Property</span> <span class="na">Name=</span><span class="s">&#34;AUTOACTIVATE&#34;</span> <span class="na">Value=</span><span class="s">&#34;1&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Updates</span> <span class="na">Enabled=</span><span class="s">&#34;TRUE&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;RemoveMSI</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Configuration&gt;</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Сохраните его под названием <code>office.2021.minimal.xml</code> и запустите процесс установки при помощи команды <code>setup.exe /configure office.2021.minimal.xml</code>.</p>
<h2 id="создание-собственных-конфигураций">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d1%8b%d1%85-%d0%ba%d0%be%d0%bd%d1%84%d0%b8%d0%b3%d1%83%d1%80%d0%b0%d1%86%d0%b8%d0%b9">Создание собственных конфигураций</a>
</h2><p>Приведённые выше XML-файлы это файлы конфигураций. Их можно создавать самому при помощи веб-инструмента <a title="" href="https://config.office.com/deploymentsettings" target="_blank" rel="noopener noreferrer nofollow">Office Deployment Center</a>. На странице создания конфигураций укажите необходимые параметры и настройки, и нажмите кнопку <span class="shortcode shortcode-key"><kbd>Импорт</kbd></span>.</p>
<p>Полученный XML-файл можно указывать в командах <code>setup.exe /download &lt;XML_FILE&gt;</code> и <code>setup.exe /configure &lt;XML_FILE&gt;</code> для конфигурирования установочного дистрибутива.</p>
<h2 id="активация-при-помощи-kms-сервера">
  <a class="link-body-emphasis" href="#%d0%b0%d0%ba%d1%82%d0%b8%d0%b2%d0%b0%d1%86%d0%b8%d1%8f-%d0%bf%d1%80%d0%b8-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d0%b8-kms-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0">Активация при помощи KMS-сервера</a>
</h2><p>Если в сети вашей организации присутствует KMS-сервер, установленный MS Office 2021 можно активировать при помощи этого сервера.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Подобным способом активируются следующие версии MS Office:</p>
<ul>
<li>Microsoft Office 2016 Volume License Pack.</li>
<li>Microsoft Office 2019 Volume License Pack.</li>
<li>Microsoft Office LTSC 2021 Volume License Pack.</li>
</ul>

    </div>
  </div>
</div>

<p>Для активации MS Office при помощи KMS-сервера, необходимо открыть консоль и перейти в директорию с файлом <code>ospp.vbs</code>. Обычно, этот файл находится в директории <code>\Program Files\Microsoft Office\Office16</code>. После того, как консоль будет находится в необходимой директории с файлом <code>ospp.vbs</code>, можно выполнять следующие команды в зависимости от задачи.</p>
<ol>
<li>Указать адрес KMS-сервера для клиента MS Office:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0d0ce0f53c1e2d84b4ed65973eaafcc2"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /sethst:kms.example.com</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0d0ce0f53c1e2d84b4ed65973eaafcc2"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="2">
<li>Указать нестандартный порт (<code>1689</code>) KMS-сервера:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f9a848bfe0902259d9c3ff7f553938ca"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /setprt:1689</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f9a848bfe0902259d9c3ff7f553938ca"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="3">
<li>Выполнить активацию MS Office на KMS-сервере:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-01ce6a8b7efca157453832140ed4770e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /act</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-01ce6a8b7efca157453832140ed4770e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<ol start="4">
<li>Узнать текущий статус активации MS Office:</li>
</ol>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-ba16de8abb69de7be48375d0d17af318"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cscript ospp.vbs /dstatusall</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-ba16de8abb69de7be48375d0d17af318"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>В интернете можно найти открытые KMS-серверы для нелегальной активации MS Office. Но подобные действия имеют противоправный характер. <span class="shortcode shortcode-emoji">😜</span></p>]]></turbo:content><pubDate>Tue, 26 Sep 2023 17:17:18 +0000</pubDate><category>MS Windows</category><category>Скрипты</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Интеграция обновлений в дистрибутив ОС MS Windows</title><link>https://lib.onl/ru/posts/2022/05/862226e6-cbb1-58f8-bc8e-0cfef747f475/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2022/05/862226e6-cbb1-58f8-bc8e-0cfef747f475/</guid><description>Microsoft каждый месяц выпускает новые версии дистрибутивов с уже интегрированными обновлениями. Но есть редакции ОС, например LTSC, для которых Microsoft не выполняет подобные действия. Приходится делать самому&amp;hellip;</description><media:content medium="image" url="https://images.unsplash.com/photo-1620843002805-05a08cb72f57" width="1600" height="900"/><content:encoded><![CDATA[<p>Microsoft каждый месяц выпускает новые версии дистрибутивов с уже интегрированными обновлениями. Но есть редакции ОС, например LTSC, для которых Microsoft не выполняет подобные действия. Приходится делать самому&hellip;</p>
<h2 id="подготовка">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0">Подготовка</a>
</h2><p>Для интеграции обновлений в дистрибутив ОС, потребуется:</p>
<ul>
<li>Дистрибутив операционной системы в файле <code>.iso</code>.</li>
<li>Доступ в интернет для скачивания необходимых инструментов и обновлений.</li>
<li>Рекомендуется <strong>SSD</strong>. Все ниже приведённые этапы требуют активной работы с файлами. Поэтому, существенное ускорение можно получить выполняя все задачи на SSD.</li>
</ul>
<h3 id="структура-директорий">
  <a class="link-body-emphasis" href="#%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%82%d1%83%d1%80%d0%b0-%d0%b4%d0%b8%d1%80%d0%b5%d0%ba%d1%82%d0%be%d1%80%d0%b8%d0%b9">Структура директорий</a>
</h3><p>Для начала необходимо создать структуру директорий, которая послужит базисом для процесса интеграции обновлений:</p>
<ul>
<li><code>C:\BuildFarm</code> - корневая директория для работы.
<ul>
<li><code>\MNT</code> - директория, в которую будет монтироваться образ WIM.</li>
<li><code>\UPD</code> - директория для хранения скаченных обновлений.</li>
<li><code>\WIM</code> - директория для хранения образа WIM.</li>
</ul>
</li>
</ul>
<h3 id="ms-dism">
  <a class="link-body-emphasis" href="#ms-dism">MS DISM</a>
</h3><p>Для интеграции обновлений потребуется инструмент <strong>Deployment Image Servicing and Management (DISM)</strong> (<code>DISM.exe</code>), который входит в комплект <a title="" href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install" target="_blank" rel="noopener noreferrer nofollow">Windows Assessment and Deployment Kit (Windows ADK)</a>. Обычно, DISM уже поставляется с операционной системой, но я рекомендую <a title="" href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install#other-adk-downloads" target="_blank" rel="noopener noreferrer nofollow">скачивать</a> последнюю версию с сайта Microsoft и устанавливать вручную.</p>
<p>Когда Windows ADK установлен, DISM можно найти в меню <strong>&ldquo;Пуск&rdquo;</strong> вместе с остальными программам. Запускать DISM необходимо под администратором. Все команды, приведённые ниже, должны будут выполняться только через установленный вручную DISM. Использовать DISM, поставляемый с операционной системой нет необходимости.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Установленный вручную DISM можно найти в меню &ldquo;Пуск&rdquo; / Windows Kits / <strong>Среда средств развертывания и работы с образами</strong>.</p>

    </div>
  </div>
</div>

<h2 id="интеграция-обновлений">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9">Интеграция обновлений</a>
</h2><p>Обновления можно скачивать с сайта-каталога <a title="" href="https://www.catalog.update.microsoft.com/" target="_blank" rel="noopener noreferrer nofollow">Microsoft Update Catalog</a>. Я беру так называемые &ldquo;кумулятивные (накопительные) обновления&rdquo; (cumulative updates), содержащие в себе сразу множество пакетов с исправлениями и обновлениями функций. <a title="" href="https://www.catalog.update.microsoft.com/Search.aspx?q=cumulative%20update" target="_blank" rel="noopener noreferrer nofollow">Найти</a> такие крупные обновления можно в каталоге при помощи поискового запроса <code>cumulative update</code>.</p>
<p>Скачиваемые обновления помещаются в директорию <code>C:\BuildFarm\UPD</code> для дальнейшей интеграции в дистрибутив ОС.</p>
<h3 id="извлечение-файла-wim-из-дистрибутива-ms-windows">
  <a class="link-body-emphasis" href="#%d0%b8%d0%b7%d0%b2%d0%bb%d0%b5%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%84%d0%b0%d0%b9%d0%bb%d0%b0-wim-%d0%b8%d0%b7-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d0%b0-ms-windows">Извлечение файла WIM из дистрибутива MS Windows</a>
</h3><p>Образ ОС находится в специальном файле <code>sources\install.wim</code>. Его необходимо извлечь при помощи программ для работы с файлами <code>.iso</code> (подойдёт <a title="" href="https://www.ultraiso.com" target="_blank" rel="noopener noreferrer nofollow">UltraISO</a> или <a title="" href="https://www.poweriso.com" target="_blank" rel="noopener noreferrer nofollow">PowerISO</a>) в директорию <code>C:\BuildFarm\WIM</code>.</p>
<h3 id="получение-информации-из-wim-образа">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%b8%d0%bd%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%86%d0%b8%d0%b8-%d0%b8%d0%b7-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0">Получение информации из WIM-образа</a>
</h3><p>Файл <code>install.wim</code> может содержать несколько редакций ОС. Каждая редакция ОС имеет свой индекс. Для того, чтобы увидеть эти индексы, нужно ввести команду:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e83dcba1bbb114c4ed187bd4b4fda6c3"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Get-ImageInfo /ImageFile:<span class="s2">&#34;C:\BuildFarm\WIM\install.wim&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e83dcba1bbb114c4ed187bd4b4fda6c3"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Get-ImageInfo</code> - получить информацию о версиях операционной системы, находящихся в WIM-образ.</li>
<li><code>/ImageFile</code> - путь к WIM-образу.</li>
</ul>
<p>Введённая команда предоставит примерно такой выхлоп:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-06ea385ce0944699e31e1c9c75ab67d3"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-06ea385ce0944699e31e1c9c75ab67d3"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">Dism /Get-ImageInfo /ImageFile:&#34;C:\BuildFarm\WIM\install.wim&#34;

Details for image : C:\BuildFarm\WIM\install.wim

Index : 1
Name : Windows 10 Education
Description : Windows 10 Education
Size : 15,643,499,526 bytes

Index : 2
Name : Windows 10 Education N
Description : Windows 10 Education N
Size : 14,878,972,660 bytes

Index : 3
Name : Windows 10 Enterprise
Description : Windows 10 Enterprise
Size : 15,643,653,521 bytes

Index : 4
Name : Windows 10 Enterprise N
Description : Windows 10 Enterprise N
Size : 14,878,878,937 bytes

Index : 5
Name : Windows 10 Pro
Description : Windows 10 Pro
Size : 15,658,943,281 bytes

&lt;...&gt;
Extract Specific Windows Index from Windows 10 Multiple Edition ISO</code></pre></div>
  </div>
</div>
<h3 id="монтирование-wim-образа">
  <a class="link-body-emphasis" href="#%d0%bc%d0%be%d0%bd%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0">Монтирование WIM-образа</a>
</h3><p>Индексы получены. Теперь необходимо примонтировать редакцию ОС из конкретного индекса. Выбор индекса зависит от вас: выбираете индекс той редакции ОС, которая вам необходима. Я выбрал редакцию <strong>Windows 10 Pro</strong> с индексом <code>5</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8cf69692c0016505e7e0c88afe90f577"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Mount-Image /ImageFile:<span class="s2">&#34;C:\BuildFarm\WIM\install.wim&#34;</span> /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /index:5</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8cf69692c0016505e7e0c88afe90f577"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Mount-Image</code> - команда на монтирование WIM-образа.</li>
<li><code>/MountDir</code> - путь к директории, в которую необходимо поместить содержимое монтируемого WIM-образа.</li>
<li><code>/index:5</code> - номер версии дистрибутива ОС. Номер можно узнать командой <code>/Get-ImageInfo</code>.</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Если что-то пошло не так, размонтировать образ без сохранения можно следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8b64086a595f00815b44927d97cd046a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Discard</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8b64086a595f00815b44927d97cd046a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Проверить список примонтированных образов можно следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-1a1f637e4d5ab2cc71c1e0b6845e0d40"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Get-MountedImageInfo</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-1a1f637e4d5ab2cc71c1e0b6845e0d40"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Если после размонтирования образ всё ещё остаётся подключённым к системе и является повреждённым, следующая команда можешь помочь:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0433b9d726794980a2d8994576b36b9c"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Cleanup-Mountpoints</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0433b9d726794980a2d8994576b36b9c"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Она удалит все ресурсы, связанные с повреждённым образом и очистит систему от &ldquo;зависших&rdquo; точек монтирования.</p>

    </div>
  </div>
</div>

<h3 id="интеграция-обновлений-в-wim-образ">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9-%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7">Интеграция обновлений в WIM-образ</a>
</h3><p>После монтирования редакции ОС с конкретным индексом, можно начинать процесс интеграции обновлений:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f02b74d1fad6213e522f388539704e68"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Add-Package /PackagePath:<span class="s2">&#34;C:\BuildFarm\UPD&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f02b74d1fad6213e522f388539704e68"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Add-Package</code> - команда на добавление пакетов (обновлений) в WIM-образ.
<ul>
<li><code>/PackagePath</code> - путь к директории, в которой находятся пакеты (обновления) для интеграции в WIM-образ.</li>
</ul>
</li>
</ul>
<h3 id="проверка-корректности-интеграции-обновлений-опционально">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d1%80%d0%b5%d0%ba%d1%82%d0%bd%d0%be%d1%81%d1%82%d0%b8-%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d0%b8-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Проверка корректности интеграции обновлений (опционально)</a>
</h3><p>По окончании процесса интеграции, можно проверить корректность выполненной задачи. Команда ниже покажет список пакетов, установленных в примонтированной редакции ОС. В этом списке пакетов будут интегрированные обновления.</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0978e4eee7ed0ce47123fbe9b361d281"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Get-Packages</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0978e4eee7ed0ce47123fbe9b361d281"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Get-Packages</code> - команда для получения информации о интегрированных пакетах примонтированного WIM-образа.</li>
</ul>
<h3 id="очистка-хранилища-компонентов-wim-образ-опционально">
  <a class="link-body-emphasis" href="#%d0%be%d1%87%d0%b8%d1%81%d1%82%d0%ba%d0%b0-%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d0%bb%d0%b8%d1%89%d0%b0-%d0%ba%d0%be%d0%bc%d0%bf%d0%be%d0%bd%d0%b5%d0%bd%d1%82%d0%be%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Очистка хранилища компонентов WIM-образ (опционально)</a>
</h3><p>Для уменьшения размера дистрибутива можно запустить процедуру удаления предыдущих версий компонентов, которые были изменены (заменены) установленными обновлениями:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-077267ed7a46cc4786150513db6484fd"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Cleanup-Image /StartComponentCleanup /ResetBase</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-077267ed7a46cc4786150513db6484fd"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Cleanup-Image</code> - очистка и восстановление образа.
<ul>
<li><code>/StartComponentCleanup</code> - удаляет заменённые компоненты и уменьшает размер хранилища компонентов.
<ul>
<li><code>/ResetBase</code> - сброс базы заменяемых компонентов.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="проверка-хранилища-компонентов-wim-образа-опционально">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d0%bb%d0%b8%d1%89%d0%b0-%d0%ba%d0%be%d0%bc%d0%bf%d0%be%d0%bd%d0%b5%d0%bd%d1%82%d0%be%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Проверка хранилища компонентов WIM-образа (опционально)</a>
</h3><p>Опциональный шаг перед заключительным этапом - проверить системные компоненты и файлы на повреждения:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-714f2ebed19f89890321f6f0c0cc4b62"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Cleanup-Image /ScanHealth</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-714f2ebed19f89890321f6f0c0cc4b62"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Cleanup-Image</code> - очистка и восстановление образа.
<ul>
<li><code>/ScanHealth</code> - сканирование образа на наличие повреждений хранилища компонентов.</li>
</ul>
</li>
</ul>
<h3 id="сохранение-изменений-в-wim-образе">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d1%85%d1%80%d0%b0%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5-%d0%b8%d0%b7%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d0%b9-%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b5">Сохранение изменений в WIM-образе</a>
</h3><p>После выполнения всех действий, необходимо отмонтировать редакцию ОС с сохранением изменений. Делается это командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-b10480d74b2d4deab04861633426fc1e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Commit</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-b10480d74b2d4deab04861633426fc1e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Unmount-Image</code> - команда для отмонтирования WIM-образа.</li>
<li><code>/MountDir</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Commit</code> - сохранение совершённых изменений в WIM-образе.</li>
</ul>
<p>Всё. Мы получили файл <code>install.wim</code> с интегрированными обновлениями. Теперь этот файл <code>install.wim</code> необходимо обратно упаковать в образ ISO с заменой старого.</p>
<h2 id="автоматизация">
  <a class="link-body-emphasis" href="#%d0%b0%d0%b2%d1%82%d0%be%d0%bc%d0%b0%d1%82%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f">Автоматизация</a>
</h2><p>Я люблю автоматизировать всё по максимуму. И здесь я не упустил шанс написать небольшой скрипт с деревянной логикой, который сделает все шаги по интеграции обновлений за человека. Только вот, извлечь файл <code>install.wim</code> из ISO-образа придётся самому.</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>dism.packages.cmd</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-d4181c659f6440f7511262cb37f49dfe"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="dism.packages.cmd" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="dism.packages.cmd" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-d4181c659f6440f7511262cb37f49dfe"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Automatic integration of updates into DISM.</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">:</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @package   CMD</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @copyright 2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @license   MIT</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @version   0.1.0</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @link      https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">echo</span> off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_mnt</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">MNT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_upd</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">UPD&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_wim</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">WIM&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">f_wim</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">\install.wim&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Creating directories.</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Checking files.</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> <span class="k">echo</span> Please put <span class="s2">&#34;install.wim&#34;</span> file in <span class="s2">&#34;WIM&#34;</span> directory... <span class="p">&amp;&amp;</span> <span class="k">pause</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">/*.msu&#34;</span> <span class="k">echo</span> Please put <span class="s2">&#34;*.msu&#34;</span> files in <span class="s2">&#34;UPD&#34;</span> directory... <span class="p">&amp;&amp;</span> <span class="k">pause</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">echo</span> Getting Windows Image Info...
</span></span><span class="line"><span class="cl">  Dism /Get-ImageInfo /ImageFile:<span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">else</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">echo</span> <span class="s2">&#34;install.wim&#34;</span> not found! <span class="p">&amp;</span> <span class="k">echo</span>.Failed with error #<span class="nv">%errorlevel%</span>.
</span></span><span class="line"><span class="cl">  <span class="k">goto</span> <span class="p">:</span><span class="nl">error</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="k">/p</span> <span class="nv">index</span><span class="p">=</span><span class="s2">&#34;Enter INDEX: &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Mounting Windows image...
</span></span><span class="line"><span class="cl">Dism /Mount-Image /ImageFile:<span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /index:<span class="nv">%index%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Adding Windows packages...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Add-Package /PackagePath:<span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Getting Windows packages...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Get-Packages
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Reseting Windows image...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Cleanup-Image /StartComponentCleanup /ResetBase
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Scaning health Windows image...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Cleanup-Image /ScanHealth
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Saving Windows image...
</span></span><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Commit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="nl">error</span>
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b <span class="nv">%errorlevel%</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Поместить скрипт нужно в корень директории <code>BuildFarm</code> и запустить из терминала DISM. Если же возникнут какие-либо проблемы, ниже есть небольшой скрипт, который размонтирует образ и очистит систему от точек монтирования.</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>dism.unmount.cmd</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c1370f859d5a8cf25186f28ca39015b6"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="dism.unmount.cmd" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="dism.unmount.cmd" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-c1370f859d5a8cf25186f28ca39015b6"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Automatic unmounting WIM images into DISM.</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">:</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @package   CMD</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @copyright 2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @license   MIT</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @version   0.1.0</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @link      https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">echo</span> off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_mnt</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">MNT&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Unmounting <span class="s2">&#34;install.wim&#34;</span> and discards changes that were made when image was mounted...
</span></span><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Discard
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Deleting all of resources associated with a mounted image that has been corrupted...
</span></span><span class="line"><span class="cl">Dism /Cleanup-Mountpoints
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Getting information about mounted image...
</span></span><span class="line"><span class="cl">Dism /Get-MountedImageInfo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b 0
</span></span></code></pre></div></div>
      </div>
    </div>]]></content:encoded><turbo:source/><turbo:topic>Интеграция обновлений в дистрибутив ОС MS Windows</turbo:topic><turbo:content><![CDATA[<p>Microsoft каждый месяц выпускает новые версии дистрибутивов с уже интегрированными обновлениями. Но есть редакции ОС, например LTSC, для которых Microsoft не выполняет подобные действия. Приходится делать самому&hellip;</p>
<h2 id="подготовка">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0">Подготовка</a>
</h2><p>Для интеграции обновлений в дистрибутив ОС, потребуется:</p>
<ul>
<li>Дистрибутив операционной системы в файле <code>.iso</code>.</li>
<li>Доступ в интернет для скачивания необходимых инструментов и обновлений.</li>
<li>Рекомендуется <strong>SSD</strong>. Все ниже приведённые этапы требуют активной работы с файлами. Поэтому, существенное ускорение можно получить выполняя все задачи на SSD.</li>
</ul>
<h3 id="структура-директорий">
  <a class="link-body-emphasis" href="#%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%82%d1%83%d1%80%d0%b0-%d0%b4%d0%b8%d1%80%d0%b5%d0%ba%d1%82%d0%be%d1%80%d0%b8%d0%b9">Структура директорий</a>
</h3><p>Для начала необходимо создать структуру директорий, которая послужит базисом для процесса интеграции обновлений:</p>
<ul>
<li><code>C:\BuildFarm</code> - корневая директория для работы.
<ul>
<li><code>\MNT</code> - директория, в которую будет монтироваться образ WIM.</li>
<li><code>\UPD</code> - директория для хранения скаченных обновлений.</li>
<li><code>\WIM</code> - директория для хранения образа WIM.</li>
</ul>
</li>
</ul>
<h3 id="ms-dism">
  <a class="link-body-emphasis" href="#ms-dism">MS DISM</a>
</h3><p>Для интеграции обновлений потребуется инструмент <strong>Deployment Image Servicing and Management (DISM)</strong> (<code>DISM.exe</code>), который входит в комплект <a title="" href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install" target="_blank" rel="noopener noreferrer nofollow">Windows Assessment and Deployment Kit (Windows ADK)</a>. Обычно, DISM уже поставляется с операционной системой, но я рекомендую <a title="" href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install#other-adk-downloads" target="_blank" rel="noopener noreferrer nofollow">скачивать</a> последнюю версию с сайта Microsoft и устанавливать вручную.</p>
<p>Когда Windows ADK установлен, DISM можно найти в меню <strong>&ldquo;Пуск&rdquo;</strong> вместе с остальными программам. Запускать DISM необходимо под администратором. Все команды, приведённые ниже, должны будут выполняться только через установленный вручную DISM. Использовать DISM, поставляемый с операционной системой нет необходимости.</p>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Установленный вручную DISM можно найти в меню &ldquo;Пуск&rdquo; / Windows Kits / <strong>Среда средств развертывания и работы с образами</strong>.</p>

    </div>
  </div>
</div>

<h2 id="интеграция-обновлений">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9">Интеграция обновлений</a>
</h2><p>Обновления можно скачивать с сайта-каталога <a title="" href="https://www.catalog.update.microsoft.com/" target="_blank" rel="noopener noreferrer nofollow">Microsoft Update Catalog</a>. Я беру так называемые &ldquo;кумулятивные (накопительные) обновления&rdquo; (cumulative updates), содержащие в себе сразу множество пакетов с исправлениями и обновлениями функций. <a title="" href="https://www.catalog.update.microsoft.com/Search.aspx?q=cumulative%20update" target="_blank" rel="noopener noreferrer nofollow">Найти</a> такие крупные обновления можно в каталоге при помощи поискового запроса <code>cumulative update</code>.</p>
<p>Скачиваемые обновления помещаются в директорию <code>C:\BuildFarm\UPD</code> для дальнейшей интеграции в дистрибутив ОС.</p>
<h3 id="извлечение-файла-wim-из-дистрибутива-ms-windows">
  <a class="link-body-emphasis" href="#%d0%b8%d0%b7%d0%b2%d0%bb%d0%b5%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%84%d0%b0%d0%b9%d0%bb%d0%b0-wim-%d0%b8%d0%b7-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d0%b0-ms-windows">Извлечение файла WIM из дистрибутива MS Windows</a>
</h3><p>Образ ОС находится в специальном файле <code>sources\install.wim</code>. Его необходимо извлечь при помощи программ для работы с файлами <code>.iso</code> (подойдёт <a title="" href="https://www.ultraiso.com" target="_blank" rel="noopener noreferrer nofollow">UltraISO</a> или <a title="" href="https://www.poweriso.com" target="_blank" rel="noopener noreferrer nofollow">PowerISO</a>) в директорию <code>C:\BuildFarm\WIM</code>.</p>
<h3 id="получение-информации-из-wim-образа">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%b8%d0%bd%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%86%d0%b8%d0%b8-%d0%b8%d0%b7-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0">Получение информации из WIM-образа</a>
</h3><p>Файл <code>install.wim</code> может содержать несколько редакций ОС. Каждая редакция ОС имеет свой индекс. Для того, чтобы увидеть эти индексы, нужно ввести команду:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-e83dcba1bbb114c4ed187bd4b4fda6c3"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Get-ImageInfo /ImageFile:<span class="s2">&#34;C:\BuildFarm\WIM\install.wim&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-e83dcba1bbb114c4ed187bd4b4fda6c3"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Get-ImageInfo</code> - получить информацию о версиях операционной системы, находящихся в WIM-образ.</li>
<li><code>/ImageFile</code> - путь к WIM-образу.</li>
</ul>
<p>Введённая команда предоставит примерно такой выхлоп:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-06ea385ce0944699e31e1c9c75ab67d3"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-06ea385ce0944699e31e1c9c75ab67d3"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">Dism /Get-ImageInfo /ImageFile:&#34;C:\BuildFarm\WIM\install.wim&#34;

Details for image : C:\BuildFarm\WIM\install.wim

Index : 1
Name : Windows 10 Education
Description : Windows 10 Education
Size : 15,643,499,526 bytes

Index : 2
Name : Windows 10 Education N
Description : Windows 10 Education N
Size : 14,878,972,660 bytes

Index : 3
Name : Windows 10 Enterprise
Description : Windows 10 Enterprise
Size : 15,643,653,521 bytes

Index : 4
Name : Windows 10 Enterprise N
Description : Windows 10 Enterprise N
Size : 14,878,878,937 bytes

Index : 5
Name : Windows 10 Pro
Description : Windows 10 Pro
Size : 15,658,943,281 bytes

&lt;...&gt;
Extract Specific Windows Index from Windows 10 Multiple Edition ISO</code></pre></div>
  </div>
</div>
<h3 id="монтирование-wim-образа">
  <a class="link-body-emphasis" href="#%d0%bc%d0%be%d0%bd%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0">Монтирование WIM-образа</a>
</h3><p>Индексы получены. Теперь необходимо примонтировать редакцию ОС из конкретного индекса. Выбор индекса зависит от вас: выбираете индекс той редакции ОС, которая вам необходима. Я выбрал редакцию <strong>Windows 10 Pro</strong> с индексом <code>5</code>:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8cf69692c0016505e7e0c88afe90f577"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Mount-Image /ImageFile:<span class="s2">&#34;C:\BuildFarm\WIM\install.wim&#34;</span> /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /index:5</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8cf69692c0016505e7e0c88afe90f577"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Mount-Image</code> - команда на монтирование WIM-образа.</li>
<li><code>/MountDir</code> - путь к директории, в которую необходимо поместить содержимое монтируемого WIM-образа.</li>
<li><code>/index:5</code> - номер версии дистрибутива ОС. Номер можно узнать командой <code>/Get-ImageInfo</code>.</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Если что-то пошло не так, размонтировать образ без сохранения можно следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-8b64086a595f00815b44927d97cd046a"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Discard</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8b64086a595f00815b44927d97cd046a"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Проверить список примонтированных образов можно следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-1a1f637e4d5ab2cc71c1e0b6845e0d40"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Get-MountedImageInfo</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-1a1f637e4d5ab2cc71c1e0b6845e0d40"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Если после размонтирования образ всё ещё остаётся подключённым к системе и является повреждённым, следующая команда можешь помочь:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0433b9d726794980a2d8994576b36b9c"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Cleanup-Mountpoints</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0433b9d726794980a2d8994576b36b9c"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Она удалит все ресурсы, связанные с повреждённым образом и очистит систему от &ldquo;зависших&rdquo; точек монтирования.</p>

    </div>
  </div>
</div>

<h3 id="интеграция-обновлений-в-wim-образ">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9-%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7">Интеграция обновлений в WIM-образ</a>
</h3><p>После монтирования редакции ОС с конкретным индексом, можно начинать процесс интеграции обновлений:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-f02b74d1fad6213e522f388539704e68"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Add-Package /PackagePath:<span class="s2">&#34;C:\BuildFarm\UPD&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f02b74d1fad6213e522f388539704e68"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Add-Package</code> - команда на добавление пакетов (обновлений) в WIM-образ.
<ul>
<li><code>/PackagePath</code> - путь к директории, в которой находятся пакеты (обновления) для интеграции в WIM-образ.</li>
</ul>
</li>
</ul>
<h3 id="проверка-корректности-интеграции-обновлений-опционально">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d0%ba%d0%be%d1%80%d1%80%d0%b5%d0%ba%d1%82%d0%bd%d0%be%d1%81%d1%82%d0%b8-%d0%b8%d0%bd%d1%82%d0%b5%d0%b3%d1%80%d0%b0%d1%86%d0%b8%d0%b8-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b9-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Проверка корректности интеграции обновлений (опционально)</a>
</h3><p>По окончании процесса интеграции, можно проверить корректность выполненной задачи. Команда ниже покажет список пакетов, установленных в примонтированной редакции ОС. В этом списке пакетов будут интегрированные обновления.</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-0978e4eee7ed0ce47123fbe9b361d281"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Get-Packages</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0978e4eee7ed0ce47123fbe9b361d281"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Get-Packages</code> - команда для получения информации о интегрированных пакетах примонтированного WIM-образа.</li>
</ul>
<h3 id="очистка-хранилища-компонентов-wim-образ-опционально">
  <a class="link-body-emphasis" href="#%d0%be%d1%87%d0%b8%d1%81%d1%82%d0%ba%d0%b0-%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d0%bb%d0%b8%d1%89%d0%b0-%d0%ba%d0%be%d0%bc%d0%bf%d0%be%d0%bd%d0%b5%d0%bd%d1%82%d0%be%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Очистка хранилища компонентов WIM-образ (опционально)</a>
</h3><p>Для уменьшения размера дистрибутива можно запустить процедуру удаления предыдущих версий компонентов, которые были изменены (заменены) установленными обновлениями:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-077267ed7a46cc4786150513db6484fd"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Cleanup-Image /StartComponentCleanup /ResetBase</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-077267ed7a46cc4786150513db6484fd"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Cleanup-Image</code> - очистка и восстановление образа.
<ul>
<li><code>/StartComponentCleanup</code> - удаляет заменённые компоненты и уменьшает размер хранилища компонентов.
<ul>
<li><code>/ResetBase</code> - сброс базы заменяемых компонентов.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="проверка-хранилища-компонентов-wim-образа-опционально">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d0%bb%d0%b8%d1%89%d0%b0-%d0%ba%d0%be%d0%bc%d0%bf%d0%be%d0%bd%d0%b5%d0%bd%d1%82%d0%be%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0-%d0%be%d0%bf%d1%86%d0%b8%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d0%be">Проверка хранилища компонентов WIM-образа (опционально)</a>
</h3><p>Опциональный шаг перед заключительным этапом - проверить системные компоненты и файлы на повреждения:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-714f2ebed19f89890321f6f0c0cc4b62"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Cleanup-Image /ScanHealth</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-714f2ebed19f89890321f6f0c0cc4b62"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Image</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Cleanup-Image</code> - очистка и восстановление образа.
<ul>
<li><code>/ScanHealth</code> - сканирование образа на наличие повреждений хранилища компонентов.</li>
</ul>
</li>
</ul>
<h3 id="сохранение-изменений-в-wim-образе">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d1%85%d1%80%d0%b0%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5-%d0%b8%d0%b7%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d0%b9-%d0%b2-wim-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b5">Сохранение изменений в WIM-образе</a>
</h3><p>После выполнения всех действий, необходимо отмонтировать редакцию ОС с сохранением изменений. Делается это командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-cmd">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-b10480d74b2d4deab04861633426fc1e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;C:\BuildFarm\MNT&#34;</span> /Commit</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-b10480d74b2d4deab04861633426fc1e"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>/Unmount-Image</code> - команда для отмонтирования WIM-образа.</li>
<li><code>/MountDir</code> - путь к директории, в которой находится содержимое примонтированного WIM-образа.</li>
<li><code>/Commit</code> - сохранение совершённых изменений в WIM-образе.</li>
</ul>
<p>Всё. Мы получили файл <code>install.wim</code> с интегрированными обновлениями. Теперь этот файл <code>install.wim</code> необходимо обратно упаковать в образ ISO с заменой старого.</p>
<h2 id="автоматизация">
  <a class="link-body-emphasis" href="#%d0%b0%d0%b2%d1%82%d0%be%d0%bc%d0%b0%d1%82%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f">Автоматизация</a>
</h2><p>Я люблю автоматизировать всё по максимуму. И здесь я не упустил шанс написать небольшой скрипт с деревянной логикой, который сделает все шаги по интеграции обновлений за человека. Только вот, извлечь файл <code>install.wim</code> из ISO-образа придётся самому.</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>dism.packages.cmd</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-d4181c659f6440f7511262cb37f49dfe"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="dism.packages.cmd" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="dism.packages.cmd" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-d4181c659f6440f7511262cb37f49dfe"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Automatic integration of updates into DISM.</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">:</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @package   CMD</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @copyright 2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @license   MIT</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @version   0.1.0</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @link      https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">echo</span> off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_mnt</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">MNT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_upd</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">UPD&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_wim</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">WIM&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">f_wim</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">\install.wim&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Creating directories.</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">&#34;</span> <span class="k">mkdir</span> <span class="s2">&#34;</span><span class="nv">%d_wim%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Checking files.</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> <span class="k">echo</span> Please put <span class="s2">&#34;install.wim&#34;</span> file in <span class="s2">&#34;WIM&#34;</span> directory... <span class="p">&amp;&amp;</span> <span class="k">pause</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">not</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">/*.msu&#34;</span> <span class="k">echo</span> Please put <span class="s2">&#34;*.msu&#34;</span> files in <span class="s2">&#34;UPD&#34;</span> directory... <span class="p">&amp;&amp;</span> <span class="k">pause</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">exist</span> <span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">echo</span> Getting Windows Image Info...
</span></span><span class="line"><span class="cl">  Dism /Get-ImageInfo /ImageFile:<span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">else</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">echo</span> <span class="s2">&#34;install.wim&#34;</span> not found! <span class="p">&amp;</span> <span class="k">echo</span>.Failed with error #<span class="nv">%errorlevel%</span>.
</span></span><span class="line"><span class="cl">  <span class="k">goto</span> <span class="p">:</span><span class="nl">error</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="k">/p</span> <span class="nv">index</span><span class="p">=</span><span class="s2">&#34;Enter INDEX: &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Mounting Windows image...
</span></span><span class="line"><span class="cl">Dism /Mount-Image /ImageFile:<span class="s2">&#34;</span><span class="nv">%f_wim%</span><span class="s2">&#34;</span> /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /index:<span class="nv">%index%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Adding Windows packages...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Add-Package /PackagePath:<span class="s2">&#34;</span><span class="nv">%d_upd%</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Getting Windows packages...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Get-Packages
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Reseting Windows image...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Cleanup-Image /StartComponentCleanup /ResetBase
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Scaning health Windows image...
</span></span><span class="line"><span class="cl">Dism /Image:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Cleanup-Image /ScanHealth
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Saving Windows image...
</span></span><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Commit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="nl">error</span>
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b <span class="nv">%errorlevel%</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<p>Поместить скрипт нужно в корень директории <code>BuildFarm</code> и запустить из терминала DISM. Если же возникнут какие-либо проблемы, ниже есть небольшой скрипт, который размонтирует образ и очистит систему от точек монтирования.</p>

    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>dism.unmount.cmd</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-c1370f859d5a8cf25186f28ca39015b6"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="dism.unmount.cmd" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="dism.unmount.cmd" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
              
          
        <div class="card-body" id="clipboard-c1370f859d5a8cf25186f28ca39015b6"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: Automatic unmounting WIM images into DISM.</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">:</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @package   CMD</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @copyright 2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @license   MIT</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @version   0.1.0</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: @link      https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="p">:</span><span class="c1">: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">echo</span> off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">set</span> <span class="nv">d_mnt</span><span class="p">=</span><span class="s2">&#34;</span><span class="nv">%~dp0</span><span class="s2">MNT&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Unmounting <span class="s2">&#34;install.wim&#34;</span> and discards changes that were made when image was mounted...
</span></span><span class="line"><span class="cl">Dism /Unmount-Image /MountDir:<span class="s2">&#34;</span><span class="nv">%d_mnt%</span><span class="s2">&#34;</span> /Discard
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Deleting all of resources associated with a mounted image that has been corrupted...
</span></span><span class="line"><span class="cl">Dism /Cleanup-Mountpoints
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> Getting information about mounted image...
</span></span><span class="line"><span class="cl">Dism /Get-MountedImageInfo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">exit</span> /b 0
</span></span></code></pre></div></div>
      </div>
    </div>]]></turbo:content><pubDate>Mon, 09 May 2022 12:39:47 +0000</pubDate><category>MS Windows</category><category>Терминал</category><category>Скрипты</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Windows Server 2022 для рабочей станции</title><link>https://lib.onl/ru/posts/2022/05/36058650-3f35-5ed5-9565-0aa7d8800c28/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2022/05/36058650-3f35-5ed5-9565-0aa7d8800c28/</guid><description>В этой небольшой заметке я расскажу, как перенастроить серверную версию ОС Windows для работы на обычном стационарном ПК.</description><media:content medium="image" url="https://images.unsplash.com/photo-1640086940714-65501b9214f2" width="1600" height="900"/><content:encoded><![CDATA[<p>В этой небольшой заметке я расскажу, как перенастроить серверную версию ОС Windows для работы на обычном стационарном ПК.</p>
<h2 id="настройка-служб">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%81%d0%bb%d1%83%d0%b6%d0%b1">Настройка служб</a>
</h2><p>На сервере нет необходимости использовать поисковые механизмы и вывод звука, поэтому они отключены. Но на рабочей станции эти параметры необходимы. Для включения звука и поискового механизма, необходимо настроить запуск соответствующих служб.</p>
<ul>
<li>Services
<ul>
<li>Windows Audio
<ul>
<li>Startup type
<ul>
<li>Automatic</li>
</ul>
</li>
</ul>
</li>
<li>Windows Audio Endpoint
<ul>
<li>Startup type
<ul>
<li>Automatic</li>
</ul>
</li>
</ul>
</li>
<li>Windows Search
<ul>
<li>Startup type
<ul>
<li>Automatic (Delayed Start)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-shutdown-event-tracker">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-shutdown-event-tracker">Отключение Shutdown Event Tracker</a>
</h2><p>Сервер должен работать бесперебойно. Любое отключение сервера, по хорошему, должно записываться в специальный журнал. Но так как у нас рабочая станция, записывать каждые перезагрузку или выключение нет необходимости. Включаем службы.</p>
<ul>
<li>Local Group Policy
<ul>
<li>Computer Configuration / Administrative Templates / System
<ul>
<li>Display Shutdown Event Tracker
<ul>
<li>Disabled</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-строгой-системы-безопасности-ie">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%81%d1%82%d1%80%d0%be%d0%b3%d0%be%d0%b9-%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d1%8b-%d0%b1%d0%b5%d0%b7%d0%be%d0%bf%d0%b0%d1%81%d0%bd%d0%be%d1%81%d1%82%d0%b8-ie">Отключение строгой системы безопасности IE</a>
</h2><p>Сервер использует строгие параметры системы безопасности IE. Но на рабочей станции в этих параметрах нет необходимости и они будут только мешать. Отключаем их.</p>
<ul>
<li>Server Manager / Local Server
<ul>
<li>IE Enhanced Security Configuration
<ul>
<li>Off</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="оптимизация-производительности-для-приложений">
  <a class="link-body-emphasis" href="#%d0%be%d0%bf%d1%82%d0%b8%d0%bc%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%bf%d1%80%d0%be%d0%b8%d0%b7%d0%b2%d0%be%d0%b4%d0%b8%d1%82%d0%b5%d0%bb%d1%8c%d0%bd%d0%be%d1%81%d1%82%d0%b8-%d0%b4%d0%bb%d1%8f-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b9">Оптимизация производительности для приложений</a>
</h2><p>По умолчанию, на сервере оптимизация включена для фоновых служб. На рабочей станции необходима оптимизация для программ. Включаем оптимизацию для программ.</p>
<ul>
<li>System / Advanced System Settings / Advanced / Performance / Advanced
<ul>
<li>Adjust for best performance of
<ul>
<li>Programs</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-dep">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-dep">Отключение DEP</a>
</h2><p>По умолчанию, <a title="" href="https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention" target="_blank" rel="noopener noreferrer nofollow">Data Execution Prevention (DEP)</a> включена абсолютно для всех программ и сервисов. Такая излишняя защита на рабочей станции не нужна. Поэтому, переключаем выполнение DEP только для программ и сервисов самой ОС Windows.</p>
<ul>
<li>System / Advanced System Settings / Advanced / Performance / Data Execution Prevention
<ul>
<li>Turn on DEP for essential Windows programs and services only</li>
</ul>
</li>
</ul>
<h2 id="включение-memory-compression-operation-api-и-pagecombining">
  <a class="link-body-emphasis" href="#%d0%b2%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-memory-compression-operation-api-%d0%b8-pagecombining">Включение Memory Compression, Operation API и PageCombining</a>
</h2><p>В ОС Windows для обычных компьютеров включены Memory Compression, Operation API и PageCombining. Поэтому, перенастраиваем серверную версию ОС на такую же конфигурацию. Для этого запускаем PowerShell от имени Администратора и выполняем команду:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-359c60bb501fcb629401319dbd663798"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enable-MMAgent</span> <span class="n">-MemoryCompression</span> <span class="n">-OperationAPI</span> <span class="n">-PageCombining</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-359c60bb501fcb629401319dbd663798"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>]]></content:encoded><turbo:source/><turbo:topic>Windows Server 2022 для рабочей станции</turbo:topic><turbo:content><![CDATA[<p>В этой небольшой заметке я расскажу, как перенастроить серверную версию ОС Windows для работы на обычном стационарном ПК.</p>
<h2 id="настройка-служб">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%81%d0%bb%d1%83%d0%b6%d0%b1">Настройка служб</a>
</h2><p>На сервере нет необходимости использовать поисковые механизмы и вывод звука, поэтому они отключены. Но на рабочей станции эти параметры необходимы. Для включения звука и поискового механизма, необходимо настроить запуск соответствующих служб.</p>
<ul>
<li>Services
<ul>
<li>Windows Audio
<ul>
<li>Startup type
<ul>
<li>Automatic</li>
</ul>
</li>
</ul>
</li>
<li>Windows Audio Endpoint
<ul>
<li>Startup type
<ul>
<li>Automatic</li>
</ul>
</li>
</ul>
</li>
<li>Windows Search
<ul>
<li>Startup type
<ul>
<li>Automatic (Delayed Start)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-shutdown-event-tracker">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-shutdown-event-tracker">Отключение Shutdown Event Tracker</a>
</h2><p>Сервер должен работать бесперебойно. Любое отключение сервера, по хорошему, должно записываться в специальный журнал. Но так как у нас рабочая станция, записывать каждые перезагрузку или выключение нет необходимости. Включаем службы.</p>
<ul>
<li>Local Group Policy
<ul>
<li>Computer Configuration / Administrative Templates / System
<ul>
<li>Display Shutdown Event Tracker
<ul>
<li>Disabled</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-строгой-системы-безопасности-ie">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%81%d1%82%d1%80%d0%be%d0%b3%d0%be%d0%b9-%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d1%8b-%d0%b1%d0%b5%d0%b7%d0%be%d0%bf%d0%b0%d1%81%d0%bd%d0%be%d1%81%d1%82%d0%b8-ie">Отключение строгой системы безопасности IE</a>
</h2><p>Сервер использует строгие параметры системы безопасности IE. Но на рабочей станции в этих параметрах нет необходимости и они будут только мешать. Отключаем их.</p>
<ul>
<li>Server Manager / Local Server
<ul>
<li>IE Enhanced Security Configuration
<ul>
<li>Off</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="оптимизация-производительности-для-приложений">
  <a class="link-body-emphasis" href="#%d0%be%d0%bf%d1%82%d0%b8%d0%bc%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%bf%d1%80%d0%be%d0%b8%d0%b7%d0%b2%d0%be%d0%b4%d0%b8%d1%82%d0%b5%d0%bb%d1%8c%d0%bd%d0%be%d1%81%d1%82%d0%b8-%d0%b4%d0%bb%d1%8f-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b9">Оптимизация производительности для приложений</a>
</h2><p>По умолчанию, на сервере оптимизация включена для фоновых служб. На рабочей станции необходима оптимизация для программ. Включаем оптимизацию для программ.</p>
<ul>
<li>System / Advanced System Settings / Advanced / Performance / Advanced
<ul>
<li>Adjust for best performance of
<ul>
<li>Programs</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="отключение-dep">
  <a class="link-body-emphasis" href="#%d0%be%d1%82%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-dep">Отключение DEP</a>
</h2><p>По умолчанию, <a title="" href="https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention" target="_blank" rel="noopener noreferrer nofollow">Data Execution Prevention (DEP)</a> включена абсолютно для всех программ и сервисов. Такая излишняя защита на рабочей станции не нужна. Поэтому, переключаем выполнение DEP только для программ и сервисов самой ОС Windows.</p>
<ul>
<li>System / Advanced System Settings / Advanced / Performance / Data Execution Prevention
<ul>
<li>Turn on DEP for essential Windows programs and services only</li>
</ul>
</li>
</ul>
<h2 id="включение-memory-compression-operation-api-и-pagecombining">
  <a class="link-body-emphasis" href="#%d0%b2%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-memory-compression-operation-api-%d0%b8-pagecombining">Включение Memory Compression, Operation API и PageCombining</a>
</h2><p>В ОС Windows для обычных компьютеров включены Memory Compression, Operation API и PageCombining. Поэтому, перенастраиваем серверную версию ОС на такую же конфигурацию. Для этого запускаем PowerShell от имени Администратора и выполняем команду:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-powershell">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-359c60bb501fcb629401319dbd663798"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enable-MMAgent</span> <span class="n">-MemoryCompression</span> <span class="n">-OperationAPI</span> <span class="n">-PageCombining</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-359c60bb501fcb629401319dbd663798"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>]]></turbo:content><pubDate>Mon, 09 May 2022 11:53:26 +0000</pubDate><category>MS Windows</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Windows 10: Настройка через групповые политики</title><link>https://lib.onl/ru/posts/2020/07/94261403-060b-57b6-9bb0-7a0c07d09af9/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2020/07/94261403-060b-57b6-9bb0-7a0c07d09af9/</guid><description>Windows 10 до сих пор вызывает противоречивые чувства: иногда её поведение предсказуемо, иногда какое-нибудь обновление ломает систему, удаляя данные пользователя. И чтобы как-то улучшить положение дел и усмирить некоторые функции, я использую групповые политики в настройке операционной системы (ОС).</description><media:content medium="image" url="https://images.unsplash.com/photo-1530133532239-eda6f53fcf0f" width="1600" height="900"/><content:encoded><![CDATA[<p>Windows 10 до сих пор вызывает противоречивые чувства: иногда её поведение предсказуемо, иногда какое-нибудь обновление ломает систему, удаляя данные пользователя. И чтобы как-то улучшить положение дел и усмирить некоторые функции, я использую групповые политики в настройке операционной системы (ОС).</p>
<p>Сразу скажу, что мне нравится английский текст в интерфейсах. Поэтому все ОС у меня с интерфейсом в английской локализации, но я постараюсь максимально подробно описывать приведённые здесь групповые политики. Я использую Windows 10 в версии Enterprise, и не стоит забывать, что политики могут отличаться между различными версиями ОС.</p>
<p>Как открыть редактор групповых политик? Очень просто: необходимо нажать сочетание клавиш <span class="shortcode shortcode-key"><kbd>WIN + R</kbd></span>, откроется окно команды &ldquo;Выполнить&rdquo; и в текстовом поле набрать gpedit.msc и нажать <span class="shortcode shortcode-key"><kbd>OK</kbd></span>.</p>
<ul>
<li>:white_check_mark: - включить (разрешить).</li>
<li>:no_entry: - отключить (запретить).</li>
</ul>
<h2 id="computer-details">
  <a class="link-body-emphasis" href="#computer-details">Computer Details</a>
</h2><p>Секция отвечает за корректировку групповых политик компьютера в целом.</p>
<h3 id="systemdevice-installation">
  <a class="link-body-emphasis" href="#systemdevice-installation">System/Device Installation</a>
</h3><ul>
<li>:white_check_mark: <strong>Prevent device metadata retrieval from the Internet</strong><br>
Запретить использование мета-информации для подключённых устройств из Интернета. Политика отвечает за отображение индивидуальных значков принтеров, сканеров и такое прочее. Для отображения подобных значков, Windows лезет в Интернет и загружает мета-данные. Мне подобное не нужно, поэтому я включаю политику (включить = запретить).</li>
<li>:white_check_mark: <strong>Specify search order for device driver source locations</strong><br>
Специальный порядок источников для поиска драйверов в них. А вот эта политика отвечает за автоматическую установку драйверов на видеокарты, звуковые карты, различную периферию и прочее. Здесь можно указать ОС в каких источниках искать драйвера, приложения и прочее. Меня всегда раздражало, когда Windows при подключении к Интернету устанавливает устаревшие драйвера, например, на видеокарту. Зачем, когда я могу скачать свежие версии с сайта производителя? Включаю политику и выбираю опцию, указанную ниже.
<ul>
<li><em>Do not search Windows Update</em><br>
Не использовать Windows Update для поиска драйверов.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentsautoplay-policies">
  <a class="link-body-emphasis" href="#windows-componentsautoplay-policies">Windows Components/AutoPlay Policies</a>
</h3><ul>
<li>:white_check_mark: <em>Turn off Autoplay</em><br>
Отключить автоматический запуск. Политика позволяет отключить запуск подходящего приложения при втыкании, например, флешки с музыкой или картинками. Ранее (да и сейчас, наверно) таким способом любили запускаться злые вирусы. Включаю политику и выбираю опцию, указанную ниже.
<ul>
<li>All drives<br>
У меня отключено на всех устройствах.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentscloud-content">
  <a class="link-body-emphasis" href="#windows-componentscloud-content">Windows Components/Cloud Content</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not show Windows tips</strong><br>
Не показывать подсказки Windows. Лично мне подсказки ОС не нужны. Я как нибудь без них обойдусь. Включаю политику.</li>
<li>:white_check_mark: <strong>Turn off Microsoft consumer experiences</strong><br>
Выключить Microsoft Consumer Experience. Компания Microsoft своими рекомендациями навязывает установку таких приложений, как Candy Crush Soda Saga, FarmVille 2, Flipboard, Twitter, Photoshop Express, Minecraft и т.д. Мне они не нужны да и мне чуждо такое навязывание. Неприятно. Включаю политику, тем самым отключая подобную рекламу.</li>
</ul>
<h3 id="windows-componentsdata-collection-and-preview-builds">
  <a class="link-body-emphasis" href="#windows-componentsdata-collection-and-preview-builds">Windows Components/Data Collection and Preview Builds</a>
</h3><ul>
<li>:white_check_mark: <strong>Allow Telemetry</strong><br>
Разрешить телеметрию. Полностью телеметрию отключить всё равно не получится, что бы там не писали в Интернете. Поэтому, я включаю телеметрию и устанавливаю уровень сбора информации.
<ul>
<li><em>0 - Security [Enterprise Only]</em><br>
Ставлю нулевой уровень. Собирать данные, необходимые для осуществления безопасности. Но это только для операционной системы класса Enterprise.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentsdesktop-gadgets">
  <a class="link-body-emphasis" href="#windows-componentsdesktop-gadgets">Windows Components/Desktop Gadgets</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off desktop gadgets</strong><br>
Выключить гаджеты рабочего стола. Актуально для Windows Vista / 7. В Windows 10 гаджетов не видел. Может потому что не использовал их никогда. Но политику включаю.</li>
</ul>
<h3 id="windows-componentsmicrosoft-defender-antivirus">
  <a class="link-body-emphasis" href="#windows-componentsmicrosoft-defender-antivirus">Windows Components/Microsoft Defender Antivirus</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off Microsoft Defender Antivirus</strong><br>
Отключить Microsoft Defender Antivirus. Я отключаю себе антивирус. Головы хватает, чтобы не подхватить вирусы. Использую только ограниченный проверенный набор программ. При этом, если необходимо запустить что-то экзотическое, у меня всегда развёрнута виртуальная машина в Hyper-V.</li>
</ul>
<h3 id="windows-componentsonedrive">
  <a class="link-body-emphasis" href="#windows-componentsonedrive">Windows Components/OneDrive</a>
</h3><ul>
<li>:white_check_mark: <strong>Prevent the usage of OneDrive for file storage</strong><br>
Запретить использование OneDrive как файловое хранилище. Мне не нужен OneDrive. Поэтому я запрещаю использование OneDrive в качестве хранилища файлов.</li>
</ul>
<h3 id="windows-componentssearch">
  <a class="link-body-emphasis" href="#windows-componentssearch">Windows Components/Search</a>
</h3><ul>
<li>:no_entry: <strong>Allow Cloud Search</strong><br>
Разрешить использование облачного поиска. Мне не нужен в ОС поиск, который будет искать по различным сайтам. Только локальный поиск. Поэтому, я запрещаю политику.</li>
<li>:no_entry: <strong>Allow Cortana</strong><br>
Разрешить Cortana. Cortana мне тоже не нужна. Мне не о чём с ней поговорить. Поэтому, я запрещаю Cortana.</li>
</ul>
<h3 id="windows-componentsstore">
  <a class="link-body-emphasis" href="#windows-componentsstore">Windows Components/Store</a>
</h3><ul>
<li>:white_check_mark: <strong>Disable all apps from Microsoft Store</strong><br>
Отключить все приложения из Microsoft Store. Для выпиливания приложений, установленных из Microsoft Store в Интернете гуляет скрипт на PowerShell. Но мне лень его использовать, да и мало ли что&hellip; Поэтому, я просто отключаю подобные приложения через групповые политики. Они остаются в меню Start, но не используются.</li>
<li>:white_check_mark: <strong>Turn off the Store application</strong><br>
Подобно представленной выше политике, эта отключает магазин приложений. Согласно описанию и Интернету, эта политика важнее предыдущей, и включение её отключает не только сам магазин, но и приложения из него.</li>
</ul>
<h3 id="windows-componentssync-your-settings">
  <a class="link-body-emphasis" href="#windows-componentssync-your-settings">Windows Components/Sync your settings</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not sync</strong><br>
Не синхронизировать настройки пользователя. Синхронизация настроек между устройствами мне не нужна. Я включаю политику, тем самым отключаю синхронизацию.</li>
</ul>
<h3 id="windows-componentswindows-game-recording-and-broadcasting">
  <a class="link-body-emphasis" href="#windows-componentswindows-game-recording-and-broadcasting">Windows Components/Windows Game Recording and Broadcasting</a>
</h3><ul>
<li>:no_entry: <strong>Enables or disables Windows Game Recording and Broadcasting</strong><br>
Включение или отключение функций Windows Game Recording и Broadcasting. Так как я не играю в игры, для меня подобная функциональность ОС избыточна. Отключаю политику.</li>
</ul>
<h3 id="windows-componentswindows-update">
  <a class="link-body-emphasis" href="#windows-componentswindows-update">Windows Components/Windows Update</a>
</h3><ul>
<li>:white_check_mark: <strong>Configure Automatic Updates</strong><br>
Конфигурация автоматического обновления. Ох, сколько в Интернете страданий по поводу обновлений Windows 10. При включении этой политике, я указываю опции, которые помогут избавится от ряда проблем с автоматическим обновлением.
<ul>
<li><strong>Configure automatic updating:</strong> <em>2 - Notify for download and auto install</em><br>
Я выбираю опцию #2, которая гласит как &ldquo;Информировать о выпуске новых обновлений&rdquo;.</li>
<li>:white_check_mark: <em>Install updates for other Microsoft products</em><br>
Также отмечаю галочкой опцию &ldquo;Устанавливать обновления для других продуктов Microsoft&rdquo;. Таким образом, более-менее свежие версии, например, Microsoft Office будут обновляться через Windows Update вместе с ОС.</li>
</ul>
</li>
<li>:white_check_mark: <strong>Do not include drivers with Windows Updates</strong><br>
Не использовать драйвера в Windows Updates. Вот эта опция странная. Может я её не так понимаю, но при включении, Windows Updates всё равно ставит драйвера на устройства. А мне подобное обслуживание не надо.</li>
<li>:white_check_mark: <strong>No auto-restart with logged on users for scheduled automatic updates installations</strong><br>
Не использовать автоматическую перезагрузку при вошедшем в систему пользователе, когда обновления установились. Вот эта та самая автоматическая перезагрузка, которая попортила нервишки многим пользователям. Например, когда ты днём много работаешь, а на ночь ставишь компьютер считать различные данные, утром можно обнаружить окно готовности войти в систему. Да, установились обновления и компьютер перезагрузился. Включаем политику, тем самым отключая автоматическую перезагрузку.</li>
</ul>
<h2 id="user-details">
  <a class="link-body-emphasis" href="#user-details">User Details</a>
</h2><p>Секция отвечает за корректировку групповых политик под пользователей.</p>
<h3 id="windows-componentsattachment-manager">
  <a class="link-body-emphasis" href="#windows-componentsattachment-manager">Windows Components/Attachment Manager</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not preserve zone information in file attachments</strong><br>
Не сохранять информацию о зоне в файлах. Суть этой политики такова, что если я скачаю из Интернета, например, какой-нибудь EXE-файл, то файловая система пометит его как небезопасный. Лично мне в этом нет необходимости. Включаю политику.</li>
</ul>
<h3 id="windows-componentscloud-content-1">
  <a class="link-body-emphasis" href="#windows-componentscloud-content-1">Windows Components/Cloud Content</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off all Windows spotlight features</strong><br>
Отключить все возможности Windows Spotlight. Windows Spotlight эта функция ОС, которая позволяет отображать на экране входа в систему различную интерактивную информацию, например, сменяющиеся фоновые изображения, различные предложения (рекламные / не рекламные - не знаю, не видел ни разу). Мне это не надо, поэтому я включаю политику, запрещая использование Windows Spotlight.</li>
</ul>
<p>На этом всё. Возможно, некоторые параметры групповых политик покажутся спорными, а некоторые вообще странными и ненужными, но мне так удобно работать. Список будет дорабатываться, если найду что-нибудь ещё интересное.</p>]]></content:encoded><turbo:source/><turbo:topic>Windows 10: Настройка через групповые политики</turbo:topic><turbo:content><![CDATA[<p>Windows 10 до сих пор вызывает противоречивые чувства: иногда её поведение предсказуемо, иногда какое-нибудь обновление ломает систему, удаляя данные пользователя. И чтобы как-то улучшить положение дел и усмирить некоторые функции, я использую групповые политики в настройке операционной системы (ОС).</p>
<p>Сразу скажу, что мне нравится английский текст в интерфейсах. Поэтому все ОС у меня с интерфейсом в английской локализации, но я постараюсь максимально подробно описывать приведённые здесь групповые политики. Я использую Windows 10 в версии Enterprise, и не стоит забывать, что политики могут отличаться между различными версиями ОС.</p>
<p>Как открыть редактор групповых политик? Очень просто: необходимо нажать сочетание клавиш <span class="shortcode shortcode-key"><kbd>WIN + R</kbd></span>, откроется окно команды &ldquo;Выполнить&rdquo; и в текстовом поле набрать gpedit.msc и нажать <span class="shortcode shortcode-key"><kbd>OK</kbd></span>.</p>
<ul>
<li>:white_check_mark: - включить (разрешить).</li>
<li>:no_entry: - отключить (запретить).</li>
</ul>
<h2 id="computer-details">
  <a class="link-body-emphasis" href="#computer-details">Computer Details</a>
</h2><p>Секция отвечает за корректировку групповых политик компьютера в целом.</p>
<h3 id="systemdevice-installation">
  <a class="link-body-emphasis" href="#systemdevice-installation">System/Device Installation</a>
</h3><ul>
<li>:white_check_mark: <strong>Prevent device metadata retrieval from the Internet</strong><br>
Запретить использование мета-информации для подключённых устройств из Интернета. Политика отвечает за отображение индивидуальных значков принтеров, сканеров и такое прочее. Для отображения подобных значков, Windows лезет в Интернет и загружает мета-данные. Мне подобное не нужно, поэтому я включаю политику (включить = запретить).</li>
<li>:white_check_mark: <strong>Specify search order for device driver source locations</strong><br>
Специальный порядок источников для поиска драйверов в них. А вот эта политика отвечает за автоматическую установку драйверов на видеокарты, звуковые карты, различную периферию и прочее. Здесь можно указать ОС в каких источниках искать драйвера, приложения и прочее. Меня всегда раздражало, когда Windows при подключении к Интернету устанавливает устаревшие драйвера, например, на видеокарту. Зачем, когда я могу скачать свежие версии с сайта производителя? Включаю политику и выбираю опцию, указанную ниже.
<ul>
<li><em>Do not search Windows Update</em><br>
Не использовать Windows Update для поиска драйверов.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentsautoplay-policies">
  <a class="link-body-emphasis" href="#windows-componentsautoplay-policies">Windows Components/AutoPlay Policies</a>
</h3><ul>
<li>:white_check_mark: <em>Turn off Autoplay</em><br>
Отключить автоматический запуск. Политика позволяет отключить запуск подходящего приложения при втыкании, например, флешки с музыкой или картинками. Ранее (да и сейчас, наверно) таким способом любили запускаться злые вирусы. Включаю политику и выбираю опцию, указанную ниже.
<ul>
<li>All drives<br>
У меня отключено на всех устройствах.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentscloud-content">
  <a class="link-body-emphasis" href="#windows-componentscloud-content">Windows Components/Cloud Content</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not show Windows tips</strong><br>
Не показывать подсказки Windows. Лично мне подсказки ОС не нужны. Я как нибудь без них обойдусь. Включаю политику.</li>
<li>:white_check_mark: <strong>Turn off Microsoft consumer experiences</strong><br>
Выключить Microsoft Consumer Experience. Компания Microsoft своими рекомендациями навязывает установку таких приложений, как Candy Crush Soda Saga, FarmVille 2, Flipboard, Twitter, Photoshop Express, Minecraft и т.д. Мне они не нужны да и мне чуждо такое навязывание. Неприятно. Включаю политику, тем самым отключая подобную рекламу.</li>
</ul>
<h3 id="windows-componentsdata-collection-and-preview-builds">
  <a class="link-body-emphasis" href="#windows-componentsdata-collection-and-preview-builds">Windows Components/Data Collection and Preview Builds</a>
</h3><ul>
<li>:white_check_mark: <strong>Allow Telemetry</strong><br>
Разрешить телеметрию. Полностью телеметрию отключить всё равно не получится, что бы там не писали в Интернете. Поэтому, я включаю телеметрию и устанавливаю уровень сбора информации.
<ul>
<li><em>0 - Security [Enterprise Only]</em><br>
Ставлю нулевой уровень. Собирать данные, необходимые для осуществления безопасности. Но это только для операционной системы класса Enterprise.</li>
</ul>
</li>
</ul>
<h3 id="windows-componentsdesktop-gadgets">
  <a class="link-body-emphasis" href="#windows-componentsdesktop-gadgets">Windows Components/Desktop Gadgets</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off desktop gadgets</strong><br>
Выключить гаджеты рабочего стола. Актуально для Windows Vista / 7. В Windows 10 гаджетов не видел. Может потому что не использовал их никогда. Но политику включаю.</li>
</ul>
<h3 id="windows-componentsmicrosoft-defender-antivirus">
  <a class="link-body-emphasis" href="#windows-componentsmicrosoft-defender-antivirus">Windows Components/Microsoft Defender Antivirus</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off Microsoft Defender Antivirus</strong><br>
Отключить Microsoft Defender Antivirus. Я отключаю себе антивирус. Головы хватает, чтобы не подхватить вирусы. Использую только ограниченный проверенный набор программ. При этом, если необходимо запустить что-то экзотическое, у меня всегда развёрнута виртуальная машина в Hyper-V.</li>
</ul>
<h3 id="windows-componentsonedrive">
  <a class="link-body-emphasis" href="#windows-componentsonedrive">Windows Components/OneDrive</a>
</h3><ul>
<li>:white_check_mark: <strong>Prevent the usage of OneDrive for file storage</strong><br>
Запретить использование OneDrive как файловое хранилище. Мне не нужен OneDrive. Поэтому я запрещаю использование OneDrive в качестве хранилища файлов.</li>
</ul>
<h3 id="windows-componentssearch">
  <a class="link-body-emphasis" href="#windows-componentssearch">Windows Components/Search</a>
</h3><ul>
<li>:no_entry: <strong>Allow Cloud Search</strong><br>
Разрешить использование облачного поиска. Мне не нужен в ОС поиск, который будет искать по различным сайтам. Только локальный поиск. Поэтому, я запрещаю политику.</li>
<li>:no_entry: <strong>Allow Cortana</strong><br>
Разрешить Cortana. Cortana мне тоже не нужна. Мне не о чём с ней поговорить. Поэтому, я запрещаю Cortana.</li>
</ul>
<h3 id="windows-componentsstore">
  <a class="link-body-emphasis" href="#windows-componentsstore">Windows Components/Store</a>
</h3><ul>
<li>:white_check_mark: <strong>Disable all apps from Microsoft Store</strong><br>
Отключить все приложения из Microsoft Store. Для выпиливания приложений, установленных из Microsoft Store в Интернете гуляет скрипт на PowerShell. Но мне лень его использовать, да и мало ли что&hellip; Поэтому, я просто отключаю подобные приложения через групповые политики. Они остаются в меню Start, но не используются.</li>
<li>:white_check_mark: <strong>Turn off the Store application</strong><br>
Подобно представленной выше политике, эта отключает магазин приложений. Согласно описанию и Интернету, эта политика важнее предыдущей, и включение её отключает не только сам магазин, но и приложения из него.</li>
</ul>
<h3 id="windows-componentssync-your-settings">
  <a class="link-body-emphasis" href="#windows-componentssync-your-settings">Windows Components/Sync your settings</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not sync</strong><br>
Не синхронизировать настройки пользователя. Синхронизация настроек между устройствами мне не нужна. Я включаю политику, тем самым отключаю синхронизацию.</li>
</ul>
<h3 id="windows-componentswindows-game-recording-and-broadcasting">
  <a class="link-body-emphasis" href="#windows-componentswindows-game-recording-and-broadcasting">Windows Components/Windows Game Recording and Broadcasting</a>
</h3><ul>
<li>:no_entry: <strong>Enables or disables Windows Game Recording and Broadcasting</strong><br>
Включение или отключение функций Windows Game Recording и Broadcasting. Так как я не играю в игры, для меня подобная функциональность ОС избыточна. Отключаю политику.</li>
</ul>
<h3 id="windows-componentswindows-update">
  <a class="link-body-emphasis" href="#windows-componentswindows-update">Windows Components/Windows Update</a>
</h3><ul>
<li>:white_check_mark: <strong>Configure Automatic Updates</strong><br>
Конфигурация автоматического обновления. Ох, сколько в Интернете страданий по поводу обновлений Windows 10. При включении этой политике, я указываю опции, которые помогут избавится от ряда проблем с автоматическим обновлением.
<ul>
<li><strong>Configure automatic updating:</strong> <em>2 - Notify for download and auto install</em><br>
Я выбираю опцию #2, которая гласит как &ldquo;Информировать о выпуске новых обновлений&rdquo;.</li>
<li>:white_check_mark: <em>Install updates for other Microsoft products</em><br>
Также отмечаю галочкой опцию &ldquo;Устанавливать обновления для других продуктов Microsoft&rdquo;. Таким образом, более-менее свежие версии, например, Microsoft Office будут обновляться через Windows Update вместе с ОС.</li>
</ul>
</li>
<li>:white_check_mark: <strong>Do not include drivers with Windows Updates</strong><br>
Не использовать драйвера в Windows Updates. Вот эта опция странная. Может я её не так понимаю, но при включении, Windows Updates всё равно ставит драйвера на устройства. А мне подобное обслуживание не надо.</li>
<li>:white_check_mark: <strong>No auto-restart with logged on users for scheduled automatic updates installations</strong><br>
Не использовать автоматическую перезагрузку при вошедшем в систему пользователе, когда обновления установились. Вот эта та самая автоматическая перезагрузка, которая попортила нервишки многим пользователям. Например, когда ты днём много работаешь, а на ночь ставишь компьютер считать различные данные, утром можно обнаружить окно готовности войти в систему. Да, установились обновления и компьютер перезагрузился. Включаем политику, тем самым отключая автоматическую перезагрузку.</li>
</ul>
<h2 id="user-details">
  <a class="link-body-emphasis" href="#user-details">User Details</a>
</h2><p>Секция отвечает за корректировку групповых политик под пользователей.</p>
<h3 id="windows-componentsattachment-manager">
  <a class="link-body-emphasis" href="#windows-componentsattachment-manager">Windows Components/Attachment Manager</a>
</h3><ul>
<li>:white_check_mark: <strong>Do not preserve zone information in file attachments</strong><br>
Не сохранять информацию о зоне в файлах. Суть этой политики такова, что если я скачаю из Интернета, например, какой-нибудь EXE-файл, то файловая система пометит его как небезопасный. Лично мне в этом нет необходимости. Включаю политику.</li>
</ul>
<h3 id="windows-componentscloud-content-1">
  <a class="link-body-emphasis" href="#windows-componentscloud-content-1">Windows Components/Cloud Content</a>
</h3><ul>
<li>:white_check_mark: <strong>Turn off all Windows spotlight features</strong><br>
Отключить все возможности Windows Spotlight. Windows Spotlight эта функция ОС, которая позволяет отображать на экране входа в систему различную интерактивную информацию, например, сменяющиеся фоновые изображения, различные предложения (рекламные / не рекламные - не знаю, не видел ни разу). Мне это не надо, поэтому я включаю политику, запрещая использование Windows Spotlight.</li>
</ul>
<p>На этом всё. Возможно, некоторые параметры групповых политик покажутся спорными, а некоторые вообще странными и ненужными, но мне так удобно работать. Список будет дорабатываться, если найду что-нибудь ещё интересное.</p>]]></turbo:content><pubDate>Tue, 21 Jul 2020 21:15:37 +0000</pubDate><category>MS Windows</category></item></channel></rss>