<?xml version="1.0" encoding="UTF-8" standalone="yes"?><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" xmlns:yandex="http://news.yandex.ru" xmlns:turbo="http://turbo.yandex.ru"><channel><title>Сеть / Library Online</title><link>https://lib.onl/ru/categories/network/</link><description>Работа с сетью. Статьи и инструкции по сетевому администрированию.</description><language>ru-RU</language><sy:updatePeriod>weekly</sy:updatePeriod><sy:updateFrequency>1</sy:updateFrequency><image><link>https://lib.onl/ru/categories/network/</link><url>https://lib.onl/favicon-128.png</url><width>128</width><height>128</height><title>Сеть / Library Online</title><description>Работа с сетью. Статьи и инструкции по сетевому администрированию.</description></image><lastBuildDate>Thu, 19 Oct 2023 08:56:43 +0000</lastBuildDate><atom:link href="https://lib.onl/ru/categories/network/index.xml" rel="self" type="application/rss+xml"/><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Добавление корневых сертификатов в RouterOS</title><link>https://lib.onl/ru/posts/2023/10/cc13623b-970c-5950-867e-168f9ba9025a/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2023/10/cc13623b-970c-5950-867e-168f9ba9025a/</guid><description>Репозиторий корневых сертификатов необходим для того, чтобы RouterOS имела представление какие вообще центры сертификации существуют.</description><media:content medium="image" url="https://images.unsplash.com/photo-1554098415-4052459dc340" width="1600" height="900"/><content:encoded><![CDATA[<p>Репозиторий корневых сертификатов необходим для того, чтобы RouterOS имела представление какие вообще центры сертификации существуют.</p>
<p>Если репозиторий заполнен корневыми сертификатами центров сертификации, RouterOS сможет проверять подлинность выданных этими центрами сертификатов, работать с DNS over HTTPS (DoH) и делать другую работу, связанную с шифрованием данных.</p>
<h2 id="загрузка-базы-сертификатов">
  <a class="link-body-emphasis" href="#%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-%d0%b1%d0%b0%d0%b7%d1%8b-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2">Загрузка базы сертификатов</a>
</h2><p>Файл <a title="" href="https://curl.se/docs/caextract.html" target="_blank" rel="noopener noreferrer nofollow">cacert.pem</a> с сайта <a title="" href="https://curl.se/" target="_blank" rel="noopener noreferrer nofollow">curl.se</a> переодически обновляется и содержит в себе корневые сертификаты центров сертификации. Откроем терминал в RouterOS и скачаем сразу на роутер командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-ca2ecdb75614ff6d29727afa3be16e50"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/tool fetch url=&#34;https://curl.se/ca/cacert.pem&#34; dst-path=&#34;ros.cacert.pem&#34;</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-ca2ecdb75614ff6d29727afa3be16e50"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>url</code> - URL файла, который необходимо скачать.</li>
<li><code>dst-path</code> - название, под которым файл сохранится на роутере. Я добавляю префикс <code>ros.</code>, чтобы знать, что этот файл важен для RouterOS.</li>
</ul>
<h2 id="импортирование-сертификатов-в-репозиторий">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bc%d0%bf%d0%be%d1%80%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2-%d0%b2-%d1%80%d0%b5%d0%bf%d0%be%d0%b7%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%b9">Импортирование сертификатов в репозиторий</a>
</h2><p>Теперь когда файл на роутере, нужно импортировать его содержимое в репозиторий сертификатов. Делается это следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-92da21953074a0fbbefd7b152c163119"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/certificate import file-name=&#34;ros.cacert.pem&#34; passphrase=&#34;&#34; name=&#34;ROS&#34;</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-92da21953074a0fbbefd7b152c163119"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>file-name</code> - название файла на  роутере.</li>
<li><code>name</code> - название, под которым сертификаты будут обозначаться в репозитории сертификатов. Здесь тоже я указываю <code>ROS</code>, чтобы знать, что сертификаты импортировались вручную. Вы можете ввести любое своё название, главное, чтобы оно для вас что-то обозначало.</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Параметр <code>name</code> можно не указывать, тогда при импорте сертификатов, RouterOS в этот параметр автоматически подставит название файла.</p>

    </div>
  </div>
</div>]]></content:encoded><turbo:source/><turbo:topic>Добавление корневых сертификатов в RouterOS</turbo:topic><turbo:content><![CDATA[<p>Репозиторий корневых сертификатов необходим для того, чтобы RouterOS имела представление какие вообще центры сертификации существуют.</p>
<p>Если репозиторий заполнен корневыми сертификатами центров сертификации, RouterOS сможет проверять подлинность выданных этими центрами сертификатов, работать с DNS over HTTPS (DoH) и делать другую работу, связанную с шифрованием данных.</p>
<h2 id="загрузка-базы-сертификатов">
  <a class="link-body-emphasis" href="#%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-%d0%b1%d0%b0%d0%b7%d1%8b-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2">Загрузка базы сертификатов</a>
</h2><p>Файл <a title="" href="https://curl.se/docs/caextract.html" target="_blank" rel="noopener noreferrer nofollow">cacert.pem</a> с сайта <a title="" href="https://curl.se/" target="_blank" rel="noopener noreferrer nofollow">curl.se</a> переодически обновляется и содержит в себе корневые сертификаты центров сертификации. Откроем терминал в RouterOS и скачаем сразу на роутер командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-ca2ecdb75614ff6d29727afa3be16e50"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/tool fetch url=&#34;https://curl.se/ca/cacert.pem&#34; dst-path=&#34;ros.cacert.pem&#34;</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-ca2ecdb75614ff6d29727afa3be16e50"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>url</code> - URL файла, который необходимо скачать.</li>
<li><code>dst-path</code> - название, под которым файл сохранится на роутере. Я добавляю префикс <code>ros.</code>, чтобы знать, что этот файл важен для RouterOS.</li>
</ul>
<h2 id="импортирование-сертификатов-в-репозиторий">
  <a class="link-body-emphasis" href="#%d0%b8%d0%bc%d0%bf%d0%be%d1%80%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2-%d0%b2-%d1%80%d0%b5%d0%bf%d0%be%d0%b7%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%b9">Импортирование сертификатов в репозиторий</a>
</h2><p>Теперь когда файл на роутере, нужно импортировать его содержимое в репозиторий сертификатов. Делается это следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-text">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-92da21953074a0fbbefd7b152c163119"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/certificate import file-name=&#34;ros.cacert.pem&#34; passphrase=&#34;&#34; name=&#34;ROS&#34;</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-92da21953074a0fbbefd7b152c163119"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Где:</p>
<ul>
<li><code>file-name</code> - название файла на  роутере.</li>
<li><code>name</code> - название, под которым сертификаты будут обозначаться в репозитории сертификатов. Здесь тоже я указываю <code>ROS</code>, чтобы знать, что сертификаты импортировались вручную. Вы можете ввести любое своё название, главное, чтобы оно для вас что-то обозначало.</li>
</ul>






    
    








<div class="shortcode shortcode-alert">
  <div class="alert alert-success d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-lightbulb fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Параметр <code>name</code> можно не указывать, тогда при импорте сертификатов, RouterOS в этот параметр автоматически подставит название файла.</p>

    </div>
  </div>
</div>]]></turbo:content><pubDate>Thu, 19 Oct 2023 08:56:43 +0000</pubDate><category>Сеть</category><category>Безопасность</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Включение DNS over TLS (DoT) в OPNsense</title><link>https://lib.onl/ru/posts/2022/08/badb30a9-0471-5dab-a422-85422c0ac611/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2022/08/badb30a9-0471-5dab-a422-85422c0ac611/</guid><description>Почитав несколько статей на тему DoT, я решил написать небольшую заметку по настройки OPNsense на использование этого протокола.</description><media:content medium="image" url="https://images.unsplash.com/photo-1521106047354-5a5b85e819ee" width="1600" height="900"/><content:encoded><![CDATA[<p>Почитав несколько статей на тему DoT, я решил написать небольшую заметку по настройки OPNsense на использование этого протокола.</p>
<p><strong>DNS поверх TLS</strong> или <strong>DoT</strong> это протокол, при помощи которого происходит шифрование запросов и ответов к DNS через TLS. Таким образом, повышается конфиденциальность и безопасность пользователей в интернете.</p>
<p>Не все публичные сервера поддерживают DoT. Список наиболее предпочтительных, по моему мнению, я приведу в таблице в конце статьи. А теперь, по пунктам, я расскажу как правильно настроить OPNsense, чтобы она задействовала протокол DoT в своей работе. Для этого нужно выполнить всего несколько шагов&hellip;</p>
<h2 id="настройка-opnsense">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-opnsense">Настройка OPNsense</a>
</h2><ul>
<li>System / Settings / General
<ul>
<li>Отключить параметр <strong>Do not use the local DNS service as a nameserver for this system</strong>.</li>
</ul>
</li>
<li>Services / DHCPv4 / [LAN]
<ul>
<li>Удалить все записи о DNS, если они имеются.</li>
</ul>
</li>
<li>Services / Unbound DNS / General
<ul>
<li>Включить сервис, поставив галочку напротив <strong>Enable</strong>.</li>
<li>Выбрать в параметре <strong>Network Interfaces</strong> пункт локальной сети, в данном случае, <em>LAN</em>.</li>
<li>Включить <strong>DNSSEC</strong>, поставив галочку напротив парамера <strong>Enable DNSSEC Support</strong>.</li>
<li>Остальные параметры можно выключить.</li>
</ul>
</li>
<li>Services / Unbound DNS / DNS over TLS
<ul>
<li>Добавить публичные сервера DNS из списка ниже.</li>
</ul>
</li>
</ul>
<h2 id="публичные-сервера-dns">
  <a class="link-body-emphasis" href="#%d0%bf%d1%83%d0%b1%d0%bb%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0-dns">Публичные сервера DNS</a>
</h2><p>Ниже я привожу список публичных серверов DNS, которые поддерживают функцию DNS over TLS (DoT).</p>
<h3 id="cloudflare">
  <a class="link-body-emphasis" href="#cloudflare">Cloudflare</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1.1.1</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>1.0.0.1</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>2606:4700:4700::1111</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>2606:4700:4700::1001</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
</tbody>
</table>


<h3 id="google">
  <a class="link-body-emphasis" href="#google">Google</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.8.8.8</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>8.8.4.4</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>2001:4860:4860::8888</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>2001:4860:4860::8844</td>
<td>853</td>
<td>dns.google</td>
</tr>
</tbody>
</table>


<h3 id="quad9">
  <a class="link-body-emphasis" href="#quad9">Quad9</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.9.9.9</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>149.112.112.112</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>2620:fe::fe</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>2620:fe::9</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
</tbody>
</table>


<h3 id="cisco-umbrella">
  <a class="link-body-emphasis" href="#cisco-umbrella">Cisco Umbrella</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>208.67.222.222</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>208.67.220.220</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>2620:119:35::35</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>2620:119:53::53</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
</tbody>
</table>


<h3 id="cleanbrowsing">
  <a class="link-body-emphasis" href="#cleanbrowsing">CleanBrowsing</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>185.228.168.9</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>185.228.169.9</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>2a0d:2a00:1::2</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>2a0d:2a00:2::2</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
</tbody>
</table>


<h3 id="adguard-dns">
  <a class="link-body-emphasis" href="#adguard-dns">AdGuard DNS</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>94.140.14.14</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>94.140.15.15</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>2a10:50c0::ad1:ff</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>2a10:50c0::ad2:ff</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
</tbody>
</table>]]></content:encoded><turbo:source/><turbo:topic>Включение DNS over TLS (DoT) в OPNsense</turbo:topic><turbo:content><![CDATA[<p>Почитав несколько статей на тему DoT, я решил написать небольшую заметку по настройки OPNsense на использование этого протокола.</p>
<p><strong>DNS поверх TLS</strong> или <strong>DoT</strong> это протокол, при помощи которого происходит шифрование запросов и ответов к DNS через TLS. Таким образом, повышается конфиденциальность и безопасность пользователей в интернете.</p>
<p>Не все публичные сервера поддерживают DoT. Список наиболее предпочтительных, по моему мнению, я приведу в таблице в конце статьи. А теперь, по пунктам, я расскажу как правильно настроить OPNsense, чтобы она задействовала протокол DoT в своей работе. Для этого нужно выполнить всего несколько шагов&hellip;</p>
<h2 id="настройка-opnsense">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-opnsense">Настройка OPNsense</a>
</h2><ul>
<li>System / Settings / General
<ul>
<li>Отключить параметр <strong>Do not use the local DNS service as a nameserver for this system</strong>.</li>
</ul>
</li>
<li>Services / DHCPv4 / [LAN]
<ul>
<li>Удалить все записи о DNS, если они имеются.</li>
</ul>
</li>
<li>Services / Unbound DNS / General
<ul>
<li>Включить сервис, поставив галочку напротив <strong>Enable</strong>.</li>
<li>Выбрать в параметре <strong>Network Interfaces</strong> пункт локальной сети, в данном случае, <em>LAN</em>.</li>
<li>Включить <strong>DNSSEC</strong>, поставив галочку напротив парамера <strong>Enable DNSSEC Support</strong>.</li>
<li>Остальные параметры можно выключить.</li>
</ul>
</li>
<li>Services / Unbound DNS / DNS over TLS
<ul>
<li>Добавить публичные сервера DNS из списка ниже.</li>
</ul>
</li>
</ul>
<h2 id="публичные-сервера-dns">
  <a class="link-body-emphasis" href="#%d0%bf%d1%83%d0%b1%d0%bb%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0-dns">Публичные сервера DNS</a>
</h2><p>Ниже я привожу список публичных серверов DNS, которые поддерживают функцию DNS over TLS (DoT).</p>
<h3 id="cloudflare">
  <a class="link-body-emphasis" href="#cloudflare">Cloudflare</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1.1.1</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>1.0.0.1</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>2606:4700:4700::1111</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
<tr>
<td>2606:4700:4700::1001</td>
<td>853</td>
<td>cloudflare-dns.com</td>
</tr>
</tbody>
</table>


<h3 id="google">
  <a class="link-body-emphasis" href="#google">Google</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.8.8.8</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>8.8.4.4</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>2001:4860:4860::8888</td>
<td>853</td>
<td>dns.google</td>
</tr>
<tr>
<td>2001:4860:4860::8844</td>
<td>853</td>
<td>dns.google</td>
</tr>
</tbody>
</table>


<h3 id="quad9">
  <a class="link-body-emphasis" href="#quad9">Quad9</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.9.9.9</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>149.112.112.112</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>2620:fe::fe</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
<tr>
<td>2620:fe::9</td>
<td>853</td>
<td>dns.quad9.net</td>
</tr>
</tbody>
</table>


<h3 id="cisco-umbrella">
  <a class="link-body-emphasis" href="#cisco-umbrella">Cisco Umbrella</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>208.67.222.222</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>208.67.220.220</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>2620:119:35::35</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
<tr>
<td>2620:119:53::53</td>
<td>853</td>
<td>dns.opendns.com</td>
</tr>
</tbody>
</table>


<h3 id="cleanbrowsing">
  <a class="link-body-emphasis" href="#cleanbrowsing">CleanBrowsing</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>185.228.168.9</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>185.228.169.9</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>2a0d:2a00:1::2</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
<tr>
<td>2a0d:2a00:2::2</td>
<td>853</td>
<td>security-filter-dns.cleanbrowsing.org</td>
</tr>
</tbody>
</table>


<h3 id="adguard-dns">
  <a class="link-body-emphasis" href="#adguard-dns">AdGuard DNS</a>
</h3>




<table class='table table-striped table-bordered table-responsive w-50'>
<thead>
<tr>
<th>Server IP</th>
<th>Server Port</th>
<th>Verify CN</th>
</tr>
</thead>
<tbody>
<tr>
<td>94.140.14.14</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>94.140.15.15</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>2a10:50c0::ad1:ff</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
<tr>
<td>2a10:50c0::ad2:ff</td>
<td>853</td>
<td>dns.adguard-dns.com</td>
</tr>
</tbody>
</table>]]></turbo:content><pubDate>Sun, 14 Aug 2022 18:16:34 +0000</pubDate><category>Сеть</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>Настройка статического IP адреса</title><link>https://lib.onl/ru/posts/2021/05/ee559a6c-5cde-5166-9d2d-3ceb55878eb8/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2021/05/ee559a6c-5cde-5166-9d2d-3ceb55878eb8/</guid><description>Рассмотрим различные способы настройки статического IP адреса в дистрибутивах Linux. Способы различаются в зависимости от пакетной базы дистрибутивов. Например, настройка статического IP в RHEL-based дистрибутиве будет отличаться от настройки в DEB-based дистрибутиве.</description><media:content medium="image" url="https://images.unsplash.com/photo-1544197150-b99a580bb7a8" width="1600" height="900"/><content:encoded><![CDATA[<p>Рассмотрим различные способы настройки статического IP адреса в дистрибутивах Linux. Способы различаются в зависимости от пакетной базы дистрибутивов. Например, настройка статического IP в RHEL-based дистрибутиве будет отличаться от настройки в DEB-based дистрибутиве.</p>
<h2 id="подготовка">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0">Подготовка</a>
</h2><p>Смотрим текущие сетевые устройства и соединения:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-171e5e78a549a221047268657306ebe1"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-171e5e78a549a221047268657306ebe1"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">ip a

1: lo: &lt;loopback,up,lower_up&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
  link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
  inet 127.0.0.1/8 scope host lo
2: enp1s0: &lt;broadcast,multicast,up,lower_up&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
  link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
  inet 192.168.10.123/24 brd 192.168.10.255 scope global dynamic noprefixroute enp1s0</code></pre></div>
  </div>
</div>
<h2 id="настройка-ip-в-rhel-based-дистрибутивах">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-ip-%d0%b2-rhel-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d0%b0%d1%85">Настройка IP в RHEL-based дистрибутивах</a>
</h2><p>В директории <code>/etc/sysconfig/network-scripts</code> находятся конфигурационные файлы для сетевых интерфейсов. Имя файла состоит из префикса <code>ifcfg</code> и имени интерфейса. Например, содержимое файла для интерфейса <code>enp1s0</code>:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-4053814bed386a3799501644db579f6a"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-4053814bed386a3799501644db579f6a"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">cat /etc/sysconfig/network-scripts/ifcfg-enp1s0

TYPE=&#34;Ethernet&#34;
PROXY_METHOD=&#34;none&#34;
BROWSER_ONLY=&#34;no&#34;
BOOTPROTO=&#34;dhcp&#34;
DEFROUTE=&#34;yes&#34;
IPV4_FAILURE_FATAL=&#34;no&#34;
IPV6INIT=&#34;yes&#34;
IPV6_AUTOCONF=&#34;yes&#34;
IPV6_DEFROUTE=&#34;yes&#34;
IPV6_FAILURE_FATAL=&#34;no&#34;
IPV6_ADDR_GEN_MODE=&#34;stable-privacy&#34;
NAME=&#34;enp1s0&#34;
UUID=&#34;&lt;DEVICE_ID&gt;&#34;
DEVICE=&#34;enp1s0&#34;
ONBOOT=&#34;yes&#34;</code></pre></div>
  </div>
</div>
<p>Обратим внимание на опцию <strong>BOOTPROTO</strong>. По умолчанию, в опции <strong>BOOTPROTO</strong> прописано <code>dhcp</code>. Это означает, что сетевой интерфейс получает информацию о сети автоматически от DHCP. Сама опция <strong>BOOTPROTO</strong> может принимать следующие значения:</p>
<ul>
<li><code>none</code> – не использовать протокол.</li>
<li><code>bootp</code> – использование протокола <strong>bootp</strong>.</li>
<li><code>dhcp</code> – использование протокола <strong>dhcp</strong> (по умолчанию).</li>
</ul>
<p>Для настройки статического IP необходимо установит <strong>BOOTPROTO</strong> в <code>none</code> и дописать в конец файла опции:</p>
<ul>
<li><code>IPADDR</code> - IP адрес.</li>
<li><code>PREFIX</code> - маска сети.</li>
<li><code>GATEWAY</code> - шлюз сети.</li>
<li><code>DNS</code> - серверы DNS.</li>
</ul>
<p>Например:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-ini">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-07dc15c2fb9eb6f911ea5b146fd1c58d"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">TYPE</span><span class="o">=</span><span class="s">&#34;Ethernet&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">PROXY_METHOD</span><span class="o">=</span><span class="s">&#34;none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">BROWSER_ONLY</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">BOOTPROTO</span><span class="o">=</span><span class="s">&#34;none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DEFROUTE</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV4_FAILURE_FATAL</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6INIT</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_AUTOCONF</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_DEFROUTE</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_FAILURE_FATAL</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_ADDR_GEN_MODE</span><span class="o">=</span><span class="s">&#34;stable-privacy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">NAME</span><span class="o">=</span><span class="s">&#34;enp1s0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">UUID</span><span class="o">=</span><span class="s">&#34;&lt;DEVICE_ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DEVICE</span><span class="o">=</span><span class="s">&#34;enp1s0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">ONBOOT</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPADDR</span><span class="o">=</span><span class="s">&#34;192.168.10.55&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">PREFIX</span><span class="o">=</span><span class="s">&#34;24&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">GATEWAY</span><span class="o">=</span><span class="s">&#34;192.168.10.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS1</span><span class="o">=</span><span class="s">&#34;192.168.11.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS1</span><span class="o">=</span><span class="s">&#34;192.168.12.1&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-07dc15c2fb9eb6f911ea5b146fd1c58d"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>После указания всех параметров, необходимо перезапустить интерфейс:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-be8e05de4a245251509bca0c4cb6a81a"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-be8e05de4a245251509bca0c4cb6a81a"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con down enp1s0 &amp;&amp; nmcli con up enp1s0</code></pre></div>
  </div>
</div>
<h2 id="настройка-ip-при-помощи-network-manager-cli-nmcli">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-ip-%d0%bf%d1%80%d0%b8-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d0%b8-network-manager-cli-nmcli">Настройка IP при помощи Network Manager CLI (nmcli)</a>
</h2><p>Установка IP адреса:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-925b663b64c6434d5b3ccfd68bf7ffcc"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-925b663b64c6434d5b3ccfd68bf7ffcc"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.addresses &#39;192.168.10.55/24&#39;</code></pre></div>
  </div>
</div>
<p>Установка шлюза:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f76eca25044b7b90007a8e6cc2536b13"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-f76eca25044b7b90007a8e6cc2536b13"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.gateway &#39;192.168.10.1&#39;</code></pre></div>
  </div>
</div>
<p>Установка DNS:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a9e618362da66c83af8fe71ed34a9164"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-a9e618362da66c83af8fe71ed34a9164"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.dns &#39;192.168.11.1&#39;</code></pre></div>
  </div>
</div>
<p>Установка <strong>BOOTPROTO</strong> в <code>none</code>:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-55cd5e35cf6c023224efbd0b7d901182"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-55cd5e35cf6c023224efbd0b7d901182"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.method &#39;manual&#39;</code></pre></div>
  </div>
</div>
<p>Перезапуск интерфейса:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-2806c37101f3f20ead03f75297d17ed4"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-2806c37101f3f20ead03f75297d17ed4"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con down enp1s0 &amp;&amp; nmcli con up enp1s0</code></pre></div>
  </div>
</div>]]></content:encoded><turbo:source/><turbo:topic>Настройка статического IP адреса</turbo:topic><turbo:content><![CDATA[<p>Рассмотрим различные способы настройки статического IP адреса в дистрибутивах Linux. Способы различаются в зависимости от пакетной базы дистрибутивов. Например, настройка статического IP в RHEL-based дистрибутиве будет отличаться от настройки в DEB-based дистрибутиве.</p>
<h2 id="подготовка">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0">Подготовка</a>
</h2><p>Смотрим текущие сетевые устройства и соединения:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-171e5e78a549a221047268657306ebe1"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-171e5e78a549a221047268657306ebe1"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">ip a

1: lo: &lt;loopback,up,lower_up&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
  link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
  inet 127.0.0.1/8 scope host lo
2: enp1s0: &lt;broadcast,multicast,up,lower_up&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
  link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
  inet 192.168.10.123/24 brd 192.168.10.255 scope global dynamic noprefixroute enp1s0</code></pre></div>
  </div>
</div>
<h2 id="настройка-ip-в-rhel-based-дистрибутивах">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-ip-%d0%b2-rhel-based-%d0%b4%d0%b8%d1%81%d1%82%d1%80%d0%b8%d0%b1%d1%83%d1%82%d0%b8%d0%b2%d0%b0%d1%85">Настройка IP в RHEL-based дистрибутивах</a>
</h2><p>В директории <code>/etc/sysconfig/network-scripts</code> находятся конфигурационные файлы для сетевых интерфейсов. Имя файла состоит из префикса <code>ifcfg</code> и имени интерфейса. Например, содержимое файла для интерфейса <code>enp1s0</code>:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-4053814bed386a3799501644db579f6a"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-4053814bed386a3799501644db579f6a"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">cat /etc/sysconfig/network-scripts/ifcfg-enp1s0

TYPE=&#34;Ethernet&#34;
PROXY_METHOD=&#34;none&#34;
BROWSER_ONLY=&#34;no&#34;
BOOTPROTO=&#34;dhcp&#34;
DEFROUTE=&#34;yes&#34;
IPV4_FAILURE_FATAL=&#34;no&#34;
IPV6INIT=&#34;yes&#34;
IPV6_AUTOCONF=&#34;yes&#34;
IPV6_DEFROUTE=&#34;yes&#34;
IPV6_FAILURE_FATAL=&#34;no&#34;
IPV6_ADDR_GEN_MODE=&#34;stable-privacy&#34;
NAME=&#34;enp1s0&#34;
UUID=&#34;&lt;DEVICE_ID&gt;&#34;
DEVICE=&#34;enp1s0&#34;
ONBOOT=&#34;yes&#34;</code></pre></div>
  </div>
</div>
<p>Обратим внимание на опцию <strong>BOOTPROTO</strong>. По умолчанию, в опции <strong>BOOTPROTO</strong> прописано <code>dhcp</code>. Это означает, что сетевой интерфейс получает информацию о сети автоматически от DHCP. Сама опция <strong>BOOTPROTO</strong> может принимать следующие значения:</p>
<ul>
<li><code>none</code> – не использовать протокол.</li>
<li><code>bootp</code> – использование протокола <strong>bootp</strong>.</li>
<li><code>dhcp</code> – использование протокола <strong>dhcp</strong> (по умолчанию).</li>
</ul>
<p>Для настройки статического IP необходимо установит <strong>BOOTPROTO</strong> в <code>none</code> и дописать в конец файла опции:</p>
<ul>
<li><code>IPADDR</code> - IP адрес.</li>
<li><code>PREFIX</code> - маска сети.</li>
<li><code>GATEWAY</code> - шлюз сети.</li>
<li><code>DNS</code> - серверы DNS.</li>
</ul>
<p>Например:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-ini">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-07dc15c2fb9eb6f911ea5b146fd1c58d"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">TYPE</span><span class="o">=</span><span class="s">&#34;Ethernet&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">PROXY_METHOD</span><span class="o">=</span><span class="s">&#34;none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">BROWSER_ONLY</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">BOOTPROTO</span><span class="o">=</span><span class="s">&#34;none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DEFROUTE</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV4_FAILURE_FATAL</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6INIT</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_AUTOCONF</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_DEFROUTE</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_FAILURE_FATAL</span><span class="o">=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPV6_ADDR_GEN_MODE</span><span class="o">=</span><span class="s">&#34;stable-privacy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">NAME</span><span class="o">=</span><span class="s">&#34;enp1s0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">UUID</span><span class="o">=</span><span class="s">&#34;&lt;DEVICE_ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DEVICE</span><span class="o">=</span><span class="s">&#34;enp1s0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">ONBOOT</span><span class="o">=</span><span class="s">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">IPADDR</span><span class="o">=</span><span class="s">&#34;192.168.10.55&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">PREFIX</span><span class="o">=</span><span class="s">&#34;24&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">GATEWAY</span><span class="o">=</span><span class="s">&#34;192.168.10.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS1</span><span class="o">=</span><span class="s">&#34;192.168.11.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">DNS1</span><span class="o">=</span><span class="s">&#34;192.168.12.1&#34;</span></span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-07dc15c2fb9eb6f911ea5b146fd1c58d"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>После указания всех параметров, необходимо перезапустить интерфейс:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-be8e05de4a245251509bca0c4cb6a81a"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-be8e05de4a245251509bca0c4cb6a81a"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con down enp1s0 &amp;&amp; nmcli con up enp1s0</code></pre></div>
  </div>
</div>
<h2 id="настройка-ip-при-помощи-network-manager-cli-nmcli">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-ip-%d0%bf%d1%80%d0%b8-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d0%b8-network-manager-cli-nmcli">Настройка IP при помощи Network Manager CLI (nmcli)</a>
</h2><p>Установка IP адреса:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-925b663b64c6434d5b3ccfd68bf7ffcc"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-925b663b64c6434d5b3ccfd68bf7ffcc"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.addresses &#39;192.168.10.55/24&#39;</code></pre></div>
  </div>
</div>
<p>Установка шлюза:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-f76eca25044b7b90007a8e6cc2536b13"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-f76eca25044b7b90007a8e6cc2536b13"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.gateway &#39;192.168.10.1&#39;</code></pre></div>
  </div>
</div>
<p>Установка DNS:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-a9e618362da66c83af8fe71ed34a9164"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-a9e618362da66c83af8fe71ed34a9164"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.dns &#39;192.168.11.1&#39;</code></pre></div>
  </div>
</div>
<p>Установка <strong>BOOTPROTO</strong> в <code>none</code>:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-55cd5e35cf6c023224efbd0b7d901182"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-55cd5e35cf6c023224efbd0b7d901182"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con mod enp1s0 ipv4.method &#39;manual&#39;</code></pre></div>
  </div>
</div>
<p>Перезапуск интерфейса:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux-root">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 text-danger">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-2806c37101f3f20ead03f75297d17ed4"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-2806c37101f3f20ead03f75297d17ed4"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">nmcli con down enp1s0 &amp;&amp; nmcli con up enp1s0</code></pre></div>
  </div>
</div>]]></turbo:content><pubDate>Sat, 15 May 2021 17:08:30 +0000</pubDate><category>Терминал</category><category>Linux</category><category>Сеть</category><category>В доработке</category></item><item turbo="true"><turbo:extendedHtml>true</turbo:extendedHtml><title>MikroTik и CloudFlare: Динамический IP для домена</title><link>https://lib.onl/ru/posts/2020/07/ff2ae66e-8e14-5c4a-baa6-0cd2e59f6517/</link><dc:creator>Kitsune Solar</dc:creator><guid isPermaLink="true">https://lib.onl/ru/posts/2020/07/ff2ae66e-8e14-5c4a-baa6-0cd2e59f6517/</guid><description>Нашёл скрипт реализации динамической смены IP адреса из RouterOS напрямую в панели управления CloudFlare при помощи API. Где нашёл скрипт уже не помню, вроде бы на страницах официального форума MikroTik.</description><media:content medium="image" url="https://images.unsplash.com/photo-1521542464131-cb30f7398bc6" width="1600" height="900"/><content:encoded><![CDATA[<p>Нашёл скрипт реализации динамической смены IP адреса из RouterOS напрямую в панели управления CloudFlare при помощи API. Где нашёл скрипт уже не помню, вроде бы на страницах официального форума MikroTik.</p>
<p>Скрипт я немного переделал, удалил лишние переменные, некоторые переопределил, подправил области видимости переменных, обновил метод авторизации скрипта на серверах CloudFlare. Вроде работает.</p>
<p>Сам скрипт нужно настроить под себя, прописав в нём значения переменных. Некоторые значений можно узнать из панели управления доменом в CloudFlare, но для получения значения переменной <code>cfDnsID</code> необходимо выполнит немного телодвижений. Об этом ниже.</p>
<h2 id="работа-cloudflare-api">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0-cloudflare-api">Работа CloudFlare API</a>
</h2><p>Без токена - никак.</p>
<h3 id="создание-токена">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d0%b0">Создание токена</a>
</h3><p>Для того, чтобы начать работать с CloudFlare API, нам нужно создать специальный токен:</p>
<ol>
<li>Зайти в <a title="" href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer nofollow">панель управления токенами</a>.</li>
<li>Нажать кнопку <span class="shortcode shortcode-key"><kbd>Create Token</kbd></span>.</li>
<li>На странице выбора шаблонов - выбрать шаблон <strong>Edit zone DNS</strong>.</li>
<li>В разделе <strong>Zone Resources</strong> можно выбрать область доступа токена к зонам (доменам). Можно указать конкретную зону (<em>Specific zone</em>) или выбрать все зоны (<em>All zones</em>).</li>
<li>Всё, нажимаем кнопку <span class="shortcode shortcode-key"><kbd>Continue to summary</kbd></span> и перемещаемся на следующую станицу&hellip;</li>
</ol>
<h3 id="проверка-токена">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d0%b0">Проверка токена</a>
</h3><p>По окончании создания токена, CloudFlare переместит нас на страницу проверки токена. На этой странице будут наш созданный токен (его необходимо сохранить) и команда, которой при помощи утилиты <code>curl</code> можно проверить корректность токена:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-6aab74748047944d8be3292d3bca6079"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X GET <span class="s2">&#34;https://api.cloudflare.com/client/v4/user/tokens/verify&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Authorization: Bearer TOKEN&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Content-Type:application/json&#34;</span> <span class="p">|</span> python3 -mjson.tool</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-6aab74748047944d8be3292d3bca6079"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>При выполнении, команда вернёт следующий результат:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8c556f6963af3c20dd338a596c5d3ee7"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-8c556f6963af3c20dd338a596c5d3ee7"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">curl -X GET &#34;https://api.cloudflare.com/client/v4/user/tokens/verify&#34; -H &#34;Authorization: Bearer &lt;...&gt;&#34; -H &#34;Content-Type: application/json&#34; | python3 -mjson.tool

{
    &#34;result&#34;: {
        &#34;id&#34;: &#34;&lt;...&gt;&#34;,
        &#34;status&#34;: &#34;active&#34;
    },
    &#34;success&#34;: true,
    &#34;errors&#34;: [],
    &#34;messages&#34;: [
        {
            &#34;code&#34;: 10000,
            &#34;message&#34;: &#34;This API Token is valid and active&#34;,
            &#34;type&#34;: null
        }
    ]
}</code></pre></div>
  </div>
</div>
<p>По сообщению &ldquo;This API Token is valid and active&rdquo; понятно, что токен корректный и работает.</p>
<h3 id="получение-id-ресурсной-записи-домена">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-id-%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%bd%d0%be%d0%b9-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d0%b8-%d0%b4%d0%be%d0%bc%d0%b5%d0%bd%d0%b0">Получение ID ресурсной записи домена</a>
</h3><p>Когда у нас есть токен, можно полноценно работать с CloudFlare API. Нам нужно получить ID ресурсной записи домена. Получать будем следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-96069c97a166b6c198f96fffabf34561"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X GET <span class="s2">&#34;https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Authorization: Bearer TOKEN&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="p">|</span> python3 -mjson.tool</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-96069c97a166b6c198f96fffabf34561"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Обратите внимание на следующие заглушки в команде:</p>
<ul>
<li><code>ZONE_ID</code> - ID домена. Находится в панели оправления доменом на главной странице в поле <strong>Zone ID</strong>.</li>
<li><code>TOKEN</code> - токен для доступа к CloudFlare API.</li>
</ul>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Вместо этих заглушек необходимо подставить свои значения.</p>

    </div>
  </div>
</div>

<p>Сформировав правильную команду с корректными данными и выполнив её, команда вернёт результат в формате <strong>JSON</strong>. Результат будет содержать набор всех ресурсных записей конкретного домена. У меня это выглядит так:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-47a297d4d81880826a5be114cacbce96"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-47a297d4d81880826a5be114cacbce96"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">curl -X GET &#34;https://api.cloudflare.com/client/v4/zones/&lt;...&gt;/dns_records&#34; -H &#34;Authorization: Bearer &lt;...&gt;&#34; -H &#34;Content-Type: application/json&#34; | python3 -mjson.tool
{
    &#34;result&#34;: [
        {
            &#34;id&#34;: &#34;gJDSG5la4IWNOEVn6K2PHyope8Q9YhzC&#34;,
            &#34;zone_id&#34;: &#34;&lt;...&gt;&#34;,
            &#34;zone_name&#34;: &#34;example.com&#34;,
            &#34;name&#34;: &#34;example.com&#34;,
            &#34;type&#34;: &#34;A&#34;,
            &#34;content&#34;: &#34;192.168.10.232&#34;,
            &#34;proxiable&#34;: true,
            &#34;proxied&#34;: true,
            &#34;ttl&#34;: 1,
            &#34;locked&#34;: false,
            &#34;meta&#34;: {
                &#34;auto_added&#34;: false,
                &#34;managed_by_apps&#34;: false,
                &#34;managed_by_argo_tunnel&#34;: false,
                &#34;source&#34;: &#34;primary&#34;
            },
            &#34;created_on&#34;: &#34;2020-02-23T21:26:27.56227Z&#34;,
            &#34;modified_on&#34;: &#34;2020-02-23T21:26:27.56227Z&#34;
        }
    ],
    &#34;success&#34;: true,
    &#34;errors&#34;: [],
    &#34;messages&#34;: [],
    &#34;result_info&#34;: {
        &#34;page&#34;: 1,
        &#34;per_page&#34;: 20,
        &#34;count&#34;: 7,
        &#34;total_count&#34;: 7,
        &#34;total_pages&#34;: 1
    }
}</code></pre></div>
  </div>
</div>
<p>Как видим, команда вернула нам результат с массивом <code>result</code>. В этом массиве находятся все ресурсные записи нашего домена. Каждая ресурсная запись содержит поля <code>id</code> и <code>content</code>:</p>
<ul>
<li><code>id</code> - ID ресурсной записи. Очень важное поле, как раз его значение необходимо записать в переменную <code>cfDnsID</code> скрипта.</li>
<li><code>content</code> - содержимое ресурсной записи.</li>
</ul>
<p>Нам необходимы только записи с типом <code>A</code>. Обычно в записях с типом <code>A</code> хранятся IP адреса серверов, к которым привязан домен. У записей с типом <code>A</code> в поле <code>content</code> находится IP адрес, который должен изменить наш MikroTik при обращении к CloudFlare API.</p>
<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>cf.ddns.rsc</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0ca59b3bbf06e50d6f778b4571151c5e"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="cf.ddns.rsc" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="cf.ddns.rsc" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
        <div class="card-body" id="clipboard-0ca59b3bbf06e50d6f778b4571151c5e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Mikrotik RouterOS script for CloudFlare DDNS</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @package    RouterOS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @author     Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @copyright  2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @license    MIT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @version    0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @link       https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># RouterOS: WAN interface name.</span>
</span></span><span class="line"><span class="cl">:local rosWanInterface <span class="s2">&#34;ether1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># RouterOS: Enables trust chain validation from local certificate store.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;no&#39;  | Disable certificate check.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;yes&#39; | Enable certificate check.</span>
</span></span><span class="line"><span class="cl">:local rosCheckCert <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: API token.</span>
</span></span><span class="line"><span class="cl">:local cfToken <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Domain.</span>
</span></span><span class="line"><span class="cl">:local cfDomain <span class="s2">&#34;example.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Zone ID.</span>
</span></span><span class="line"><span class="cl">:local cfZoneID <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: DNS ID.</span>
</span></span><span class="line"><span class="cl">:local cfDnsID <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Domain record type.</span>
</span></span><span class="line"><span class="cl">:local cfRecordType <span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Debug mode.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 | Disable debug mode.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1 | Enable debug mode.</span>
</span></span><span class="line"><span class="cl">:local cfDebug <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IP on WAN interface.</span>
</span></span><span class="line"><span class="cl">:local srcIP <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IP on CloudFlare domain.</span>
</span></span><span class="line"><span class="cl">:local dstIP <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get RouterOS WAN IP.</span>
</span></span><span class="line"><span class="cl">:set srcIP <span class="o">[</span>/ip address get <span class="o">[</span>/ip address find <span class="nv">interface</span><span class="o">=</span><span class="nv">$rosWanInterface</span> <span class="o">]</span> address<span class="o">]</span>
</span></span><span class="line"><span class="cl">:set srcIP <span class="o">[</span>:pick <span class="nv">$srcIP</span> <span class="m">0</span> <span class="o">[</span>:find <span class="nv">$srcIP</span> <span class="s2">&#34;/&#34;</span><span class="o">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get CloudFlare domain IP.</span>
</span></span><span class="line"><span class="cl">:set dstIP <span class="o">[</span>:resolve <span class="nv">$cfDomain</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Build CloudFlare API (v4).</span>
</span></span><span class="line"><span class="cl">:local cfAPI <span class="s2">&#34;https://api.cloudflare.com/client/v4/zones/&#34;</span>
</span></span><span class="line"><span class="cl">:set cfAPI <span class="o">(</span><span class="nv">$cfAPI</span> . <span class="s2">&#34;</span><span class="nv">$cfZoneID</span><span class="s2">/dns_records/</span><span class="nv">$cfDnsID</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">:local cfAPIHeader <span class="s2">&#34;Authorization: Bearer </span><span class="nv">$cfToken</span><span class="s2">, Content-Type: application/json&#34;</span>
</span></span><span class="line"><span class="cl">:local cfAPIData <span class="s2">&#34;{\&#34;type\&#34;:\&#34;</span><span class="nv">$cfRecordType</span><span class="s2">\&#34;,\&#34;name\&#34;:\&#34;</span><span class="nv">$cfDomain</span><span class="s2">\&#34;,\&#34;content\&#34;:\&#34;</span><span class="nv">$srcIP</span><span class="s2">\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Write debug info to log.</span>
</span></span><span class="line"><span class="cl">:if <span class="o">(</span><span class="nv">$cfDebug</span><span class="o">)</span> <span class="k">do</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Domain = </span><span class="nv">$cfDomain</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Domain IP (dstIP) = </span><span class="nv">$dstIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: WAN IP (srcIP) = </span><span class="nv">$srcIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: CloudFlare API (cfAPI) = </span><span class="nv">$cfAPI</span><span class="s2">&amp;content=</span><span class="nv">$srcIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compare and update CF if necessary.</span>
</span></span><span class="line"><span class="cl">:if <span class="o">(</span><span class="nv">$dstIP</span> !<span class="o">=</span> <span class="nv">$srcIP</span><span class="o">)</span> <span class="k">do</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Updating </span><span class="nv">$cfDomain</span><span class="s2">, setting </span><span class="nv">$srcIP</span><span class="s2"> = </span><span class="nv">$cfDomain</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  /tool fetch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">mode</span><span class="o">=</span>https <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-method<span class="o">=</span>put <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-header-field<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPIHeader</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-data<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPIData</span><span class="s2">&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPI</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    check-certificate<span class="o">=</span><span class="nv">$rosCheckCert</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">output</span><span class="o">=</span>user as-value
</span></span><span class="line"><span class="cl">  /ip dns cache flush
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="s2">&#34;CloudFlare: No Update Needed!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<h3 id="настройка">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0">Настройка</a>
</h3><p>Алгоритм настройки довольно прост:</p>
<ol>
<li>Получаем токен для работы с CloudFlare API.</li>
<li>При помощи специальной команды узнаём значение поля <code>id</code> ресурсной записи с типом <code>A</code>.</li>
<li>Это значение вписываем в переменную <code>cfDnsID</code> скрипта.</li>
<li>Остальные требуемые значения для переменных уже доступны без каких-либо телодвижений.</li>
</ol>
<h3 id="переменные">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b5%d1%80%d0%b5%d0%bc%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5">Переменные</a>
</h3><p>Опишу переменные и что они из себя представляют:</p>
<ul>
<li><code>rosWanInterface</code> - имя интерфейса <strong>WAN</strong> в RouterOS.</li>
<li><code>rosCheckCert</code> - включение / отключение проверки цепочки сертификации при запросе к CloudFlare API. Для корректной работы этой функции необходимо, чтобы в репозитории сертификатов RouterOS присутствовали корневые сертификаты центров сертификации. Про импортирование сертификатов написано в заметке <span class="shortcode shortcode-uuid"><a href="/ru/posts/2023/10/cc13623b-970c-5950-867e-168f9ba9025a/">Добавление корневых сертификатов в RouterOS</a></span>.</li>
<li><code>cfToken</code> - токен, полученный в <a title="" href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer nofollow">панели управления токенами</a>.</li>
<li><code>cfDomain</code> - название домена, для которого необходимо динамически менять IP адрес.</li>
<li><code>cfZoneID</code> - ID домена. Находится в панели управления доменом на главной странице в поле <strong>Zone ID</strong>.</li>
<li><code>cfDnsID</code> - ID ресурсной записи домена. Для получения значения переменной, необходимо выполнить запрос к CloudFlare API.</li>
<li><code>cfRecordType</code> - тип ресурсной записи домена. Обычно это <code>A</code>. Менять нет необходимости.</li>
<li><code>cfDebug</code> - включение / отключение отображения технической информации в логе RouterOS.</li>
</ul>
<p>Рекомендую настраивать скрипт в редакторе с подсветкой синтаксиса, чтобы не ошибиться и не задеть какую-либо кавычку.</p>
<h3 id="установка">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0">Установка</a>
</h3><p>После настройки скрипта, его нужно добавить в репозиторий скриптов RouterOS. Находится репозиторий в <strong>System / Scripts</strong>. При добавлении скрипта, необходимо выбрать политики <code>read</code>, <code>write</code>, <code>test</code>, <code>policy</code>.</p>
<h3 id="планировщик">
  <a class="link-body-emphasis" href="#%d0%bf%d0%bb%d0%b0%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d1%89%d0%b8%d0%ba">Планировщик</a>
</h3><p>Скрипт должен переодически запускаться для проверки и синхронизации IP адресов сервера и домена. В этом поможет планировщик RouterOS. Заходим в <strong>System / Scheduler</strong> и создаём задачу с политиками <code>read</code>, <code>write</code>, <code>test</code>, <code>policy</code>. В поле <strong>On Event</strong> вписываем точное название скрипта, ранее добавленного в репозиторий RouterOS.</p>
<h3 id="проверка">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0">Проверка</a>
</h3><p>Проверить работу скрипта можно в репозитории по адресу <strong>System / Scripts</strong>. Выделив скрипт и нажав на кнопку <span class="shortcode shortcode-key"><kbd>Run</kbd></span>, смотрим изменился ли IP адрес у домена в панели управления CloudFlare.</p>]]></content:encoded><turbo:source/><turbo:topic>MikroTik и CloudFlare: Динамический IP для домена</turbo:topic><turbo:content><![CDATA[<p>Нашёл скрипт реализации динамической смены IP адреса из RouterOS напрямую в панели управления CloudFlare при помощи API. Где нашёл скрипт уже не помню, вроде бы на страницах официального форума MikroTik.</p>
<p>Скрипт я немного переделал, удалил лишние переменные, некоторые переопределил, подправил области видимости переменных, обновил метод авторизации скрипта на серверах CloudFlare. Вроде работает.</p>
<p>Сам скрипт нужно настроить под себя, прописав в нём значения переменных. Некоторые значений можно узнать из панели управления доменом в CloudFlare, но для получения значения переменной <code>cfDnsID</code> необходимо выполнит немного телодвижений. Об этом ниже.</p>
<h2 id="работа-cloudflare-api">
  <a class="link-body-emphasis" href="#%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0-cloudflare-api">Работа CloudFlare API</a>
</h2><p>Без токена - никак.</p>
<h3 id="создание-токена">
  <a class="link-body-emphasis" href="#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d0%b0">Создание токена</a>
</h3><p>Для того, чтобы начать работать с CloudFlare API, нам нужно создать специальный токен:</p>
<ol>
<li>Зайти в <a title="" href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer nofollow">панель управления токенами</a>.</li>
<li>Нажать кнопку <span class="shortcode shortcode-key"><kbd>Create Token</kbd></span>.</li>
<li>На странице выбора шаблонов - выбрать шаблон <strong>Edit zone DNS</strong>.</li>
<li>В разделе <strong>Zone Resources</strong> можно выбрать область доступа токена к зонам (доменам). Можно указать конкретную зону (<em>Specific zone</em>) или выбрать все зоны (<em>All zones</em>).</li>
<li>Всё, нажимаем кнопку <span class="shortcode shortcode-key"><kbd>Continue to summary</kbd></span> и перемещаемся на следующую станицу&hellip;</li>
</ol>
<h3 id="проверка-токена">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d0%b0">Проверка токена</a>
</h3><p>По окончании создания токена, CloudFlare переместит нас на страницу проверки токена. На этой странице будут наш созданный токен (его необходимо сохранить) и команда, которой при помощи утилиты <code>curl</code> можно проверить корректность токена:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-6aab74748047944d8be3292d3bca6079"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X GET <span class="s2">&#34;https://api.cloudflare.com/client/v4/user/tokens/verify&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Authorization: Bearer TOKEN&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Content-Type:application/json&#34;</span> <span class="p">|</span> python3 -mjson.tool</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-6aab74748047944d8be3292d3bca6079"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>При выполнении, команда вернёт следующий результат:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-8c556f6963af3c20dd338a596c5d3ee7"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-8c556f6963af3c20dd338a596c5d3ee7"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">curl -X GET &#34;https://api.cloudflare.com/client/v4/user/tokens/verify&#34; -H &#34;Authorization: Bearer &lt;...&gt;&#34; -H &#34;Content-Type: application/json&#34; | python3 -mjson.tool

{
    &#34;result&#34;: {
        &#34;id&#34;: &#34;&lt;...&gt;&#34;,
        &#34;status&#34;: &#34;active&#34;
    },
    &#34;success&#34;: true,
    &#34;errors&#34;: [],
    &#34;messages&#34;: [
        {
            &#34;code&#34;: 10000,
            &#34;message&#34;: &#34;This API Token is valid and active&#34;,
            &#34;type&#34;: null
        }
    ]
}</code></pre></div>
  </div>
</div>
<p>По сообщению &ldquo;This API Token is valid and active&rdquo; понятно, что токен корректный и работает.</p>
<h3 id="получение-id-ресурсной-записи-домена">
  <a class="link-body-emphasis" href="#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-id-%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%bd%d0%be%d0%b9-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d0%b8-%d0%b4%d0%be%d0%bc%d0%b5%d0%bd%d0%b0">Получение ID ресурсной записи домена</a>
</h3><p>Когда у нас есть токен, можно полноценно работать с CloudFlare API. Нам нужно получить ID ресурсной записи домена. Получать будем следующей командой:</p>








  <div class="shortcode shortcode-codeblock shortcode-codeblock-sh">
    <div class="d-flex mb-3 overflow-hidden">
      <div class="flex-grow-1 rounded overflow-hidden" id="clipboard-96069c97a166b6c198f96fffabf34561"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X GET <span class="s2">&#34;https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Authorization: Bearer TOKEN&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-H <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="p">|</span> python3 -mjson.tool</span></span></code></pre></div></div>
      <div class="flex-shrink-0">
        <ul class="list-inline mb-0">
          <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
            <a class="text-body" href="#"
               data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-96069c97a166b6c198f96fffabf34561"
               role="button" aria-label='Копировать'>
              <i class="fas fa-copy fa-fw"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>


<p>Обратите внимание на следующие заглушки в команде:</p>
<ul>
<li><code>ZONE_ID</code> - ID домена. Находится в панели оправления доменом на главной странице в поле <strong>Zone ID</strong>.</li>
<li><code>TOKEN</code> - токен для доступа к CloudFlare API.</li>
</ul>








    
    






<div class="shortcode shortcode-alert">
  <div class="alert alert-warning d-flex overflow-hidden" role="alert">
    <div class="flex-shrink-0 align-self-center">
      <i class="fas fa-exclamation-triangle fa-fw fa-2x"></i>
    </div>
    <div class="flex-grow-1 ms-3 overflow-hidden">
        <p>Вместо этих заглушек необходимо подставить свои значения.</p>

    </div>
  </div>
</div>

<p>Сформировав правильную команду с корректными данными и выполнив её, команда вернёт результат в формате <strong>JSON</strong>. Результат будет содержать набор всех ресурсных записей конкретного домена. У меня это выглядит так:</p>






<div class="shortcode shortcode-codeblock shortcode-codeblock-terminal
shortcode-codeblock-terminal-linux
shortcode-codeblock-terminal-linux">
  <div class="card mb-3 overflow-hidden" data-bs-theme="dark">
    <div class="card-header">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 ">
          <i class="fas fa-terminal fa-fw"></i>
        </div>
        <div class="flex-grow-1 mx-2">
          <h5 class="mb-0">Терминал</h5>
        </div>
        <div class="flex-shrink-0">
          <ul class="list-inline mb-0">
            <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
              <a class="text-body" href="#"
                 data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-47a297d4d81880826a5be114cacbce96"
                 role="button" aria-label='Копировать'>
                <i class="fas fa-copy fa-fw"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-body p-0" id="clipboard-47a297d4d81880826a5be114cacbce96"><pre tabindex="0"><code class="language-terminal" data-lang="terminal">curl -X GET &#34;https://api.cloudflare.com/client/v4/zones/&lt;...&gt;/dns_records&#34; -H &#34;Authorization: Bearer &lt;...&gt;&#34; -H &#34;Content-Type: application/json&#34; | python3 -mjson.tool
{
    &#34;result&#34;: [
        {
            &#34;id&#34;: &#34;gJDSG5la4IWNOEVn6K2PHyope8Q9YhzC&#34;,
            &#34;zone_id&#34;: &#34;&lt;...&gt;&#34;,
            &#34;zone_name&#34;: &#34;example.com&#34;,
            &#34;name&#34;: &#34;example.com&#34;,
            &#34;type&#34;: &#34;A&#34;,
            &#34;content&#34;: &#34;192.168.10.232&#34;,
            &#34;proxiable&#34;: true,
            &#34;proxied&#34;: true,
            &#34;ttl&#34;: 1,
            &#34;locked&#34;: false,
            &#34;meta&#34;: {
                &#34;auto_added&#34;: false,
                &#34;managed_by_apps&#34;: false,
                &#34;managed_by_argo_tunnel&#34;: false,
                &#34;source&#34;: &#34;primary&#34;
            },
            &#34;created_on&#34;: &#34;2020-02-23T21:26:27.56227Z&#34;,
            &#34;modified_on&#34;: &#34;2020-02-23T21:26:27.56227Z&#34;
        }
    ],
    &#34;success&#34;: true,
    &#34;errors&#34;: [],
    &#34;messages&#34;: [],
    &#34;result_info&#34;: {
        &#34;page&#34;: 1,
        &#34;per_page&#34;: 20,
        &#34;count&#34;: 7,
        &#34;total_count&#34;: 7,
        &#34;total_pages&#34;: 1
    }
}</code></pre></div>
  </div>
</div>
<p>Как видим, команда вернула нам результат с массивом <code>result</code>. В этом массиве находятся все ресурсные записи нашего домена. Каждая ресурсная запись содержит поля <code>id</code> и <code>content</code>:</p>
<ul>
<li><code>id</code> - ID ресурсной записи. Очень важное поле, как раз его значение необходимо записать в переменную <code>cfDnsID</code> скрипта.</li>
<li><code>content</code> - содержимое ресурсной записи.</li>
</ul>
<p>Нам необходимы только записи с типом <code>A</code>. Обычно в записях с типом <code>A</code> хранятся IP адреса серверов, к которым привязан домен. У записей с типом <code>A</code> в поле <code>content</code> находится IP адрес, который должен изменить наш MikroTik при обращении к CloudFlare API.</p>
<h2 id="скрипт">
  <a class="link-body-emphasis" href="#%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82">Скрипт</a>
</h2>
    

    

    <div class="shortcode shortcode-file mb-3">
      <div class="card overflow-hidden">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <i class="far fa-file-code fa-fw"></i>
            </div>
            <div class="flex-grow-1 mx-2">
              <code>cf.ddns.rsc</code>
            </div>
            <div class="flex-shrink-0">
              <ul class="list-inline mb-0">
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Копировать'>
                  <a class="text-body" href="#"
                     data-fn="clipboard preventDefault" data-clipboard-target="#clipboard-0ca59b3bbf06e50d6f778b4571151c5e"
                     role="button" aria-label='Копировать'>
                    <i class="fas fa-copy fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Скачать'>
                  <a class="text-body" href="cf.ddns.rsc" download
                     role="button" aria-label='Скачать'>
                    <i class="fas fa-download fa-fw"></i>
                  </a>
                </li>
                <li class="list-inline-item" data-bs-tooltip data-bs-title='Открыть'>
                  <a class="text-body" href="cf.ddns.rsc" target="_blank"
                     role="button" aria-label='Открыть'>
                    <i class="fas fa-arrow-up-right-from-square fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
          
          
        <div class="card-body" id="clipboard-0ca59b3bbf06e50d6f778b4571151c5e"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Mikrotik RouterOS script for CloudFlare DDNS</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @package    RouterOS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @author     Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @copyright  2023 iHub TO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @license    MIT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @version    0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @link       https://lib.onl</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># RouterOS: WAN interface name.</span>
</span></span><span class="line"><span class="cl">:local rosWanInterface <span class="s2">&#34;ether1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># RouterOS: Enables trust chain validation from local certificate store.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;no&#39;  | Disable certificate check.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;yes&#39; | Enable certificate check.</span>
</span></span><span class="line"><span class="cl">:local rosCheckCert <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: API token.</span>
</span></span><span class="line"><span class="cl">:local cfToken <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Domain.</span>
</span></span><span class="line"><span class="cl">:local cfDomain <span class="s2">&#34;example.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Zone ID.</span>
</span></span><span class="line"><span class="cl">:local cfZoneID <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: DNS ID.</span>
</span></span><span class="line"><span class="cl">:local cfDnsID <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Domain record type.</span>
</span></span><span class="line"><span class="cl">:local cfRecordType <span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFlare: Debug mode.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 | Disable debug mode.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1 | Enable debug mode.</span>
</span></span><span class="line"><span class="cl">:local cfDebug <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IP on WAN interface.</span>
</span></span><span class="line"><span class="cl">:local srcIP <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IP on CloudFlare domain.</span>
</span></span><span class="line"><span class="cl">:local dstIP <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get RouterOS WAN IP.</span>
</span></span><span class="line"><span class="cl">:set srcIP <span class="o">[</span>/ip address get <span class="o">[</span>/ip address find <span class="nv">interface</span><span class="o">=</span><span class="nv">$rosWanInterface</span> <span class="o">]</span> address<span class="o">]</span>
</span></span><span class="line"><span class="cl">:set srcIP <span class="o">[</span>:pick <span class="nv">$srcIP</span> <span class="m">0</span> <span class="o">[</span>:find <span class="nv">$srcIP</span> <span class="s2">&#34;/&#34;</span><span class="o">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get CloudFlare domain IP.</span>
</span></span><span class="line"><span class="cl">:set dstIP <span class="o">[</span>:resolve <span class="nv">$cfDomain</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Build CloudFlare API (v4).</span>
</span></span><span class="line"><span class="cl">:local cfAPI <span class="s2">&#34;https://api.cloudflare.com/client/v4/zones/&#34;</span>
</span></span><span class="line"><span class="cl">:set cfAPI <span class="o">(</span><span class="nv">$cfAPI</span> . <span class="s2">&#34;</span><span class="nv">$cfZoneID</span><span class="s2">/dns_records/</span><span class="nv">$cfDnsID</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">:local cfAPIHeader <span class="s2">&#34;Authorization: Bearer </span><span class="nv">$cfToken</span><span class="s2">, Content-Type: application/json&#34;</span>
</span></span><span class="line"><span class="cl">:local cfAPIData <span class="s2">&#34;{\&#34;type\&#34;:\&#34;</span><span class="nv">$cfRecordType</span><span class="s2">\&#34;,\&#34;name\&#34;:\&#34;</span><span class="nv">$cfDomain</span><span class="s2">\&#34;,\&#34;content\&#34;:\&#34;</span><span class="nv">$srcIP</span><span class="s2">\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Write debug info to log.</span>
</span></span><span class="line"><span class="cl">:if <span class="o">(</span><span class="nv">$cfDebug</span><span class="o">)</span> <span class="k">do</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Domain = </span><span class="nv">$cfDomain</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Domain IP (dstIP) = </span><span class="nv">$dstIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: WAN IP (srcIP) = </span><span class="nv">$srcIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: CloudFlare API (cfAPI) = </span><span class="nv">$cfAPI</span><span class="s2">&amp;content=</span><span class="nv">$srcIP</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compare and update CF if necessary.</span>
</span></span><span class="line"><span class="cl">:if <span class="o">(</span><span class="nv">$dstIP</span> !<span class="o">=</span> <span class="nv">$srcIP</span><span class="o">)</span> <span class="k">do</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="o">(</span><span class="s2">&#34;CloudFlare: Updating </span><span class="nv">$cfDomain</span><span class="s2">, setting </span><span class="nv">$srcIP</span><span class="s2"> = </span><span class="nv">$cfDomain</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  /tool fetch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">mode</span><span class="o">=</span>https <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-method<span class="o">=</span>put <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-header-field<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPIHeader</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    http-data<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPIData</span><span class="s2">&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$cfAPI</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    check-certificate<span class="o">=</span><span class="nv">$rosCheckCert</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">output</span><span class="o">=</span>user as-value
</span></span><span class="line"><span class="cl">  /ip dns cache flush
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">  :log info <span class="s2">&#34;CloudFlare: No Update Needed!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div>
      </div>
    </div>
<h3 id="настройка">
  <a class="link-body-emphasis" href="#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0">Настройка</a>
</h3><p>Алгоритм настройки довольно прост:</p>
<ol>
<li>Получаем токен для работы с CloudFlare API.</li>
<li>При помощи специальной команды узнаём значение поля <code>id</code> ресурсной записи с типом <code>A</code>.</li>
<li>Это значение вписываем в переменную <code>cfDnsID</code> скрипта.</li>
<li>Остальные требуемые значения для переменных уже доступны без каких-либо телодвижений.</li>
</ol>
<h3 id="переменные">
  <a class="link-body-emphasis" href="#%d0%bf%d0%b5%d1%80%d0%b5%d0%bc%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5">Переменные</a>
</h3><p>Опишу переменные и что они из себя представляют:</p>
<ul>
<li><code>rosWanInterface</code> - имя интерфейса <strong>WAN</strong> в RouterOS.</li>
<li><code>rosCheckCert</code> - включение / отключение проверки цепочки сертификации при запросе к CloudFlare API. Для корректной работы этой функции необходимо, чтобы в репозитории сертификатов RouterOS присутствовали корневые сертификаты центров сертификации. Про импортирование сертификатов написано в заметке <span class="shortcode shortcode-uuid"><a href="/ru/posts/2023/10/cc13623b-970c-5950-867e-168f9ba9025a/">Добавление корневых сертификатов в RouterOS</a></span>.</li>
<li><code>cfToken</code> - токен, полученный в <a title="" href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer nofollow">панели управления токенами</a>.</li>
<li><code>cfDomain</code> - название домена, для которого необходимо динамически менять IP адрес.</li>
<li><code>cfZoneID</code> - ID домена. Находится в панели управления доменом на главной странице в поле <strong>Zone ID</strong>.</li>
<li><code>cfDnsID</code> - ID ресурсной записи домена. Для получения значения переменной, необходимо выполнить запрос к CloudFlare API.</li>
<li><code>cfRecordType</code> - тип ресурсной записи домена. Обычно это <code>A</code>. Менять нет необходимости.</li>
<li><code>cfDebug</code> - включение / отключение отображения технической информации в логе RouterOS.</li>
</ul>
<p>Рекомендую настраивать скрипт в редакторе с подсветкой синтаксиса, чтобы не ошибиться и не задеть какую-либо кавычку.</p>
<h3 id="установка">
  <a class="link-body-emphasis" href="#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0">Установка</a>
</h3><p>После настройки скрипта, его нужно добавить в репозиторий скриптов RouterOS. Находится репозиторий в <strong>System / Scripts</strong>. При добавлении скрипта, необходимо выбрать политики <code>read</code>, <code>write</code>, <code>test</code>, <code>policy</code>.</p>
<h3 id="планировщик">
  <a class="link-body-emphasis" href="#%d0%bf%d0%bb%d0%b0%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d1%89%d0%b8%d0%ba">Планировщик</a>
</h3><p>Скрипт должен переодически запускаться для проверки и синхронизации IP адресов сервера и домена. В этом поможет планировщик RouterOS. Заходим в <strong>System / Scheduler</strong> и создаём задачу с политиками <code>read</code>, <code>write</code>, <code>test</code>, <code>policy</code>. В поле <strong>On Event</strong> вписываем точное название скрипта, ранее добавленного в репозиторий RouterOS.</p>
<h3 id="проверка">
  <a class="link-body-emphasis" href="#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0">Проверка</a>
</h3><p>Проверить работу скрипта можно в репозитории по адресу <strong>System / Scripts</strong>. Выделив скрипт и нажав на кнопку <span class="shortcode shortcode-key"><kbd>Run</kbd></span>, смотрим изменился ли IP адрес у домена в панели управления CloudFlare.</p>]]></turbo:content><pubDate>Sun, 12 Jul 2020 15:09:48 +0000</pubDate><category>Сеть</category><category>Скрипты</category></item></channel></rss>