<!doctype html><html class=h-100 dir=ltr lang=ru-RU prefix="og: http://ogp.me/ns#
      article: http://ogp.me/ns/article#
      profile: http://ogp.me/ns/profile#
      fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Главная / Library Online</title>
<meta name=title content="Главная / Library Online"><meta name=description content="Заметки на тему администрирования и разработки различных систем, приложений и серверов."><meta name=keywords content="forum,powershell,ipb,ips,debian,linux,cmd,cmf,cms,vbulletin,bash,fedora,git,php,systemd,terminal,cloudflare,find,gdm,github"><link rel=preconnect href=https://fonts.googleapis.com crossorigin=anonymous><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link rel=preconnect href=https://gravatar.com crossorigin=anonymous><link rel=preconnect href=https://images.unsplash.com crossorigin=anonymous><link rel=preload href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous></noscript><link rel=preload href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous></noscript><link rel=preload href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous></noscript><link rel=preload href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" crossorigin=anonymous></noscript><link rel=preload href=/css/vendor.bundle.css as=style><link rel=stylesheet href=/css/vendor.bundle.css><link rel=preload href=/ru/css/system.bundle.min.css as=style><link rel=stylesheet href=/ru/css/system.bundle.min.css><link rel=icon type=image/png sizes=16x16 href=https://lib.onl/favicon-16.png><link rel="shortcut icon" type=image/png sizes=16x16 href=https://lib.onl/favicon-16.png><link rel=apple-touch-icon sizes=16x16 href=https://lib.onl/favicon-16.png><link rel=icon type=image/png sizes=24x24 href=https://lib.onl/favicon-24.png><link rel="shortcut icon" type=image/png sizes=24x24 href=https://lib.onl/favicon-24.png><link rel=apple-touch-icon sizes=24x24 href=https://lib.onl/favicon-24.png><link rel=icon type=image/png sizes=32x32 href=https://lib.onl/favicon-32.png><link rel="shortcut icon" type=image/png sizes=32x32 href=https://lib.onl/favicon-32.png><link rel=apple-touch-icon sizes=32x32 href=https://lib.onl/favicon-32.png><link rel=icon type=image/png sizes=48x48 href=https://lib.onl/favicon-48.png><link rel="shortcut icon" type=image/png sizes=48x48 href=https://lib.onl/favicon-48.png><link rel=apple-touch-icon sizes=48x48 href=https://lib.onl/favicon-48.png><link rel=icon type=image/png sizes=64x64 href=https://lib.onl/favicon-64.png><link rel="shortcut icon" type=image/png sizes=64x64 href=https://lib.onl/favicon-64.png><link rel=apple-touch-icon sizes=64x64 href=https://lib.onl/favicon-64.png><link rel=icon type=image/png sizes=72x72 href=https://lib.onl/favicon-72.png><link rel="shortcut icon" type=image/png sizes=72x72 href=https://lib.onl/favicon-72.png><link rel=apple-touch-icon sizes=72x72 href=https://lib.onl/favicon-72.png><link rel=icon type=image/png sizes=80x80 href=https://lib.onl/favicon-80.png><link rel="shortcut icon" type=image/png sizes=80x80 href=https://lib.onl/favicon-80.png><link rel=apple-touch-icon sizes=80x80 href=https://lib.onl/favicon-80.png><link rel=icon type=image/png sizes=96x96 href=https://lib.onl/favicon-96.png><link rel="shortcut icon" type=image/png sizes=96x96 href=https://lib.onl/favicon-96.png><link rel=apple-touch-icon sizes=96x96 href=https://lib.onl/favicon-96.png><link rel=icon type=image/png sizes=128x128 href=https://lib.onl/favicon-128.png><link rel="shortcut icon" type=image/png sizes=128x128 href=https://lib.onl/favicon-128.png><link rel=apple-touch-icon sizes=128x128 href=https://lib.onl/favicon-128.png><link rel=icon type=image/png sizes=144x144 href=https://lib.onl/favicon-144.png><link rel="shortcut icon" type=image/png sizes=144x144 href=https://lib.onl/favicon-144.png><link rel=apple-touch-icon sizes=144x144 href=https://lib.onl/favicon-144.png><link rel=icon type=image/png sizes=152x152 href=https://lib.onl/favicon-152.png><link rel="shortcut icon" type=image/png sizes=152x152 href=https://lib.onl/favicon-152.png><link rel=apple-touch-icon sizes=152x152 href=https://lib.onl/favicon-152.png><link rel=icon type=image/png sizes=167x167 href=https://lib.onl/favicon-167.png><link rel="shortcut icon" type=image/png sizes=167x167 href=https://lib.onl/favicon-167.png><link rel=apple-touch-icon sizes=167x167 href=https://lib.onl/favicon-167.png><link rel=icon type=image/png sizes=180x180 href=https://lib.onl/favicon-180.png><link rel="shortcut icon" type=image/png sizes=180x180 href=https://lib.onl/favicon-180.png><link rel=apple-touch-icon sizes=180x180 href=https://lib.onl/favicon-180.png><link rel=icon type=image/png sizes=192x192 href=https://lib.onl/favicon-192.png><link rel="shortcut icon" type=image/png sizes=192x192 href=https://lib.onl/favicon-192.png><link rel=apple-touch-icon sizes=192x192 href=https://lib.onl/favicon-192.png><link rel=icon type=image/png sizes=196x196 href=https://lib.onl/favicon-196.png><link rel="shortcut icon" type=image/png sizes=196x196 href=https://lib.onl/favicon-196.png><link rel=apple-touch-icon sizes=196x196 href=https://lib.onl/favicon-196.png><link rel=icon type=image/png sizes=256x256 href=https://lib.onl/favicon-256.png><link rel="shortcut icon" type=image/png sizes=256x256 href=https://lib.onl/favicon-256.png><link rel=apple-touch-icon sizes=256x256 href=https://lib.onl/favicon-256.png><link rel=icon type=image/png sizes=300x300 href=https://lib.onl/favicon-300.png><link rel="shortcut icon" type=image/png sizes=300x300 href=https://lib.onl/favicon-300.png><link rel=apple-touch-icon sizes=300x300 href=https://lib.onl/favicon-300.png><link rel=icon type=image/png sizes=512x512 href=https://lib.onl/favicon-512.png><link rel="shortcut icon" type=image/png sizes=512x512 href=https://lib.onl/favicon-512.png><link rel=apple-touch-icon sizes=512x512 href=https://lib.onl/favicon-512.png><link rel=icon type=image/svg+xml sizes=any href=https://lib.onl/favicon.svg><link rel="shortcut icon" type=image/x-icon href=https://lib.onl/favicon.ico><link rel="shortcut icon" type=image/vnd.microsoft.icon href=https://lib.onl/favicon.ico><link rel=first href=https://lib.onl/ru/><link rel=last href=https://lib.onl/ru/page/4/><link rel=next href=https://lib.onl/ru/page/2/><link rel=canonical href=https://lib.onl/ru/><link rel=alternate href=https://lib.onl/ hreflang=x-default><link rel=alternate href=https://lib.onl/ru/ hreflang=ru><link rel=alternate href=https://lib.onl/en/ hreflang=en><link rel=manifest type=application/manifest+json href=https://lib.onl/ru/manifest.json title="Library Online"><link rel=search type=application/opensearchdescription+xml href=https://lib.onl/ru/opensearch.xml title="Library Online"><link rel=alternate type=application/rss+xml href=https://lib.onl/ru/index.xml title="Library Online"><meta name=application-name content="Library Online"><meta name=theme-color content="#f8f9fa" media="(prefers-color-scheme: light)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lib.onl/favicon-512.png"><meta name=twitter:title content="Главная"><meta name=twitter:description content="Заметки на тему администрирования и разработки различных систем, приложений и серверов."><meta property="og:title" content="Главная"><meta property="og:description" content="Заметки на тему администрирования и разработки различных систем, приложений и серверов."><meta property="og:type" content="website"><meta property="og:url" content="https://lib.onl/ru/"><meta property="og:image" content="https://lib.onl/favicon-512.png"><meta property="twitter:domain" content="lib.onl"><meta property="twitter:url" content="https://lib.onl/ru/"><meta property="og:locale" content="ru_RU"><meta property="og:site_name" content="Library Online"><meta name=DC.Title content="Главная"><meta name=DC.Subject content="Заметки на тему администрирования и разработки различных систем, приложений и серверов."><meta name=DC.Description content="Заметки на тему администрирования и разработки различных систем, приложений и серверов."><meta name=DC.Type content="Text"><meta name=DC.Source content="https://lib.onl/ru/"><meta name=DC.Relation content="https://lib.onl/ru/"><meta name=DC.Coverage content="World"><meta name=DC.Creator content="Library Online"><meta name=DC.Publisher content="Library Online"><meta name=DC.Contributor content="Library Online"><meta name=DC.Rights content="Library Online"><meta name=DC.Format content="Digital"><meta name=DC.Identifier content="https://lib.onl/ru/"><meta name=DC.Language content="ru-RU"><meta name=DC.Provenance content="Library Online"><meta name=DC.RightsHolder content="Library Online"><meta name=DC.AccrualPeriodicity content="Weekly"><meta name=DC.AccrualPolicy content="Active"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"Library Online","url":"https://lib.onl/"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","address":{"@type":"PostalAddress","addressCountry":"","addressLocality":"","addressRegion":"","postalCode":"","streetAddress":""},"contactPoint":{"@type":"ContactPoint","contactType":"","email":"","telephone":""},"description":"Заметки на тему администрирования и разработки различных систем, приложений и серверов.","foundingDate":"","legalName":"Library Online","logo":"https://lib.onl/","name":"Library Online","sameAs":[],"url":"https://lib.onl/"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"ItemList","itemListElement":[{"@type":"SiteNavigationElement","name":"Статьи","position":10,"url":"https://lib.onl/ru/articles/"},{"@type":"SiteNavigationElement","name":"Q\u0026A","position":20,"url":"https://lib.onl/ru/faq/"},{"@type":"SiteNavigationElement","name":"Архив","position":100,"url":"https://lib.onl/ru/archive/"},{"@type":"SiteNavigationElement","name":"О проекте","position":999,"url":"https://lib.onl/ru/about/"},{"@type":"SiteNavigationElement","name":"META","position":9999,"url":"https://lib.onl/ru/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://lib.onl/ru/","name":"Главная","position":1}]}</script></head><body class="d-flex flex-column h-100 is-home is-node type-page"><header><nav class="navbar navbar-expand-lg navbar-light fixed-top border-bottom shadow-sm text-lg-center bg-light"><div class=container-fluid><a class=navbar-brand href=/ru/><img src=https://lib.onl/img/logo.min.svg alt=Логотип width=30 height=24 class="d-inline-block align-text-top"><h1 class="d-inline-block h5 m-0 ms-1">Library Online</h1></a><button type=button class=navbar-toggler data-bs-toggle=collapse data-bs-target=#navTopBar aria-controls=navTopBar aria-expanded=false aria-label='Переключить навигацию'>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navTopBar><ul class="navbar-nav me-auto"><li class=nav-item><a class=nav-link href=/ru/articles/><i class="fas fa-book fa-fw"></i>
<span>Статьи</span></a></li><li class=nav-item><a class=nav-link href=/ru/faq/><i class="fas fa-circle-question fa-fw"></i>
<span>Q&amp;A</span></a></li><li class=nav-item><a class=nav-link href=/ru/archive/><i class="fas fa-archive fa-fw"></i>
<span>Архив</span></a></li><li class=nav-item><a class=nav-link href=/ru/about/><i class="fas fa-info-circle fa-fw"></i>
<span>О проекте</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-list fa-fw"></i>
<span>META</span></a><div class="dropdown-menu shadow"><a class=dropdown-item href=/ru/authors/><i class="fas fa-user-circle fa-fw"></i>
<span>Авторы</span>
</a><a class=dropdown-item href=/ru/categories/><i class="fas fa-folder-open fa-fw"></i>
<span>Категории</span>
</a><a class=dropdown-item href=/ru/tags/><i class="fas fa-tags fa-fw"></i>
<span>Теги</span></a></div></li></ul><ul class=navbar-nav><li class=nav-item><a class="nav-link d-lg-none" href=# data-bs-toggle=modal data-bs-target=#search-modal aria-label=Поиск><i class="fas fa-search fa-fw"></i>
<span>Поиск</span>
</a><a class="nav-link d-none d-lg-block" href=# data-bs-toggle=modal data-bs-target=#search-modal data-bs-tooltip data-bs-title=Поиск aria-label=Поиск><i class="fas fa-search fa-fw"></i></a></li></ul></div></div></nav></header><main class="wrapper flex-shrink-0"><div class="section py-3"><div class=container><nav style="--bs-breadcrumb-divider:'\2f '" class=small aria-label=breadcrumb><ol class="breadcrumb bg-light p-2 rounded"><li class="breadcrumb-item active"><i class="fas fa-home fa-fw"></i></li></ol></nav><div class="row row-cols-1 g-3"><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Работа с правилами CloudFlare" class=d-block href=/ru/articles/2023/10/e191797e-d558-5017-8ac4-c28c6e0871ff/ data-bs-toggle=modal data-bs-target=#modal-43af3c7b299583dd88c22fdb98b17719><picture><source srcset='https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1687488802693-db85cc7783e4?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Работа с правилами CloudFlare"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/e191797e-d558-5017-8ac4-c28c6e0871ff/ data-bs-toggle=modal data-bs-target=#modal-43af3c7b299583dd88c22fdb98b17719>Работа с правилами CloudFlare</a></h2></div></header><div class=node-body><p>CloudFlare предоставляет мощный инструмент по работе с различными правилами, зависящими от запросов клиентов. Разберём составление этих правил и приведём несколько примеров.</p></div></article><div class="modal fade" id=modal-43af3c7b299583dd88c22fdb98b17719 tabindex=-1 aria-labelledby=modal-43af3c7b299583dd88c22fdb98b17719-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-43af3c7b299583dd88c22fdb98b17719-label><a href=/ru/articles/2023/10/e191797e-d558-5017-8ac4-c28c6e0871ff/>Работа с правилами CloudFlare</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>CloudFlare предоставляет мощный инструмент по работе с различными правилами, зависящими от запросов клиентов. Разберём составление этих правил и приведём несколько примеров.</p><h2>Настройки правила</h2><p>Правила работаю на, так называемом, <a title href=https://developers.cloudflare.com/ruleset-engine/ target=_blank rel="noopener noreferrer nofollow">Cloudflare Ruleset Engine</a> и позволяют максимально гибко себя конфигурировать при помощи специальных полей, условий и переменных.</p><p>Каждое правило состоит из двух этапов:</p><ol><li>If&mldr; - если.</li><li>Then&mldr; - тогда.</li></ol><p>Рассмотрим всё это дело подробнее&mldr;</p><h3>If&mldr;</h3><p>Этап &ldquo;Если&rdquo; означает условие, по которому будут фильтроваться клиенты. Этап состоит из поля, оператора сравнения и значения, которое будет участвовать в составленном условии.</p><h4>Поля</h4><p>Поля это переменные, значения которых вычисляются из запроса, инициируемого клиентом. Ниже приведён частичный список полей, которые доступны из графического интерфейса. Полный список полей находится в <a title href=https://developers.cloudflare.com/ruleset-engine/rules-language/fields/ target=_blank rel="noopener noreferrer nofollow">документации CloudFlare</a>.</p><ul><li>AS Num <code>ip.src.asnum</code>.<br>16- или 32-разрядное целое число, представляющее номер автономной системы (AS), связанной с IP-адресом клиента. Это поле эквивалентно устаревшему <code>ip.geoip.asnum</code>.</li><li>Cookie <code>http.cookie</code>.<br>Файл cookie в строке. Пример: <code>session=8521F670545D7865F79C3D7BEDC29CCE;-background=light</code>.</li><li>Country <code>ip.src.country</code>.<br>Двухбуквенный код страны в формате ISO 3166-1 Alpha 2. Пример: GB. Это поле эквивалентно устаревшему <code>ip.geoip.country</code>.</li><li>Continent <code>ip.src.continent</code>.<br>Код континента, связанный с IP-адресом клиента. Это поле эквивалентно устаревшему <code>ip.geoip.continent</code>.<ul><li><code>AF</code> - Africa.</li><li><code>AN</code> - Antarctica.</li><li><code>AS</code> - Asia.</li><li><code>EU</code> - Europe.</li><li><code>NA</code> - North America.</li><li><code>OC</code> - Oceania.</li><li><code>SA</code> - South America.</li><li><code>T1</code> - Tor network.</li></ul></li><li>Hostname <code>http.host</code>.<br>Имя хоста. Пример: <code>www.example.org</code>.</li><li>IP Source Address <code>ip.src</code>.<br>IP-адрес клиента. Пример: <code>93.184.216.34</code>.</li><li>Referer <code>http.referer</code>.<br>Заголовок запроса HTTP Referer, который содержит адрес веб-страницы, с которой пришёл запрос. Пример: <code>Referer: htt­ps://developer.example.org/en-US/docs/Web/JavaScript</code>.</li><li>Request Method <code>http.request.method</code>.<br>Метод HTTP-запроса. Пример: <code>GET</code>.</li><li>SSL/HTTPS <code>ssl</code>.<br>Возвращает <code>true</code>, когда используется зашифрованное соединение с клиентом.</li><li>URI Full <code>http.request.full_uri</code>.<br>Весь URI, полученный сервером. Пример: <code>htt­ps://www.example.org/articles/index?section=539061&amp;expand=comments</code>.</li><li>URI <code>http.request.uri</code>.<br>Путь URI и строка запроса. Пример: <code>/articles/index?section=539061&amp;expand=comments</code>.</li><li>URI Path <code>http.request.uri.path</code>.<br>Путь URI. Пример: <code>/articles/index</code>.</li><li>URI Query String <code>http.request.uri.query</code>.<br>Строка запроса без разделителя <code>?</code>. Пример: <code>section=539061&amp;expand=comments</code>.</li><li>HTTP Version <code>http.request.version</code>.<br>Версия используемого протокола HTTP. Пример: <code>HTTP/1.1</code> или <code>HTTP/3</code>.</li><li>User Agent <code>http.user_agent</code>.<br>User Agent клиента, строка, позволяющая идентифицировать клиентскую операционную систему и веб-браузер. Пример: <code>Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36</code>.</li><li>X-Forward-For <code>http.x_forwarded_for</code>.<br>Заголовок X-Forwarded-For. Пример: <code>203.0.113.195, 70.41.3.18</code>.</li><li>Client Certificate Verified <code>cf.tls_client_auth.cert_verified</code>.<br>Возвращает <code>true</code>, когда запрос предоставляет действительный сертификат клиента.</li></ul><h4>Операторы</h4><p>Операторы сравнения возвращают true, когда значение запроса клиента совпадает со значением в выражении. Подробнее в <a title href=https://developers.cloudflare.com/ruleset-engine/rules-language/operators/ target=_blank rel="noopener noreferrer nofollow">документации</a>.</p><ul><li>equals <code>eq</code> - равно.</li><li>does not equal <code>ne</code> - не равно.</li><li>greater than <code>gt</code> - больше чем.</li><li>less than <code>lt</code> - меньше чем.</li><li>greater than or equal to <code>ge</code> - больше или равно.</li><li>less than or equal to <code>le</code> - меньше или равно.</li><li>is in <code>in {}</code> - значение находится в массиве.</li><li>is not in <code>not &lt;field> in {}</code> - значение не находится в массиве.</li></ul><h3>Then&mldr;</h3><p>Этап &ldquo;Тогда&rdquo; подразумевает под собой действие, которое будет применено к отфильтрованному клиенту.</p><h4>Тип поля URL</h4><ul><li>Dynamic - в поле URL содержит динамические параметры (переменные полей) и их необходимо вычислять и обрабатывать.</li><li>Static - в поле URL содержится обычные статические параметры.</li></ul><h4>Коды статуса</h4><ul><li>301 (Moved Permanently).<br>Запрошенный ресурс был окончательно перемещён в URL, указанный в заголовке <code>Location</code>. Браузер в случае такого ответа перенаправляется на эту страницу, а поисковые системы обновляют свои ссылки на ресурс (говоря языком SEO, вес страницы переносится на новый URL-адрес).</li><li>302 (Moved Temporarily).<br>Запрошенный ресурс был временно перемещён по адресу, указанному в заголовке <code>Location</code>. Получив такой ответ браузер перенаправляется на новую страницу, но поисковые системы не обновляют свои ссылки на ресурс (в жаргоне SEO говорят, что вес ссылки (link-juice) не меняется и не отправляется на новый URL-адрес).</li><li>303 (See Other).<br>Перенаправление производится не на новый (только что загруженный) ресурс, а на другую страницу, например, страницу подтверждения или страницу с результатами загрузки.</li><li>307 (Temporary Redirect).<br>Запрошенный ресурс был временно перемещён в URL-адрес, указанный в заголовке <code>Location</code>. Единственное различие между 307 и 302 состоит в том, что 307 гарантирует, что метод и тело не будут изменены при выполнении перенаправленного запроса. В случае с кодом 302 некоторые старые клиенты неправильно меняли метод на <code>GET</code>, из-за чего поведение запросов с методом отличным от <code>GET</code> и ответа с кодом 302 непредсказуемо, тогда как поведение в случае ответа с кодом 307 предсказуемо. Для запросов <code>GET</code> поведение идентично.</li><li>308 (Permanent Redirect).<br>Запрошенный ресурс был окончательно перемещён в URL-адрес, указанный в <code>Location</code>. Браузер перенаправляется на эту страницу, а поисковые системы обновляют свои ссылки на ресурс (в SEO-speak говорится, что link-juice отправляется на новый URL-адрес). Метод запроса и тело не будут изменены, тогда как 301 иногда может быть неправильно заменён на <code>GET</code> метод.</li></ul><p>В примерах я буду приводить шаблон, который вписывается в редактор выражения. Поэтому, можно не щёлкать по удобным кнопочкам, а сразу нажимать <span class="shortcode shortcode-btn d-inline-block"><kbd class=bg-primary>Edit expression</kbd></span> и вписывать нужный шаблон.</p><h2>Переадресация</h2><p>Самый часто используемый тип правил, это правила по работе с переадресацией. Привожу несколько примеров. Их можно брать готовыми и вставлять в редактор выражения, не забыв отредактировать под себя некоторые входные параметры, например, название домена или адрес куда переадресовывать клиентов.</p><h3>Примеры</h3><p>Ниже я привёл примеры, которые позволяют реализовать наиболее популярные правила переадресации запросов.</p><h4>Пути</h4><p>Переадресация запроса с одного ресурса (или страницы) на другой ресурс (или страницу).</p><div class="accordion mb-3" id=sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-4da5c23a70c01e0357db945eeb58856c aria-expanded=false aria-controls=sc-4da5c23a70c01e0357db945eeb58856c aria-label="example.com | www.example.com">example.com | www.example.com</a></div><div class="accordion-collapse collapse" id=sc-4da5c23a70c01e0357db945eeb58856c data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://example.com</code> <code>-></code> <code>https://www.example.com</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-4ca44e8e098566872ed63a84d7e4d555><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.host</span> <span class=n>eq</span> <span class=s2>&#34;example.com&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-4ca44e8e098566872ed63a84d7e4d555 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-53e3324a0d0dfcb6c8a7864e051bd7e0><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://www.&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-53e3324a0d0dfcb6c8a7864e051bd7e0 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-65e1f470f294f716764686ea014cf91b aria-expanded=false aria-controls=sc-65e1f470f294f716764686ea014cf91b aria-label="www.example.com | example.com">www.example.com | example.com</a></div><div class="accordion-collapse collapse" id=sc-65e1f470f294f716764686ea014cf91b data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://www.example.com</code> <code>-></code> <code>https://example.com</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-7551440b996c3e76ad9e625240ffad73><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.host</span> <span class=n>eq</span> <span class=s2>&#34;www.example.com&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-7551440b996c3e76ad9e625240ffad73 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-910b5e11302f006fc00af256db1164a3><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-910b5e11302f006fc00af256db1164a3 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-febc67a9959a8b3e8cea99d37a742ab6 aria-expanded=false aria-controls=sc-febc67a9959a8b3e8cea99d37a742ab6 aria-label="example.com/path | example.org/path">example.com/path | example.org/path</a></div><div class="accordion-collapse collapse" id=sc-febc67a9959a8b3e8cea99d37a742ab6 data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://example.com/path</code> <code>-></code> <code>https://example.org/path</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-d0cad459d3bfb26be95388184a4cfdb8><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.host</span> <span class=n>eq</span> <span class=s2>&#34;example.com&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-d0cad459d3bfb26be95388184a4cfdb8 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-0b6b51bfe440fb568e112e1fbbf6651c><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://example.org&#34;</span><span class=p>,</span> <span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-0b6b51bfe440fb568e112e1fbbf6651c role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-e7146cce901c70f06bbf509d063aa8dd aria-expanded=false aria-controls=sc-e7146cce901c70f06bbf509d063aa8dd aria-label="example.com | example.org">example.com | example.org</a></div><div class="accordion-collapse collapse" id=sc-e7146cce901c70f06bbf509d063aa8dd data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://example.com</code> <code>-></code> <code>https://example.org</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-472587a9368ee1eaf358ccccb89713ee><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.host</span> <span class=n>contains</span> <span class=s2>&#34;example.com&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-472587a9368ee1eaf358ccccb89713ee role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Static</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-9dc4ebf7e185ac33702c7f1da0cd3a61><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>example.org</span><span class=o>/</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-9dc4ebf7e185ac33702c7f1da0cd3a61 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-115d8adc24b69bdff742a771b2219c06 aria-expanded=false aria-controls=sc-115d8adc24b69bdff742a771b2219c06 aria-label="sub.example.com | example.com/sub">sub.example.com | example.com/sub</a></div><div class="accordion-collapse collapse" id=sc-115d8adc24b69bdff742a771b2219c06 data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://sub.example.com</code> <code>-></code> <code>https://example.com/sub</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-be89f09727bfd807732c6f55dd7489f9><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.host</span> <span class=n>eq</span> <span class=s2>&#34;sub.example.com&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-be89f09727bfd807732c6f55dd7489f9 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-2d119200537504103cc3187a6ff1ae5e><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=s2>&#34;/sub&#34;</span><span class=p>,</span> <span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-2d119200537504103cc3187a6ff1ae5e role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-4805926700948c0555a9fa92c1be08aa aria-expanded=false aria-controls=sc-4805926700948c0555a9fa92c1be08aa aria-label="example.com/sub | sub.example.com">example.com/sub | sub.example.com</a></div><div class="accordion-collapse collapse" id=sc-4805926700948c0555a9fa92c1be08aa data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://example.com/sub</code> <code>-></code> <code>https://sub.example.com</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-0e4411f4583ded2ab92883f72574b21f><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>starts_with</span><span class=p>(</span><span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>,</span> <span class=s2>&#34;/sub/&#34;</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-0e4411f4583ded2ab92883f72574b21f role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-08f3bf50c3ffde3469cee680ab13d651><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://sub.&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=n>substring</span><span class=p>(</span><span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-08f3bf50c3ffde3469cee680ab13d651 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Число в функции <code>substring()</code> - это количество символов в названии директории <code>sub</code> + 1 символ.</p></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-f523571d5287dc49f6c6aac2bd751a67 aria-expanded=false aria-controls=sc-f523571d5287dc49f6c6aac2bd751a67 aria-label="example.com/contact-us/ | example.com/contact/">example.com/contact-us/ | example.com/contact/</a></div><div class="accordion-collapse collapse" id=sc-f523571d5287dc49f6c6aac2bd751a67 data-bs-parent=#sc-8ab4d9b981d509c170043eaf3e33169d><div class=accordion-body><p><code>https://example.com/contact-us/</code> <code>-></code> <code>https://example.com/contact/</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-84c7e813318be2fbab6ddc88164a8d62><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span> <span class=n>eq</span> <span class=s2>&#34;/contact-us/&#34;</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-84c7e813318be2fbab6ddc88164a8d62 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Static</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-0dfc2139be5e11abf80a1cfaf91dfc85><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=o>/</span><span class=n>contacts</span><span class=o>/</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-0dfc2139be5e11abf80a1cfaf91dfc85 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div></div><h4>Порты</h4><p>Переадресация в зависимости от запроса, пришедшего на определённый порт.</p><div class="accordion mb-3" id=sc-1e7f43633b262a099fa6041cc87f0e59><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-1f34c94c55757a3d6ac820b7814da161 aria-expanded=false aria-controls=sc-1f34c94c55757a3d6ac820b7814da161 aria-label="Переадресовать запрос к любым портам (кроме '80' и '443') на порт '443' (HTTPS)">Переадресовать запрос к любым портам (кроме '80' и '443') на порт '443' (HTTPS)</a></div><div class="accordion-collapse collapse" id=sc-1f34c94c55757a3d6ac820b7814da161 data-bs-parent=#sc-1e7f43633b262a099fa6041cc87f0e59><div class=accordion-body><p><code>https://example.com:1212</code> <code>-></code> <code>https://example.com</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-4f8a89665d87b2ad3b0a1e1943f787ba><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(</span><span class=ow>not</span> <span class=p>(</span><span class=n>cf.edge</span><span class=p>.</span><span class=n>server_port</span> <span class=kr>in</span> <span class=p>{</span><span class=mi>80</span> <span class=mi>443</span><span class=p>}))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-4f8a89665d87b2ad3b0a1e1943f787ba role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-99ca90b34796c0ad72d7b9092b70be59><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span><span class=p>)</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-99ca90b34796c0ad72d7b9092b70be59 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div></div><h4>Страны</h4><p>Переадресация в зависимости от страны клиента.</p><div class="accordion mb-3" id=sc-117cb8f310c5421d8a243a7237cd0a3d><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-8a72a0bf112130eda4b9e1aae3ce1982 aria-expanded=false aria-controls=sc-8a72a0bf112130eda4b9e1aae3ce1982 aria-label="Переадресовать пользователей из стран RU/BY/UA в директорию '/ru'">Переадресовать пользователей из стран RU/BY/UA в директорию '/ru'</a></div><div class="accordion-collapse collapse" id=sc-8a72a0bf112130eda4b9e1aae3ce1982 data-bs-parent=#sc-117cb8f310c5421d8a243a7237cd0a3d><div class=accordion-body><p><code>https://example.com</code> <code>-></code> <code>https://example.com/ru/</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-345bf9c04cee3331afb7ab70915c6438><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(((</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>eq</span> <span class=s2>&#34;RU&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>eq</span> <span class=s2>&#34;BY&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>eq</span> <span class=s2>&#34;UA&#34;</span><span class=p>))</span> <span class=ow>and</span> <span class=p>(</span><span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span> <span class=n>eq</span> <span class=s2>&#34;/&#34;</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-345bf9c04cee3331afb7ab70915c6438 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-b954c841538b4a79ec4500e07eece140><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>lower</span><span class=p>(</span><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=s2>&#34;/ru/&#34;</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-b954c841538b4a79ec4500e07eece140 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div><div class=accordion-item><div class=accordion-header><a class="accordion-button collapsed" href=# role=button tabindex=0 data-bs-toggle=collapse data-bs-target=#sc-7ad278a62320bdcf38757bade5d649f4 aria-expanded=false aria-controls=sc-7ad278a62320bdcf38757bade5d649f4 aria-label="Переадресовать пользователей НЕ из стран RU/BY/UA в директорию '/en'">Переадресовать пользователей НЕ из стран RU/BY/UA в директорию '/en'</a></div><div class="accordion-collapse collapse" id=sc-7ad278a62320bdcf38757bade5d649f4 data-bs-parent=#sc-117cb8f310c5421d8a243a7237cd0a3d><div class=accordion-body><p><code>https://example.com</code> <code>-></code> <code>https://example.com/en/</code></p><p><strong>When incoming requests match:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-032cb969c481473324b67b893d09b211><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=p>(((</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>ne</span> <span class=s2>&#34;RU&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>ne</span> <span class=s2>&#34;BY&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>ip.src</span><span class=p>.</span><span class=n>country</span> <span class=n>ne</span> <span class=s2>&#34;UA&#34;</span><span class=p>))</span> <span class=ow>and</span> <span class=p>(</span><span class=n>http.request</span><span class=p>.</span><span class=n>uri.path</span> <span class=n>eq</span> <span class=s2>&#34;/&#34;</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-032cb969c481473324b67b893d09b211 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p><strong>Then&mldr;</strong></p><ul><li>Type: <code>Dynamic</code></li><li>Status code: <code>301</code></li></ul><p><strong>URL:</strong></p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-lua"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-f38382632787e10eef5e97842d8a2772><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>lower</span><span class=p>(</span><span class=n>concat</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>http.host</span><span class=p>,</span> <span class=s2>&#34;/en/&#34;</span><span class=p>))</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f38382632787e10eef5e97842d8a2772 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/rule/>#rule</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/cloudflare/>#cloudflare</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-warning" data-bs-tooltip data-bs-title='Уровень сложности: Средний'><i class="far fa-face-meh fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-29T06:55:05Z data-fn=date-local>2023/10/29 06:55:05 UTC</time></li></ul></div></div></div></div></div><div class=col><div class="row row-cols-1 row-cols-lg-2 g-3"><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Работа с переменной среды окружения PATH" class=d-block href=/ru/articles/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/ data-bs-toggle=modal data-bs-target=#modal-899827897f82e6808bc8e4b6d6c02d2d><picture><source srcset='https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1575600749331-6d13fdfe5323?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Работа с переменной среды окружения PATH"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/ data-bs-toggle=modal data-bs-target=#modal-899827897f82e6808bc8e4b6d6c02d2d>Работа с переменной среды окружения PATH</a></h2></div></header><div class=node-body><p>Переменная <code>Path</code> является переменной среды окружения, при помощи которой ОС Windows находит нужные приложения в терминале. Рассмотрим способы редактирования значений этой переменной.</p></div></article><div class="modal fade" id=modal-899827897f82e6808bc8e4b6d6c02d2d tabindex=-1 aria-labelledby=modal-899827897f82e6808bc8e4b6d6c02d2d-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-899827897f82e6808bc8e4b6d6c02d2d-label><a href=/ru/articles/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/>Работа с переменной среды окружения PATH</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Переменная <code>Path</code> является переменной среды окружения, при помощи которой ОС Windows находит нужные приложения в терминале. Рассмотрим способы редактирования значений этой переменной.</p><p>Проще говоря, в переменную <code>Path</code> можно добавлять пути к директориям приложений, для того чтобы при работе в терминале не прописывать полные пути к исполняемым файлам этих приложений. Например, в терминале, чтобы вызвать Git и зафиксировать изменения нужно ввести <code>C:\Apps\Git\git.exe commit -m 'bla-bla'</code>. Но если добавить значение <code>C:\Apps\Git</code> в переменную <code>Path</code>, то в терминале можно просто писать <code>git.exe commit -m 'bla-bla'</code>, больше не нужно указывать полный путь к Git&rsquo;у.</p><h2>Уровни переменной <code>Path</code></h2><p>Существует два уровня переменной <code>Path</code>:</p><ul><li>Системный - является глобальным и его значения доступны для каждого аккаунта пользователя.</li><li>Пользовательский - работает в контексте конкретного аккаунта и содержит значения только этого пользователя. Под другим аккаунтом, переменная на пользовательском уровне может содержать другие значения.</li></ul><p>В пределах аккаунта пользователя эти два уровня переменной <code>Path</code> объединяют свои значения.</p><h2>Добавление значений в переменную <code>Path</code></h2><p>Добавить свои значения в переменную <code>Path</code> можно несколькими способами:</p><ul><li>Графический интерфейс ОС.</li><li>Команда в CMD при помощи утилиты <code>setx</code>.</li><li>Команда в PowerShell.</li></ul><p>Значения в переменной <code>Path</code> разделяются символом <code>;</code>.</p><p>Так как я приверженец работы в терминале и считаю, что каждый администратор должен уметь работать с командной строкой, то привожу только два последних способа.</p><h3>Командная строка CMD</h3><p>Управление переменными среды окружения в CMD происходит при помощи утилиты <code>setx</code>.</p><h4>Системный уровень</h4><p>Чтобы добавить свои значения в переменную <code>Path</code> на системном уровне, необходимо указать ключ <code>/m</code>:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-3a7f026b43ea1540c731daaddbc0fc3e role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-3a7f026b43ea1540c731daaddbc0fc3e><div class=highlight><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=line><span class=cl>setx /m Path <span class=s2>&#34;</span><span class=nv>%Path%</span><span class=s2>C:\Apps\App_01;C:\Apps\App_02&#34;</span></span></span></code></pre></div></div></div></div><div class="shortcode shortcode-alert"><div class="alert alert-danger d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-circle-radiation fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Ни в коем случае нельзя прописывать в <code>setx</code> свои значения БЕЗ вызова переменной <code>Path</code>: при такой команде утилита <code>setx</code> обнулит все существующие значения в <code>Path</code> и запишет указанные вами. А значения, добавленные программами, пропадут.</p><p>Правильная команда должны быть такой:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-batch"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-96e2f99506d146c236c8bcf0618d9f3d><div class=highlight><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=line><span class=cl>setx /m Path <span class=s2>&#34;</span><span class=nv>%Path%</span><span class=s2>C:\MyCustomDir&#34;</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-96e2f99506d146c236c8bcf0618d9f3d role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Здесь мы заранее вызываем переменную <code>Path</code> конструкцией <code>%Path%</code>, которая добавит существующие значения к вашим и всё это дело пропишется утилитой <code>setx</code> обратно в <code>Path</code>.</p></div></div></div><p>Необходимости в скрипте, который добавляет значения в переменную <code>Path</code> на системном уровне, нет. Но я всё же его написал, пусть будет.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>cmd.set.env.path.system.bat</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-7de2c4ddef9c5ccb47f864813ee13570 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=cmd.set.env.path.system.bat download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=cmd.set.env.path.system.bat target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-7de2c4ddef9c5ccb47f864813ee13570><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>:</span><span class=c1>: Setting PATH variable for system.</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>:</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @package   CMD</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @copyright 2023 iHub TO</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @license   MIT</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @version   0.1.0</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @link      https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl><span class=k>setLocal</span> EnableDelayedExpansion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Custom PATH.</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=s2>&#34;pathArray=C:\Apps\App_01 C:\Apps\App_02 C:\Apps\App_03&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Building a system PATH variable.</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=se>%%</span>p <span class=k>in</span> <span class=p>(</span> <span class=nv>%pathArray%</span> <span class=p>)</span> <span class=k>do</span> <span class=p>(</span> <span class=k>set</span> <span class=s2>&#34;pathCustom=</span><span class=se>%%</span><span class=s2>p;!pathCustom!&#34;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Setting a new PATH variable.</span>
</span></span><span class=line><span class=cl>setx /m Path <span class=s2>&#34;</span><span class=nv>%Path%!pathCustom!</span><span class=s2>&#34;</span></span></span></code></pre></div></div></div></div><p>В переменной <code>pathArray</code> указывается массив из путей, которые необходимо добавить в <code>Path</code> на системном уровне.</p><h4>Пользовательский уровень</h4><p>Добавить свои значения в переменную <code>Path</code> на пользовательском уровне:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-b329e4afdfe2718f3c5be4e8a2e44a52 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-b329e4afdfe2718f3c5be4e8a2e44a52><div class=highlight><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=line><span class=cl>setx Path <span class=s2>&#34;</span><span class=nv>%Path%</span><span class=s2>C:\Apps\App_01;C:\Apps\App_02&#34;</span></span></span></code></pre></div></div></div></div><p>Но есть одна особенность: так как переменная <code>Path</code> объединяет значения системного и пользовательского уровней, то при такой команде, утилита <code>setx</code> пропишет в <code>Path</code> пользовательского уровня все значения из системного. Таким образом, получится дублирование содержимого <code>Path</code> системного уровня в пользовательском. Это не критично, но можно сделать более элегантно&mldr;</p><p>Для того, чтобы обойти вышеуказанную особенность, необходимо написать скрипт, который будет при вызове переменной <code>Path</code> вырезать из неё значения системного уровня. Собственно, скрипт я написал.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>cmd.set.env.path.user.bat</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-ea2113b3e80502e09dab1e73579fe31a role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=cmd.set.env.path.user.bat download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=cmd.set.env.path.user.bat target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-ea2113b3e80502e09dab1e73579fe31a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>:</span><span class=c1>: Setting PATH variable for user.</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>:</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @package   CMD</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @author    Kitsune Solar &lt;mail@kitsune.solar&gt;</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @copyright 2023 iHub TO</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @license   MIT</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @version   0.1.0</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: @link      https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: ------------------------------------------------------------------------------------------------------------------ ::</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl><span class=k>setLocal</span> EnableDelayedExpansion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Custom PATH.</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=s2>&#34;pathArray=C:\Apps\App_01 C:\Apps\App_02 C:\Apps\App_03&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Getting the current PATH variable.</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/f</span> <span class=s2>&#34;tokens=2,*&#34;</span> <span class=se>%%</span>a <span class=k>in</span> <span class=p>(</span> <span class=s1>&#39;reg query HKCU\Environment /v Path&#39;</span> <span class=p>)</span> <span class=k>do</span> <span class=p>(</span> <span class=k>set</span> <span class=s2>&#34;pathUser=</span><span class=se>%%</span><span class=s2>b&#34;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Building a user PATH variable.</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=se>%%</span>p <span class=k>in</span> <span class=p>(</span> <span class=nv>%pathArray%</span> <span class=p>)</span> <span class=k>do</span> <span class=p>(</span> <span class=k>set</span> <span class=s2>&#34;pathCustom=</span><span class=se>%%</span><span class=s2>p;!pathCustom!&#34;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Setting a new PATH variable.</span>
</span></span><span class=line><span class=cl>setx Path <span class=s2>&#34;</span><span class=nv>!pathUser!!pathCustom!</span><span class=s2>&#34;</span></span></span></code></pre></div></div></div></div><p>В переменной <code>pathArray</code> указывается массив из путей, которые необходимо добавить в <code>Path</code> на пользовательском уровне. При этом, добавление значений из системного уровня не произойдёт. Наша переменная <code>Path</code> пользовательского уровня останется чистенькой и красивой.</p><h3>Терминал PowerShell</h3><p>В PowerShell для управления переменными окружения существуют методы:</p><ul><li><code>[Environment]::GetEnvironmentVariables()</code> - получение значения переменной среды окружения.</li><li><code>[Environment]::SetEnvironmentVariable()</code> - установка значения переменной среды окружения.</li></ul><h4>Системный уровень</h4><p>Для добавления значений в переменную <code>Path</code> на системном уровне, я написал небольшой скрипт.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.set.env.path.system.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-bdc3dd2227bec3e22b675681d0a268a3 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.set.env.path.system.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.set.env.path.system.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-bdc3dd2227bec3e22b675681d0a268a3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         41643d28-3808-4a6f-a322-d87ed4384d5f
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-RunAsAdministrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Setting PATH variable for system.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  The script configures the PATH variable values for the system.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.set.env.path.system.ps1 -P &#39;C:\Apps\App_01&#39;, &#39;C:\Apps\App_02&#39;, &#39;C:\Apps\App_03&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Set-EnvPathSystem</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>Environment</span><span class=p>]::</span><span class=n>SetEnvironmentVariable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Path&#39;</span><span class=p>,</span> <span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>GetEnvironmentVariables</span><span class=p>(</span><span class=s1>&#39;Machine&#39;</span><span class=p>)).</span><span class=py>Path</span> <span class=p>+</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span> <span class=p>+</span> <span class=p>[</span><span class=no>IO.Path</span><span class=p>]::</span><span class=n>PathSeparator</span><span class=p>,</span> <span class=s1>&#39;Machine&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Set-EnvPathSystem</span></span></span></code></pre></div></div></div></div><p>Вызов скрипта осуществляется следующим образом:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-2 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-03d371bc5d93b3e9a69449c38c2eb50d role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-03d371bc5d93b3e9a69449c38c2eb50d><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>set</span><span class=p>.</span><span class=py>env</span><span class=p>.</span><span class=py>path</span><span class=p>.</span><span class=py>system</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-P</span> <span class=s1>&#39;C:\Apps\App_01&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_02&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_03&#39;</span></span></span></code></pre></div></div></div></div><p>В параметре <code>-P</code> указываются значения, которые необходимо добавить в переменную <code>Path</code> системного уровня.</p><h4>Пользовательский уровень</h4><p>А здесь скрипт, который отвечает за добавление в переменную <code>Path</code> значений на пользовательском уровне.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.set.env.path.user.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-031fb6cdb3bd6f0135e0ff3c0ee8ed43 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.set.env.path.user.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.set.env.path.user.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-031fb6cdb3bd6f0135e0ff3c0ee8ed43><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         79f23918-308a-412c-8835-b1bb9c9193e3
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Setting PATH variable for user.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  The script configures the PATH variable values for the user.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.set.env.path.user.ps1 -P &#39;C:\Apps\App_01&#39;, &#39;C:\Apps\App_02&#39;, &#39;C:\Apps\App_03&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Set-EnvPathUser</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>Environment</span><span class=p>]::</span><span class=n>SetEnvironmentVariable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Path&#39;</span><span class=p>,</span> <span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>GetEnvironmentVariables</span><span class=p>(</span><span class=s1>&#39;User&#39;</span><span class=p>)).</span><span class=py>Path</span> <span class=p>+</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span> <span class=p>+</span> <span class=p>[</span><span class=no>IO.Path</span><span class=p>]::</span><span class=n>PathSeparator</span><span class=p>,</span> <span class=s1>&#39;User&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Set-EnvPathUser</span></span></span></code></pre></div></div></div></div><p>Вызов скрипта осуществляется следующим образом:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-3 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-45098f06e8343af24a7714aabaf02734 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-45098f06e8343af24a7714aabaf02734><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>set</span><span class=p>.</span><span class=py>env</span><span class=p>.</span><span class=py>path</span><span class=p>.</span><span class=py>user</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-P</span> <span class=s1>&#39;C:\Apps\App_01&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_02&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_03&#39;</span></span></span></code></pre></div></div></div></div><p>В параметре <code>-P</code> указываются значения, которые необходимо добавить в переменную <code>Path</code> пользовательского уровня.</p><h4>Общий скрипт</h4><p>Не знаю, почему я сразу не написал общий скрипт для всех уровней&mldr; Решил под завершение статьи реализовать подобную штуку.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.set.env.path.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-27ff2bd0c652ff1f08db3d7954ffde09 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.set.env.path.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.set.env.path.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-27ff2bd0c652ff1f08db3d7954ffde09><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         14efdc7d-1edd-4b40-b6d2-623288ce1659
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Setting the PATH variable.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  The script configures the PATH variable values.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.set.env.path.ps1 -P &#39;C:\Apps\App_01&#39;, &#39;C:\Apps\App_02&#39;, &#39;C:\Apps\App_03&#39; -T &#39;Machine&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.set.env.path.ps1 -P &#39;C:\Apps\App_01&#39;, &#39;C:\Apps\App_02&#39;, &#39;C:\Apps\App_03&#39; -T &#39;User&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/1f062637-3227-56d7-93e3-126d1c80f5a8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s1>&#39;Machine&#39;</span><span class=p>,</span> <span class=s1>&#39;User&#39;</span><span class=p>)][</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$Target</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Set-EnvPath</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>Environment</span><span class=p>]::</span><span class=n>SetEnvironmentVariable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Path&#39;</span><span class=p>,</span> <span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>GetEnvironmentVariables</span><span class=p>(</span><span class=s2>&#34;</span><span class=nv>${Target}</span><span class=s2>&#34;</span><span class=p>)).</span><span class=py>Path</span> <span class=p>+</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span> <span class=p>+</span> <span class=p>[</span><span class=no>IO.Path</span><span class=p>]::</span><span class=n>PathSeparator</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${Target}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Set-EnvPath</span></span></span></code></pre></div></div></div></div><p>Вызывается скрипт обычным способом:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-4 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-cb7428b46c59d88fd927378d35f879ca role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-cb7428b46c59d88fd927378d35f879ca><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>set</span><span class=p>.</span><span class=py>env</span><span class=p>.</span><span class=py>path</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-P</span> <span class=s1>&#39;C:\Apps\App_01&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_02&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Apps\App_03&#39;</span> <span class=n>-T</span> <span class=s1>&#39;User&#39;</span></span></span></code></pre></div></div></div></div><p>Но отличается от выше приведённых скриптов дополнительным параметром <code>-T</code>, который указывает уровень переменной <code>Path</code> и может принимать следующие значения:</p><ul><li><code>Machine</code> - для системного уровня.</li><li><code>User</code> - для пользовательского уровня.</li></ul></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/cmd/>#cmd</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/batch/>#batch</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/path/>#path</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-28T12:27:07Z data-fn=date-local>2023/10/28 12:27:07 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Автоматическая настройка Windows Server 2022 под рабочую станцию" class=d-block href=/ru/articles/2023/10/fb64d665-3e56-5fa5-a9eb-2e2e251949d8/ data-bs-toggle=modal data-bs-target=#modal-76167fb435445bcf9e0f5dbe3c74ca78><picture><source srcset='https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1603969409447-ba86143a03f6?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Автоматическая настройка Windows Server 2022 под рабочую станцию"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/fb64d665-3e56-5fa5-a9eb-2e2e251949d8/ data-bs-toggle=modal data-bs-target=#modal-76167fb435445bcf9e0f5dbe3c74ca78>Автоматическая настройка Windows Server 2022 под рабочую станцию</a></h2></div></header><div class=node-body><p>Ранее я уже публиковал инструкцию по превращению серверной ОС в ОС для рабочей станции. Но этот процесс можно автоматизировать при помощи PowerShell.</p></div></article><div class="modal fade" id=modal-76167fb435445bcf9e0f5dbe3c74ca78 tabindex=-1 aria-labelledby=modal-76167fb435445bcf9e0f5dbe3c74ca78-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-76167fb435445bcf9e0f5dbe3c74ca78-label><a href=/ru/articles/2023/10/fb64d665-3e56-5fa5-a9eb-2e2e251949d8/>Автоматическая настройка Windows Server 2022 под рабочую станцию</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Ранее я уже публиковал инструкцию по превращению серверной ОС в ОС для рабочей станции. Но этот процесс можно автоматизировать при помощи PowerShell.</p><p>В статье <span class="shortcode shortcode-uuid"><a href=/ru/articles/2022/05/36058650-3f35-5ed5-9565-0aa7d8800c28/>Windows Server 2022 для рабочей станции</a></span> рассматривалось ручная адаптация Windows Server 2022 под рабочую станцию. Я решил написать специальный скрипт, который берёт на себя часть действий. Но окончательная настройка, например, такая как редактирование GPO остаётся за пользователем.</p><h2>Автоматизация</h2><p>Рассмотрим скрипт по адаптации серверной ОС под рабочую станцию.</p><h3>Примеры</h3><p>Скрипт требует административных прав доступа, поэтому его необходимо запускать под аккаунтом администратора.</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-940c632e0aaeb95441ac062699861266 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-940c632e0aaeb95441ac062699861266><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>win</span><span class=p>.</span><span class=py>srv</span><span class=p>.</span><span class=py>ws</span><span class=p>.</span><span class=n>ps1</span></span></span></code></pre></div></div></div></div><h3>Алгоритм работы</h3><ul><li>Включение дополнительных компонентов Windows.</li><li>Настройка необходимых для рабочей станции служб.</li><li>Отключение <strong>IE Enhanced Security Configuration</strong> для аккаунтов администраторов и пользователей.</li><li>Переключение приоритета процессора в сторону приложений.</li><li>Настройка <strong>MMAgent</strong>.</li><li>Переключение <strong>DEP</strong> только на программы Windows и службы.</li></ul><h3>Скрипт</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.win.srv.ws.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-007f7430b2184abb303ae77baad9bb7a role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.win.srv.ws.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.win.srv.ws.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-007f7430b2184abb303ae77baad9bb7a><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         c050355b-ecbd-4b13-b805-3a422dc0c995
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/fb64d665-3e56-5fa5-a9eb-2e2e251949d8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-RunAsAdministrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Windows Server configuration script.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  The script allows you to set up Windows Server as a workstation.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.win.srv.ws.ps1
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/fb64d665-3e56-5fa5-a9eb-2e2e251949d8/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-FeatureConfig</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-ServiceConfig</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-IEConfig</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-PriorityControlConfig</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-MMAgentConfig</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DEPConfig</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURING FEATURES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-FeatureConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=p>=</span> <span class=s1>&#39;Wireless-Networking&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Install-WindowsFeature</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURING SERVICES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-ServiceConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Name</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;Audiosrv&#39;</span><span class=p>,</span> <span class=s1>&#39;AudioEndpointBuilder&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Name</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Name</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=n>StartupType</span> <span class=p>=</span> <span class=s1>&#39;Automatic&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>Set-Service</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$WSearch</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=p>=</span> <span class=s1>&#39;WSearch&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>StartupType</span> <span class=p>=</span> <span class=s1>&#39;AutomaticDelayedStart&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Set-Service</span> <span class=nv>@WSearch</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># DISABLE IE ENHANCED SECURITY CONFIGURATION (ESC).</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-IEConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>LiteralPath</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=n>Name</span> <span class=p>=</span> <span class=s1>&#39;IsInstalled&#39;</span>
</span></span><span class=line><span class=cl>      <span class=n>Value</span> <span class=p>=</span> <span class=mf>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${_}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Set-ItemProperty</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Host</span> <span class=s1>&#39;IE Enhanced Security Configuration (ESC) has been disabled.&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;&#39;</span><span class=nv>${_}</span><span class=s2>&#39; not found!&#34;</span> <span class=n>-ErrorAction</span> <span class=s1>&#39;Stop&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># ADJUST PROCESSOR RESOURCES FOR BEST PERFORMANCE OF PROGRAMS.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-PriorityControlConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>=</span> <span class=s1>&#39;HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LiteralPath</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=p>=</span> <span class=s1>&#39;Win32PrioritySeparation&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Value</span> <span class=p>=</span> <span class=mf>38</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Set-ItemProperty</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;&#39;</span><span class=nv>${Path}</span><span class=s2>&#39; not found!&#34;</span> <span class=n>-ErrorAction</span> <span class=s1>&#39;Stop&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURING MMAGENT.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-MMAgentConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MemoryCompression</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>    <span class=n>OperationAPI</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>    <span class=n>PageCombining</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Enable-MMAgent</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURING DEP.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DEPConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cmd</span><span class=p>.</span><span class=py>exe</span> <span class=p>/</span><span class=n>c</span> <span class=s1>&#39;bcdedit.exe /set {current} nx OptIn&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/workstation/>#workstation</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/server/>#server</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-27T19:46:08Z data-fn=date-local>2023/10/27 19:46:08 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Восстановление доверительных отношений между PC и Active Directory" class=d-block href=/ru/articles/2023/10/38fc94dd-8d37-5f9e-b556-676304976a9f/ data-bs-toggle=modal data-bs-target=#modal-327990f6c9bdc2cf482551861c095762><picture><source srcset='https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1477383384651-442903132e79?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Восстановление доверительных отношений между PC и Active Directory"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/38fc94dd-8d37-5f9e-b556-676304976a9f/ data-bs-toggle=modal data-bs-target=#modal-327990f6c9bdc2cf482551861c095762>Восстановление доверительных отношений между PC и Active Directory</a></h2></div></header><div class=node-body><p>Рассмотрим способы решения распространённой проблемы потери доверительных отношений между рабочей станцией и доменом Active Directory. Из-за этой проблемы пользователь не может авторизоваться под своей учётной записью.</p></div></article><div class="modal fade" id=modal-327990f6c9bdc2cf482551861c095762 tabindex=-1 aria-labelledby=modal-327990f6c9bdc2cf482551861c095762-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-327990f6c9bdc2cf482551861c095762-label><a href=/ru/articles/2023/10/38fc94dd-8d37-5f9e-b556-676304976a9f/>Восстановление доверительных отношений между PC и Active Directory</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Рассмотрим способы решения распространённой проблемы потери доверительных отношений между рабочей станцией и доменом Active Directory. Из-за этой проблемы пользователь не может авторизоваться под своей учётной записью.</p><p>При попытке входа пользователя под доменной учётной записью, могут произойти следующие ошибки.</p><div class="shortcode shortcode-window"><div class="card text-bg-danger mb-3 overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-computer fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Trust relationship</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li></ul></div></div></div><div class=card-body><p>The trust relationship between this workstation and the primary domain failed.</p><p>(Не удалось восстановить доверительные отношения между рабочей станцией и доменом.)</p></div></div></div><div class="shortcode shortcode-window"><div class="card text-bg-danger mb-3 overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-computer fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Security database</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li><li class=list-inline-item><i class="fas fa-circle fa-fw"></i></li></ul></div></div></div><div class=card-body><p>The security database on the server does not have a computer account for this workstation trust relationship.</p><p>(База данных диспетчера учетных записей на сервере не содержит записи для регистрации компьютера через доверительные отношения с этой рабочей станцией.)</p></div></div></div><p>Ошибка может возникнуть по различным факторам. Например, когда новый компьютер присоединился к домену под уже существующем именем другого компьютера, или когда виртуальная машина восстановилась с контрольной точки.</p><h2>Ручной способ</h2><p>Для того, чтобы исправить ошибку, необходимо последовательно выполнить следующие пункты:</p><ol><li>Сбросить аккаунт компьютера в Active Directory.</li><li>На проблемном компьютере зайти под локальным администратором и вывести компьютер из домена в рабочую группу.</li><li>Перезагрузить компьютер.</li><li>Вывести компьютер из рабочей группы и ввести обратно в домен.</li><li>Еще раз перезагрузить компьютер.</li></ol><h2>Автоматизация</h2><p>Как обычно, привожу скрипт по автоматизации восстановления доверительных отношений. Скрипт решит проблему быстро и без перезагрузок. Запускается под администратором.</p><h3>Параметры</h3><p>Параметр у скрипта один, это название сервера DC.</p><ul><li><code>-S</code> <code>-P_Server</code> - название сервера DC (контроллера домена). Если параметр не задан, скрипт выбирает для операции контроллер домена по умолчанию.</li></ul><h3>Примеры</h3><p>Восстановить доверительные отношения с доменом по умолчанию:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-02a053a6d0b854af7a16a9df73f3f459 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-02a053a6d0b854af7a16a9df73f3f459><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>csc</span><span class=p>.</span><span class=py>repair</span><span class=p>.</span><span class=n>ps1</span></span></span></code></pre></div></div></div></div><p>Восстановить доверительные отношения с доменом <code>DC-server.domain.com</code>:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-48f3a1c34da8785727efcfa3d24d41ed role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-48f3a1c34da8785727efcfa3d24d41ed><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>csc</span><span class=p>.</span><span class=py>repair</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-DC</span> <span class=s1>&#39;DC-server.domain.com&#39;</span></span></span></code></pre></div></div></div></div><h3>Алгоритм работы</h3><ul><li>Запускается проверка доверительных отношений при помощи cmdlet&rsquo;а <code>Test-ComputerSecureChannel</code>.</li><li>Если проверка пройдена, скрипт завершает работу.</li><li>Если проверка не пройдена, запускается цикл восстановления доверительных отношений с контроллером домена с временным интервалом в 5 секунд.</li></ul><h3>Скрипт</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.csc.repair.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-4d57fec37fd5a098dad4f7572df9d386 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.csc.repair.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.csc.repair.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-4d57fec37fd5a098dad4f7572df9d386><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         52672f5d-e2c0-467a-ae1d-c0fc9009a1eb
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/38fc94dd-8d37-5f9e-b556-676304976a9f/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-RunAsAdministrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Testing and repairing the secure channel between the local computer and its domain.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Verifying that the channel between the local computer and its domain is working correctly by checking the status of its trust relationships. If a connection fails, trying to restore it.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Server
</span></span></span><span class=line><span class=cl><span class=cm>  Specifies the domain controller to run the command. If this parameter is not specified, this script selects a default domain controller for the operation.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Sleep
</span></span></span><span class=line><span class=cl><span class=cm>  Sleep time (in seconds).
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.csc.repair.ps1
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.csc.repair.ps1 -DC &#39;DC-server.domain.com&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/38fc94dd-8d37-5f9e-b556-676304976a9f/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Specifies the domain controller to run the command.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;DC&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Server</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Sleep time (in seconds).&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;S&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_Sleep</span> <span class=p>=</span> <span class=mf>5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-CSCRepair</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># EDITING THE REGISTRY.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-CSCRepair</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Server</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${P_Server}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Repair</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>    <span class=n>Credential</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-Credential</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Test-ComputerSecureChannel</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Host</span> <span class=s1>&#39;Connection successful. Everything is fine!&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Host</span> <span class=s1>&#39;Connection failed! The secure channel between the local computer and the domain is broken. Removing and then rebuilds the channel established by the NetLogon service...&#39;</span>
</span></span><span class=line><span class=cl>      <span class=nb>Test-ComputerSecureChannel</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>      <span class=nb>Start-Sleep</span> <span class=n>-s</span> <span class=nv>$P_Sleep</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>until</span> <span class=p>(</span><span class=nb>Test-ComputerSecureChannel</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/domain/>#domain</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/ad/>#ad</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-27T09:25:25Z data-fn=date-local>2023/10/27 09:25:25 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Изменение порта RDP" class=d-block href=/ru/articles/2023/10/616da78a-eb16-575a-9119-65f0c0c7baee/ data-bs-toggle=modal data-bs-target=#modal-37b4eb3be87fad5d3e6985a99831f905><picture><source srcset='https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1509483730228-811e47696246?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Изменение порта RDP"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/616da78a-eb16-575a-9119-65f0c0c7baee/ data-bs-toggle=modal data-bs-target=#modal-37b4eb3be87fad5d3e6985a99831f905>Изменение порта RDP</a></h2></div></header><div class=node-body><p>По умолчанию, RDP использует порт TCP <code>3389</code>, но по каким-либо обстоятельствам приходится его менять. Рассмотрим два способа изменения порта RDP.</p></div></article><div class="modal fade" id=modal-37b4eb3be87fad5d3e6985a99831f905 tabindex=-1 aria-labelledby=modal-37b4eb3be87fad5d3e6985a99831f905-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-37b4eb3be87fad5d3e6985a99831f905-label><a href=/ru/articles/2023/10/616da78a-eb16-575a-9119-65f0c0c7baee/>Изменение порта RDP</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>По умолчанию, RDP использует порт TCP <code>3389</code>, но по каким-либо обстоятельствам приходится его менять. Рассмотрим два способа изменения порта RDP.</p><h2>Ручное изменение порта</h2><p>Для изменения порта RDP, нужно отредактировать реестр:</p><ol><li>Открыть редактор реестра <code>regedit.exe</code>.</li><li>Пройти по пути <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp</code>.</li><li>Найти параметр <code>PortNumber</code>.</li><li>Ввести новый номер порта (decimal).</li><li>Перезагрузить компьютер.</li></ol><div class="shortcode shortcode-alert"><div class="alert alert-warning d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-exclamation-triangle fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Если включён брандмауэр, необходимо в нём разрешить подключение через новый порт RDP.</p></div></div></div><h2>Автоматизация</h2><p>Весь процесс можно автоматизировать при помощи скрипта.</p><h3>Параметры</h3><p>Скрипт имеет один единственный параметр, это номер порта.</p><ul><li><code>-P</code> <code>-P_Port</code> - номер порта RDP.</li></ul><h3>Примеры</h3><p>Запускается скрипт обычным способом. В параметре <code>-P</code> указывается новый номер порта RDP.</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-49080f77e80da8f76fc20e063f3e9428 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-49080f77e80da8f76fc20e063f3e9428><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>rdp</span><span class=p>.</span><span class=py>port</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-P</span> <span class=mf>50102</span></span></span></code></pre></div></div></div></div><h3>Алгоритм работы</h3><ul><li>Проверяется в реестре корректность пути и изменяется номер порта RDP. Если путь не найден, то скрипт аварийно завершает работу без дальнейших изменений.</li><li>В брандмауэр вносится два правила, которые разрешают подключение к новому порту RDP.</li><li>Если служба <code>TermService</code> (служба удаленных рабочих столов) запущена, она перезапускается, применяя новые параметры порта RDP.</li></ul><h3>Скрипт</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.rdp.port.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-497b4182daeb3f1a37db9ee665eb4373 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.rdp.port.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.rdp.port.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-497b4182daeb3f1a37db9ee665eb4373><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         5d2bddd9-4eed-42f0-a0ba-7d30efcb81e2
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/616da78a-eb16-575a-9119-65f0c0c7baee/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-RunAsAdministrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Changing the RDP port number.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Changing the listening port for Remote Desktop on your computer.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Port
</span></span></span><span class=line><span class=cl><span class=cm>  RDP port number.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: 3389.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.rdp.port.ps1 -P 50102
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/616da78a-eb16-575a-9119-65f0c0c7baee/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;RDP port number.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>ValidatePattern</span><span class=p>(</span><span class=s1>&#39;^[0-9]+$&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_Port</span> <span class=p>=</span> <span class=mf>3389</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-RdpRegistry</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-RdpFirewall</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-RdpService</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># EDITING THE REGISTRY.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-RdpRegistry</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Path</span> <span class=p>=</span> <span class=s1>&#39;HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LiteralPath</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=p>=</span> <span class=s1>&#39;PortNumber&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Value</span> <span class=p>=</span> <span class=nv>$P_Port</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Set-ItemProperty</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;&#39;</span><span class=nv>${Path}</span><span class=s2>&#39; not found!&#34;</span> <span class=n>-ErrorAction</span> <span class=s1>&#39;Stop&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># EDITING THE FIREWALL.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-RdpFirewall</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$TCP</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DisplayName</span> <span class=p>=</span> <span class=s1>&#39;Custom RDP Port (TCP-In)&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Profile</span> <span class=p>=</span> <span class=s1>&#39;Public&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Direction</span> <span class=p>=</span> <span class=n>Inbound</span>
</span></span><span class=line><span class=cl>    <span class=n>Action</span> <span class=p>=</span> <span class=n>Allow</span>
</span></span><span class=line><span class=cl>    <span class=n>Protocol</span> <span class=p>=</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>    <span class=n>LocalPort</span> <span class=p>=</span> <span class=nv>$P_Port</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$UDP</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DisplayName</span> <span class=p>=</span> <span class=s1>&#39;Custom RDP Port (UDP-In)&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Profile</span> <span class=p>=</span> <span class=s1>&#39;Public&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Direction</span> <span class=p>=</span> <span class=n>Inbound</span>
</span></span><span class=line><span class=cl>    <span class=n>Action</span> <span class=p>=</span> <span class=n>Allow</span>
</span></span><span class=line><span class=cl>    <span class=n>Protocol</span> <span class=p>=</span> <span class=n>UDP</span>
</span></span><span class=line><span class=cl>    <span class=n>LocalPort</span> <span class=p>=</span> <span class=nv>$P_Port</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>New-NetFirewallRule</span> <span class=nv>@TCP</span>
</span></span><span class=line><span class=cl>  <span class=nb>New-NetFirewallRule</span> <span class=nv>@UDP</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># RESTARTING THE REMOTE DESKTOP SERVICES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-RdpService</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Name</span> <span class=p>=</span> <span class=s1>&#39;TermService&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Force</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=nb>Get-Service</span> <span class=n>-Name</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span><span class=p>).</span><span class=py>Status</span> <span class=o>-eq</span> <span class=s1>&#39;Running&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Restart-Service</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;Service &#39;</span><span class=nv>${Name}</span><span class=s2>&#39; not running!&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/rdp/>#rdp</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-26T23:35:50Z data-fn=date-local>2023/10/26 23:35:50 UTC</time></li></ul></div></div></div></div></div></div></div><div class=col><div class="row row-cols-1 row-cols-lg-3 g-3"><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="PowerShell: Полезные функции" class=d-block href=/ru/articles/2023/10/c6e32349-8fc2-53f9-9a42-790878a64076/ data-bs-toggle=modal data-bs-target=#modal-33c4a8b583ce3c25aeeb390b7fb1ab0d><picture><source srcset='https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="PowerShell: Полезные функции"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/c6e32349-8fc2-53f9-9a42-790878a64076/ data-bs-toggle=modal data-bs-target=#modal-33c4a8b583ce3c25aeeb390b7fb1ab0d>PowerShell: Полезные функции</a></h2></div></header><div class=node-body><p>Полезные функции PowerShell, которые я пишу сам или нахожу в интернете. Очень помогает в работе и в скриптах.</p></div></article><div class="modal fade" id=modal-33c4a8b583ce3c25aeeb390b7fb1ab0d tabindex=-1 aria-labelledby=modal-33c4a8b583ce3c25aeeb390b7fb1ab0d-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-33c4a8b583ce3c25aeeb390b7fb1ab0d-label><a href=/ru/articles/2023/10/c6e32349-8fc2-53f9-9a42-790878a64076/>PowerShell: Полезные функции</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Полезные функции PowerShell, которые я пишу сам или нахожу в интернете. Очень помогает в работе и в скриптах.</p><h2>Найти файлы старше X дней с момента создания</h2><p>Функция позволяет найти и вывести элементы старше X дней по свойству <code>CreationTime</code>.</p><h3>Параметры</h3><ul><li><code>-P</code> - путь к директории, в которой необходимо найти файлы.</li><li><code>-T</code> - время, прошедшее с момента создания файла (в секундах).</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.find.ct.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-b929b9a34b07856f8bebfaa33972cae3 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.find.ct.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.find.ct.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-b929b9a34b07856f8bebfaa33972cae3><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>long</span><span class=p>]</span><span class=nv>$Time</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Find-CreationTime</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=o>-File</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Sort-Object</span> <span class=n>-Property</span> <span class=s1>&#39;LastAccessTime&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>CreationTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$Time</span><span class=p>)))</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Find-CreationTime</span></span></span></code></pre></div></div></div></div><div class="shortcode shortcode-alert"><div class="alert alert-success d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-lightbulb fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p><code>.AddSeconds</code> можно заменить на <code>.AddDays</code>, чтобы отсчитывать дату не в секундах, а в днях.</p></div></div></div><h2>Найти файлы старше X дней с момента изменения</h2><p>Функция позволяет найти и вывести элементы старше X дней по свойству <code>LastWriteTime</code>.</p><h3>Параметры</h3><ul><li><code>-P</code> - путь к директории, в которой необходимо найти файлы.</li><li><code>-T</code> - время, прошедшее с момента изменения файла (в секундах).</li></ul><div class="shortcode shortcode-alert"><div class="alert alert-success d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-lightbulb fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p><code>.AddSeconds</code> можно заменить на <code>.AddDays</code>, чтобы отсчитывать дату не в секундах, а в днях.</p></div></div></div><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.find.lwt.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-9085efb2f128b3901f2cea4ad04489a6 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.find.lwt.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.find.lwt.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-9085efb2f128b3901f2cea4ad04489a6><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>long</span><span class=p>]</span><span class=nv>$Time</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Find-LastWriteTime</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=o>-File</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Sort-Object</span> <span class=n>-Property</span> <span class=s1>&#39;LastAccessTime&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>LastWriteTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$Time</span><span class=p>)))</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Find-LastWriteTime</span></span></span></code></pre></div></div></div></div><h2>Создать новый элемент</h2><p>Функция позволяет создавать элементы. Ничего экстраординарного здесь нет, просто функция, укорачивающая стандартный cmdlet <code>New-Item</code>.</p><h3>Параметры</h3><ul><li><code>-T</code> - тип элемента.<ul><li><code>'D'</code> - директория.</li><li><code>'F'</code> - файл.</li></ul></li><li><code>-P</code> - путь к директории, в которой необходимо создать элемент.</li><li><code>-N</code> - название элемента.</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.new.item.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-3250844574d13b6559bb736daedfa328 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.new.item.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.new.item.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-3250844574d13b6559bb736daedfa328><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;SilentlyContinue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>New-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Directory&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;F&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;File&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>New-Item</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span> <span class=n>-ItemType</span> <span class=s2>&#34;</span><span class=nv>${Type}</span><span class=s2>&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>New-Data</span></span></span></code></pre></div></div></div></div><h2>Проверить существование элемента</h2><p>Функция позволяет &ldquo;безопасно&rdquo; проверить существование элемента. Применяется параметр <code>-LiteralPath</code>, который интерпретирует путь без какой-либо обработки.</p><h3>Параметры</h3><ul><li><code>-T</code> - тип элемента.</li><li><code>-P</code> - путь к директории, в которой необходимо проверить элемент.</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.test.item.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-88067a5a4a6e92646703d180b5b15688 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.test.item.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.test.item.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-88067a5a4a6e92646703d180b5b15688><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Test-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Container&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;F&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Leaf&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-PathType</span> <span class=s2>&#34;</span><span class=nv>${Type}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Test-Data</span></span></span></code></pre></div></div></div></div><h2>Проверить существование модуля</h2><p>Функция позволяет проверить существование модуля PowerShell в памяти компьютера.</p><h3>Параметры</h3><ul><li><code>-N</code> - название модуля.</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.test.module.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-cb67cc16eb6403ef7b7857d8e8d4dc95 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.test.module.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.test.module.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-cb67cc16eb6403ef7b7857d8e8d4dc95><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$Names</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;Stop&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Test-Module</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>ForEach</span> <span class=p>(</span><span class=nv>$Name</span> <span class=k>in</span> <span class=nv>$Names</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=p>(</span><span class=nb>Get-Module</span> <span class=n>-ListAvailable</span> <span class=n>-Name</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;Module &#39;</span><span class=nv>${Name}</span><span class=s2>&#39; not installed!&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Test-Module</span></span></span></code></pre></div></div></div></div><h2>Вывести сообщение в терминал</h2><p>Функция выводит информацию в терминал по типу сообщений.</p><h3>Параметры</h3><ul><li><code>-T</code> - тип сообщения.<ul><li><code>'HL'</code> - заголовок.</li><li><code>'I'</code> - информационное сообщение.</li><li><code>'W'</code> - предупреждение (warning).</li><li><code>'E'</code> - ошибка (error).</li></ul></li><li><code>-M</code> - текст сообщения.</li><li><code>-A</code> - действие, которое необходимо выполнить при выводе сообщения в терминал.</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.write.msg.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f3f90df993c969074554341ea21cdb9b role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.write.msg.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.write.msg.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-f3f90df993c969074554341ea21cdb9b><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;Continue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Write-Msg</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;HL&#39;</span>    <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${NL}</span><span class=s2>--- </span><span class=nv>${Message}</span><span class=s2>&#34;</span><span class=p>.</span><span class=py>ToUpper</span><span class=p>()</span> <span class=n>-ForegroundColor</span> <span class=n>Blue</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;I&#39;</span>     <span class=p>{</span> <span class=nb>Write-Information</span> <span class=n>-MessageData</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-InformationAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;W&#39;</span>     <span class=p>{</span> <span class=nb>Write-Warning</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-WarningAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;E&#39;</span>     <span class=p>{</span> <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span> <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Write-Msg</span></span></span></code></pre></div></div></div></div><h2>Найти свободную букву диска</h2><p>Небольшая функция, которая возвращает не занятую букву диска. Используется в <span class="shortcode shortcode-uuid"><a href=/ru/articles/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/>PowerShell: Стирание диска</a></span>.</p><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.find.adl.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-ae14863d59858eeb350ccde46cbaedfd role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.find.adl.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.find.adl.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-ae14863d59858eeb350ccde46cbaedfd><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Find-AvailableDriveLetter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=mf>68</span><span class=p>.</span><span class=mf>.90</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span> <span class=nv>$L</span><span class=p>=[</span><span class=no>char</span><span class=p>]</span><span class=nv>$_</span><span class=p>;</span> <span class=k>if</span> <span class=p>((</span><span class=nb>Get-PSDrive</span><span class=p>).</span><span class=py>Name</span> <span class=o>-notContains</span> <span class=nv>$L</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$L</span> <span class=p>}</span> <span class=p>})[</span><span class=mf>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div><h2>Получить размер файла</h2><p>Функция позволяет получить размер файла в различных единицах измерения.</p><h3>Параметры</h3><ul><li><code>-F</code> - название файла.</li></ul><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.get.filesize.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-e5aa1be81f22689530dc9127b9616715 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.get.filesize.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.get.filesize.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-e5aa1be81f22689530dc9127b9616715><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$File</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-FileSize</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>Get-Item</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>).</span><span class=py>Length</span>      <span class=c># Size in bytes.</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>Get-Item</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>).</span><span class=n>Length</span><span class=p>/</span><span class=mf>1</span><span class=p>KB</span>  <span class=c># Size in KB.</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>Get-Item</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>).</span><span class=n>Length</span><span class=p>/</span><span class=mf>1</span><span class=p>MB</span>  <span class=c># Size in MB.</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>Get-Item</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>).</span><span class=n>Length</span><span class=p>/</span><span class=mf>1</span><span class=p>GB</span>  <span class=c># Size in GB.</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>Get-Item</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>).</span><span class=n>Length</span><span class=p>/</span><span class=mf>1</span><span class=p>TB</span>  <span class=c># Size in TB.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-FileSize</span></span></span></code></pre></div></div></div></div><h2>Работа с архивами 7-Zip</h2><p>Функции по работе с архивами 7-Zip.</p><h3>Параметры</h3><ul><li><code>-F</code> - путь к файлу.</li></ul><h3>Упаковка</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.compress.7z.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-ae6f30fd5ed221794973de616bdb4282 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.compress.7z.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.compress.7z.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-ae6f30fd5ed221794973de616bdb4282><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$File</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Compress-A7z</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$Env:ProgramFiles</span><span class=p>)</span><span class=s2>\7-Zip\7z.exe&#34;</span> <span class=n>a</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=py>FullName</span> <span class=p>+</span> <span class=s1>&#39;.7z&#39;</span><span class=p>)</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Compress-A7z</span></span></span></code></pre></div></div></div></div><h3>Распаковка</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.expand.7z.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-c7cf19557f18d68e6a06e4b1063f6b80 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.expand.7z.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.expand.7z.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-c7cf19557f18d68e6a06e4b1063f6b80><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$File</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Expand-A7z</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$Env:ProgramFiles</span><span class=p>)</span><span class=s2>\7-Zip\7z.exe&#34;</span> <span class=n>x</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Expand-A7z</span></span></span></code></pre></div></div></div></div><h2>Работа с архивами WinRAR</h2><p>Функции по работе с архивами WinRAR.</p><h3>Параметры</h3><ul><li><code>-F</code> - путь к файлу.</li></ul><h3>Упаковка</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.compress.rar.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-ed1e7bd8605ab2c72162bf32bb4016ed role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.compress.rar.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.compress.rar.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-ed1e7bd8605ab2c72162bf32bb4016ed><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$File</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Compress-RAR</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$Env:ProgramFiles</span><span class=p>)</span><span class=s2>\WinRAR\Rar.exe&#34;</span> <span class=n>a</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=py>FullName</span> <span class=p>+</span> <span class=s1>&#39;.rar&#39;</span><span class=p>)</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Compress-RAR</span></span></span></code></pre></div></div></div></div><h3>Распаковка</h3><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.expand.rar.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-41cddc1a30c1da65ddeb95a88b462911 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.expand.rar.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.expand.rar.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-41cddc1a30c1da65ddeb95a88b462911><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$File</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Expand-RAR</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$Env:ProgramFiles</span><span class=p>)</span><span class=s2>\WinRAR\Rar.exe&#34;</span> <span class=n>x</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Expand-RAR</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-warning" data-bs-tooltip data-bs-title='Уровень сложности: Средний'><i class="far fa-face-meh fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-24T03:38:45Z data-fn=date-local>2023/10/24 03:38:45 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="PowerShell: Стирание диска" class=d-block href=/ru/articles/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/ data-bs-toggle=modal data-bs-target=#modal-ee8e7f2d0f11fcf70b2ca33ea3f0e80d><picture><source srcset='https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1646226343350-1ee5021e342a?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="PowerShell: Стирание диска"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/ data-bs-toggle=modal data-bs-target=#modal-ee8e7f2d0f11fcf70b2ca33ea3f0e80d>PowerShell: Стирание диска</a></h2></div></header><div class=node-body><p>Небольшой скрипт, который обнуляет HDD/SSD и создаёт файловую систему заново.</p></div></article><div class="modal fade" id=modal-ee8e7f2d0f11fcf70b2ca33ea3f0e80d tabindex=-1 aria-labelledby=modal-ee8e7f2d0f11fcf70b2ca33ea3f0e80d-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-ee8e7f2d0f11fcf70b2ca33ea3f0e80d-label><a href=/ru/articles/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/>PowerShell: Стирание диска</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Небольшой скрипт, который обнуляет HDD/SSD и создаёт файловую систему заново.</p><h2>Параметры</h2><ul><li><code>-DN</code> <code>-P_DiskNumber</code> - номер диска. Можно узнать командой <code>Get-Disk</code>. Но если не ввести номер диска в параметры скрипта при запуске, скрипт сам выведет информацию и спросит номер диска. Обязательный параметр.</li><li><code>-DL</code> <code>-P_DriveLetter</code> - буква будущего тома. При создании тома, ОС должна присвоить ему букву. Обязательный параметр.</li><li><code>-FS</code> <code>-P_FileSystem</code> - файловая система. Может принимать следующие значения:<ul><li><code>'FAT'</code> - файловая система FAT.</li><li><code>'FAT32'</code> - файловая система FAT32.</li><li><code>'exFAT'</code> - файловая система exFAT.</li><li><code>'NTFS'</code> - файловая система NTFS.</li><li><code>'ReFS'</code> - новая файловая система ReFS.</li></ul></li><li><code>-FSL</code> <code>-P_FileSystemLabel</code> - метка файловой системы.</li><li><code>-S</code> <code>-P_Sleep</code> - перерыв между командами (в секундах).</li></ul><h2>Примеры</h2><p>Скрипт, запущенный без параметров, сам спросит необходимые данные:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-6acdc934a9ca640f6c1e409a6cfb5923 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-6acdc934a9ca640f6c1e409a6cfb5923><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>disk</span><span class=p>.</span><span class=py>erase</span><span class=p>.</span><span class=n>ps1</span></span></span></code></pre></div></div></div></div><p>Обнулить диск <code>3</code>, новому разделу присвоить букву <code>E</code>, форматировать в <code>NTFS</code> и указать метку <code>USB-SSD</code>:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows-root"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class="flex-shrink-0 text-danger"><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-977744244801dfda6ce9d94cbe2106ea role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-977744244801dfda6ce9d94cbe2106ea><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>disk</span><span class=p>.</span><span class=py>erase</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-DN</span> <span class=mf>3</span> <span class=n>-DL</span> <span class=s1>&#39;E&#39;</span> <span class=n>-FS</span> <span class=s1>&#39;NTFS&#39;</span> <span class=n>-FSL</span> <span class=s1>&#39;USB-SSD&#39;</span></span></span></code></pre></div></div></div></div><h2>Скрипт</h2><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.disk.erase.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-9cc03b5140e57bc9ed9df11199f5b7a2 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.disk.erase.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.disk.erase.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-9cc03b5140e57bc9ed9df11199f5b7a2><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.0
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         8d95f4d5-4d14-412c-9fa4-b75ebe79df09
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-RunAsAdministrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Disk erase script.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Disk cleanup followed by partition creation.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_DiskNumber
</span></span></span><span class=line><span class=cl><span class=cm>  Specifies the disk number of the disk on which to perform the clear operation. For a list of available disks, see the &#39;Get-Disk&#39; cmdlet.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_FileSystem
</span></span></span><span class=line><span class=cl><span class=cm>  Specifies the file system with which to format the volume.
</span></span></span><span class=line><span class=cl><span class=cm>  The acceptable values for this parameter are: &#39;NTFS&#39;, &#39;ReFS&#39;, &#39;exFAT&#39;, &#39;FAT32&#39; and &#39;FAT&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Sleep
</span></span></span><span class=line><span class=cl><span class=cm>  Sleep time (in seconds).
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.disk.erase.ps1 -DN 3 -DL &#39;E&#39; -FS &#39;NTFS&#39; -FSL &#39;USB-SSD&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/52d75b90-0637-5ba6-91d6-b1bff40e1d67/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Specify the disk number.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>ValidatePattern</span><span class=p>(</span><span class=s1>&#39;^[0-9]+$&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;DN&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_DiskNumber</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Specify the file system to format the volume.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s1>&#39;FAT&#39;</span><span class=p>,</span> <span class=s1>&#39;FAT32&#39;</span><span class=p>,</span> <span class=s1>&#39;exFAT&#39;</span><span class=p>,</span> <span class=s1>&#39;NTFS&#39;</span><span class=p>,</span> <span class=s1>&#39;ReFS&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;FS&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_FileSystem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Sleep time (in seconds).&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;S&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_Sleep</span> <span class=p>=</span> <span class=mf>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># New line separator.</span>
</span></span><span class=line><span class=cl><span class=nv>$NL</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>NewLine</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Random number.</span>
</span></span><span class=line><span class=cl><span class=nv>$Random</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nb>Get-Random</span> <span class=n>-Minimum</span> <span class=mf>1000</span> <span class=n>-Maximum</span> <span class=mf>9999</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Getting free drive letter and to assign to the new partition.</span>
</span></span><span class=line><span class=cl><span class=nv>$DriveLetter</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$((</span><span class=mf>68</span><span class=p>.</span><span class=mf>.90</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span> <span class=nv>$L</span><span class=p>=[</span><span class=no>char</span><span class=p>]</span><span class=nv>$_</span><span class=p>;</span> <span class=k>if</span> <span class=p>((</span><span class=nb>Get-PSDrive</span><span class=p>).</span><span class=py>Name</span> <span class=o>-notContains</span> <span class=nv>$L</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$L</span> <span class=p>}</span> <span class=p>})[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Specifying a new label to use for the volume.</span>
</span></span><span class=line><span class=cl><span class=nv>$FileSystemLabel</span> <span class=p>=</span> <span class=s2>&#34;DISK_</span><span class=nv>${Random}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DPDiskList</span>        <span class=c># Showing disk list.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$P_DiskNumber</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$P_DiskNumber</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Read-Host</span> <span class=n>-Prompt</span> <span class=s1>&#39;Disk number&#39;</span><span class=p>)</span> <span class=p>}</span>   <span class=c># Getting disk number.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$P_FileSystem</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$P_FileSystem</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Read-Host</span> <span class=n>-Prompt</span> <span class=s1>&#39;File system&#39;</span><span class=p>)</span> <span class=p>}</span>   <span class=c># Getting file system.</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DPDiskClear</span>       <span class=c># Starting clearing disk.</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DPDiskInit</span>        <span class=c># Initializing disk.</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DPDiskPartition</span>   <span class=c># Creating partition.</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-DPDiskFormat</span>      <span class=c># Formatting volume.</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># DISK LIST.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DPDiskList</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s1>&#39;Disk List&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nb>Get-Disk</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CLEAR DISK.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DPDiskClear</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s2>&#34;[DISK #</span><span class=nv>${P_DiskNumber}</span><span class=s2>] Clear Disk&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;W&#39;</span> <span class=n>-A</span> <span class=s1>&#39;Inquire&#39;</span> <span class=n>-M</span> <span class=p>(</span><span class=s2>&#34;You specified drive number &#39;</span><span class=nv>${P_DiskNumber}</span><span class=s2>&#39;.</span><span class=nv>${NL}</span><span class=s2>&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;All data will be DELETED!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Number</span> <span class=p>=</span> <span class=nv>$P_DiskNumber</span>
</span></span><span class=line><span class=cl>    <span class=n>RemoveData</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>    <span class=n>RemoveOEM</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>    <span class=n>Confirm</span> <span class=p>=</span> <span class=vm>$false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Clear-Disk</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-Sleep</span> <span class=n>-s</span> <span class=nv>$P_Sleep</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZE DISK.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DPDiskInit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s2>&#34;[DISK #</span><span class=nv>${P_DiskNumber}</span><span class=s2>] Initialize Disk&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Number</span> <span class=p>=</span> <span class=nv>$P_DiskNumber</span>
</span></span><span class=line><span class=cl>    <span class=n>PartitionStyle</span> <span class=p>=</span> <span class=s1>&#39;GPT&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Initialize-Disk</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-Sleep</span> <span class=n>-s</span> <span class=nv>$P_Sleep</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CREATE PARTITION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DPDiskPartition</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s2>&#34;[DISK #</span><span class=nv>${P_DiskNumber}</span><span class=s2>] Create Partition&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DiskNumber</span> <span class=p>=</span> <span class=nv>$P_DiskNumber</span>
</span></span><span class=line><span class=cl>    <span class=n>DriveLetter</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${DriveLetter}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>UseMaximumSize</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>New-Partition</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-Sleep</span> <span class=n>-s</span> <span class=nv>$P_Sleep</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># FORMAT DISK VOLUME.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-DPDiskFormat</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s2>&#34;[DISK #</span><span class=nv>${P_DiskNumber}</span><span class=s2>] Format Disk Volume (</span><span class=nv>${DriveLetter}</span><span class=s2> / </span><span class=nv>${P_FileSystem}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$P_FileSystem</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$P_FileSystem</span> <span class=p>=</span> <span class=s1>&#39;NTFS&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DriveLetter</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${DriveLetter}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FileSystem</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${P_FileSystem}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>NewFileSystemLabel</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${FileSystemLabel}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Force</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Format-Volume</span> <span class=nv>@Param</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-Sleep</span> <span class=n>-s</span> <span class=nv>$P_Sleep</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># ------------------------------------------------&lt; COMMON FUNCTIONS &gt;------------------------------------------------ #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># SYSTEM MESSAGES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Write-Msg</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;Continue&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;HL&#39;</span>    <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${NL}</span><span class=s2>--- </span><span class=nv>${Message}</span><span class=s2>&#34;</span><span class=p>.</span><span class=py>ToUpper</span><span class=p>()</span> <span class=n>-ForegroundColor</span> <span class=n>Blue</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;I&#39;</span>     <span class=p>{</span> <span class=nb>Write-Information</span> <span class=n>-MessageData</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-InformationAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;W&#39;</span>     <span class=p>{</span> <span class=nb>Write-Warning</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-WarningAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;E&#39;</span>     <span class=p>{</span> <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span> <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/hdd/>#hdd</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/ssd/>#ssd</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-23T11:03:04Z data-fn=date-local>2023/10/23 11:03:04 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="PowerShell: Сжатие видео при помощи FFmpeg" class=d-block href=/ru/articles/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/ data-bs-toggle=modal data-bs-target=#modal-45eea9821cd138d37ad6ff1f9554ee6e><picture><source srcset='https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="PowerShell: Сжатие видео при помощи FFmpeg"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/ data-bs-toggle=modal data-bs-target=#modal-45eea9821cd138d37ad6ff1f9554ee6e>PowerShell: Сжатие видео при помощи FFmpeg</a></h2></div></header><div class=node-body><p>Когда то в далёкой далёкой галактике&mldr; Ко мне на работе обратились с просьбой как то уменьшить видео, записанное на камеру в формате <code>.mov</code>. Естественно, я воспользовался библиотекой FFmpeg. Но скрипт автоматизации решил написать только сейчас&mldr;</p></div></article><div class="modal fade" id=modal-45eea9821cd138d37ad6ff1f9554ee6e tabindex=-1 aria-labelledby=modal-45eea9821cd138d37ad6ff1f9554ee6e-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-45eea9821cd138d37ad6ff1f9554ee6e-label><a href=/ru/articles/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/>PowerShell: Сжатие видео при помощи FFmpeg</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Когда то в далёкой далёкой галактике&mldr; Ко мне на работе обратились с просьбой как то уменьшить видео, записанное на камеру в формате <code>.mov</code>. Естественно, я воспользовался библиотекой FFmpeg. Но скрипт автоматизации решил написать только сейчас&mldr;</p><p>Скрипт прост как лапоть. Состоит из небольшого количества вводных параметров, большинство из которых изменять не требуется. Предназначен скрипт для быстрого пакетного конвертирования файлов видео из одного формата в другой, в основном, с целью уменьшения размера. Скрипт не предназначен для сложного редактирования видео!</p><h2>Параметры</h2><ul><li><code>-F</code> <code>-P_Files</code> - массив входящих файлов.</li><li><code>-CV</code> <code>-P_vCodec</code> - видео кодек, используемый для конвертации. По умолчанию: <code>libx265</code>. Поддерживаемые кодеки:<ul><li><code>'libx264'</code> - кодек &ldquo;H.264&rdquo;.</li><li><code>'libx265'</code> - кодек &ldquo;H.265&rdquo;.</li><li><code>'libvpx-vp9'</code> - кодек &ldquo;VP9&rdquo; (&ldquo;WebM&rdquo;).</li><li><code>'libaom-av1'</code> - кодек &ldquo;AV1&rdquo;.</li></ul></li><li><code>-CA</code> <code>-P_aCodec</code> - аудио кодек, используемый для конвертации. По умолчанию: <code>copy</code>. Поддерживаемые кодеки:<ul><li><code>'libfdk_aac'</code> - кодек &ldquo;Fraunhofer FDK AAC&rdquo;.</li><li><code>'aac'</code> - кодек &ldquo;FFmpeg AAC&rdquo;.</li><li><code>'libmp3lame'</code> - кодек &ldquo;FFmpeg MP3&rdquo;.</li></ul></li><li><code>-R</code> <code>-P_Framerate</code> - частота кадров выходящего файла (FPS). Сжатие кадров с учётом движения, где сцены движения кодируются с меньшим качеством, чем статичные сцены, что субъективно приводит к восприятию, как качественного, ибо визуально человек различает больше деталей в неподвижных объектах, чем в движущихся. Если параметр не указан, то значение берётся из входящего файла.</li><li><code>-C</code> <code>-P_CRF</code> - постоянный коэффициент потока (Constant Rate Factor). Это режим кодирования для кодеков &ldquo;H.264&rdquo; и &ldquo;H.265&rdquo; с постоянным воспринимаемым качеством, осуществляемый с помощью настройки качества (и управления скоростью). Если параметр не указан, то значение берётся по умолчанию, обычно это <code>28</code> при кодеке <code>libx265</code> и <code>23</code> при <code>libx264</code>.</li><li><code>-P</code> <code>-P_Preset</code> - пресеты. Это набор параметров, которые обеспечивают определённую скорость кодирования с степень сжатия. У каждого кодека видео свой набор пресетов. Нужно смотреть <a title href=https://trac.ffmpeg.org/wiki target=_blank rel="noopener noreferrer nofollow">документацию</a>.</li><li><code>-EXT</code> <code>-P_Extension</code> - расширение выходящих файлов.</li></ul><h2>Примеры</h2><p>Конвертировать файлы <code>file_01.mov</code>, <code>file_02.mov</code> и <code>file_03.mov</code> в формат <code>mp4</code>:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-de08b85e2a233a42060ffc9e0d939ff1 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-de08b85e2a233a42060ffc9e0d939ff1><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>ffmpeg</span><span class=p>.</span><span class=py>video</span><span class=p>.</span><span class=py>compress</span><span class=p>.</span><span class=py>ps1</span> <span class=o>-F</span> <span class=s1>&#39;file_01.mov&#39;</span><span class=p>,</span> <span class=s1>&#39;file_02.mov&#39;</span><span class=p>,</span> <span class=s1>&#39;file_03.mov&#39;</span></span></span></code></pre></div></div></div></div><p>Пакетная конвертация всех файлов с расширением <code>.mov</code> в формат <code>mp4</code>:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-9e3065b65d1d759efedb0844323022ab role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-9e3065b65d1d759efedb0844323022ab><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>ffmpeg</span><span class=p>.</span><span class=py>video</span><span class=p>.</span><span class=py>compress</span><span class=p>.</span><span class=py>ps1</span> <span class=o>-F</span> <span class=s1>&#39;*.mov&#39;</span></span></span></code></pre></div></div></div></div><h2>Алгоритм работы</h2><p>Скрипт предназначен для быстрого пакетного преобразования файлов видео из одного формата в другой.</p><div class="shortcode shortcode-alert"><div class="alert alert-warning d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-exclamation-triangle fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Для работы скрипта необходим файл <code>ffmpeg.exe</code>, архив которого можно скачать с сайта <a title href=https://www.gyan.dev/ffmpeg/builds/ target=_blank rel="noopener noreferrer nofollow">gyan.dev</a>, распаковать и разместить рядом с файлом скрипта или в любую дочернюю директорию. Скрипт сам найдёт файл <code>ffmpeg.exe</code> и начнёт его использовать.</p></div></div></div><h2>Скрипт</h2><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.ffmpeg.video.compress.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-0fed1c393cb1b6b46b0dc59fbb9bd85b role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.ffmpeg.video.compress.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.ffmpeg.video.compress.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-0fed1c393cb1b6b46b0dc59fbb9bd85b><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.2
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         b95fb1ac-6878-4451-bb49-434d51d9555d
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Video compression script based on FFmpeg.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  FFmpeg is a free and open-source software project consisting of a suite of libraries and programs for handling video, audio, and other multimedia files and streams.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Files
</span></span></span><span class=line><span class=cl><span class=cm>  An array of input files.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_vCodec
</span></span></span><span class=line><span class=cl><span class=cm>  The video codec.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;libx265&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_aCodec
</span></span></span><span class=line><span class=cl><span class=cm>  The audio codec.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;copy&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Framerate
</span></span></span><span class=line><span class=cl><span class=cm>  FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate. The output duration of the video will stay the same.
</span></span></span><span class=line><span class=cl><span class=cm>  This is useful when working with, for example, high-framerate input video that needs to be temporally scaled down for devices that do not support high FPS.
</span></span></span><span class=line><span class=cl><span class=cm>  When the frame rate is changed, FFmpeg will drop or duplicate frames as necessary to achieve the targeted output frame rate.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_CRF
</span></span></span><span class=line><span class=cl><span class=cm>  Constant Rate Factor.
</span></span></span><span class=line><span class=cl><span class=cm>  Use this rate control mode if you want to keep the best quality and care less about the file size. This is the recommended rate control mode for most uses.
</span></span></span><span class=line><span class=cl><span class=cm>  This method allows the encoder to attempt to achieve a certain output quality for the whole file when output file size is of less importance. This provides maximum compression efficiency with a single pass. By adjusting the so-called quantizer for each frame, it gets the bitrate it needs to keep the requested quality level. The downside is that you can&#39;t tell it to get a specific filesize or not go over a specific size or bitrate, which means that this method is not recommended for encoding videos for streaming.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Preset
</span></span></span><span class=line><span class=cl><span class=cm>  A preset is a collection of options that will provide a certain encoding speed to compression ratio. A slower preset will provide better compression (compression is quality per filesize). This means that, for example, if you target a certain file size or constant bit rate, you will achieve better quality with a slower preset. Similarly, for constant quality encoding, you will simply save bitrate by choosing a slower preset.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Extension
</span></span></span><span class=line><span class=cl><span class=cm>  The extension of the resulting files.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;mp4&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.ffmpeg.video.compress.ps1 -F &#39;file_01.mov&#39;, &#39;file_02.mov&#39;, &#39;file_03.mov&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.ffmpeg.video.compress.ps1 -F &#39;*.mov&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/2a73410a-6611-570c-9ab4-dc8cc8998146/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>,</span> <span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;An array of input files.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;F&#39;</span><span class=p>)][</span><span class=no>string[]</span><span class=p>]</span><span class=nv>$P_Files</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;The video codec.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;CV&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_vCodec</span> <span class=p>=</span> <span class=s1>&#39;libx265&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;The audio codec.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;CA&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_aCodec</span> <span class=p>=</span> <span class=s1>&#39;copy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;FFmpeg can be used to change the frame rate of an existing video, such that the output frame rate is lower or higher than the input frame rate.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;R&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_Framerate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Constant Rate Factor. Use this rate control mode if you want to keep the best quality and care less about the file size.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;C&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$P_CRF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;A preset is a collection of options that will provide a certain encoding speed to compression ratio.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Preset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;The extension of the resulting files.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;EXT&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Extension</span> <span class=p>=</span> <span class=s1>&#39;mp4&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># New line separator.</span>
</span></span><span class=line><span class=cl><span class=nv>$NL</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>NewLine</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-CompressVideo</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># COMPRESS VIDEO.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-CompressVideo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Files</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>${P_Files}</span><span class=s2>&#34;</span> <span class=o>-File</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Files</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$In</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$_</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Out</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nb>Join-Path</span> <span class=nv>$_</span><span class=p>.</span><span class=py>DirectoryName</span> <span class=nv>$_</span><span class=p>.</span><span class=n>BaseName</span><span class=p>)</span><span class=s2>.</span><span class=nv>${P_Extension}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Start-FFmpeg</span> <span class=n>-I</span> <span class=s2>&#34;</span><span class=nv>${In}</span><span class=s2>&#34;</span> <span class=n>-O</span> <span class=s2>&#34;</span><span class=nv>${Out}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># ------------------------------------------------&lt; COMMON FUNCTIONS &gt;------------------------------------------------ #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># TESTING ELEMENTS.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Test-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Container&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;F&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Leaf&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-PathType</span> <span class=s2>&#34;</span><span class=nv>${Type}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># APP: FFmpeg.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-FFmpeg</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$In</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;O&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Out</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Search &#39;ffmpeg.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$FFmpegExe</span> <span class=p>=</span> <span class=p>((</span><span class=nb>Get-ChildItem</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>&#34;</span> <span class=n>-Filter</span> <span class=s1>&#39;ffmpeg.exe&#39;</span> <span class=n>-Recurse</span> <span class=o>-File</span><span class=p>)</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-First</span> <span class=mf>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Checking the location of &#39;ffmpeg.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=p>(</span><span class=nb>Test-Data</span> <span class=n>-T</span> <span class=s1>&#39;F&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${FFmpegExe}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Warning</span> <span class=n>-WarningAction</span> <span class=s1>&#39;Stop&#39;</span> <span class=n>-Message</span> <span class=p>(</span><span class=s2>&#34;&#39;ffmpeg.exe&#39; not found!</span><span class=nv>${NL}${NL}</span><span class=s2>&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;1. Download FFmpeg from &#39;https://www.gyan.dev/ffmpeg/builds/&#39;.</span><span class=nv>${NL}</span><span class=s2>&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;2. Extract &#39;ffmpeg.exe&#39; into a directory &#39;</span><span class=nv>${PSScriptRoot}</span><span class=s2>&#39;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Specifying &#39;ffmpeg.exe&#39; parameters.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-hide_banner&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-i&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${In}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-c:v&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_vCodec}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$P_CRF</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-crf&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_CRF}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$P_Preset</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-preset&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_Preset}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$P_Framerate</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-r&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_Framerate}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;-c:a&#39;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_aCodec}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Param</span> <span class=p>+=</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;</span><span class=nv>${Out}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Running &#39;ffmpeg.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=nv>${FFmpegExe}</span><span class=s2>&#34;</span> <span class=nv>$Param</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/ffmpeg/>#ffmpeg</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-22T14:06:44Z data-fn=date-local>2023/10/22 14:06:44 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="PowerShell: Определение разрядности ОС Windows" class=d-block href=/ru/articles/2023/10/0028821e-c96c-5014-a1dd-8963c161b170/ data-bs-toggle=modal data-bs-target=#modal-cc0003811a6de90b8d8fb55dc160ee90><picture><source srcset='https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1642176849879-92f85770f212?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="PowerShell: Определение разрядности ОС Windows"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/0028821e-c96c-5014-a1dd-8963c161b170/ data-bs-toggle=modal data-bs-target=#modal-cc0003811a6de90b8d8fb55dc160ee90>PowerShell: Определение разрядности ОС Windows</a></h2></div></header><div class=node-body><p>Нашёл на Stack Overflow хорошую функцию по определению разрядности ОС и процесса PowerShell. Запишу, обязательно пригодится.</p></div></article><div class="modal fade" id=modal-cc0003811a6de90b8d8fb55dc160ee90 tabindex=-1 aria-labelledby=modal-cc0003811a6de90b8d8fb55dc160ee90-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-cc0003811a6de90b8d8fb55dc160ee90-label><a href=/ru/articles/2023/10/0028821e-c96c-5014-a1dd-8963c161b170/>PowerShell: Определение разрядности ОС Windows</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>Нашёл на Stack Overflow хорошую функцию по определению разрядности ОС и процесса PowerShell. Запишу, обязательно пригодится.</p><h2>Разрядность ОС</h2><p>Разрядность ОС можно определить следующей функцией:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-powershell"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-e92e90aab99c80cbe09fc79f07579e72><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-Architecture</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c># What bitness does Windows use.</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>Is64BitOperatingSystem</span><span class=p>)</span> <span class=p>{</span> <span class=c># Needs &#39;.NET 4&#39;.</span>
</span></span><span class=line><span class=cl>    <span class=vm>$true</span>   <span class=p>{</span> <span class=mf>64</span><span class=p>;</span> <span class=k>break</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=vm>$false</span>  <span class=p>{</span> <span class=mf>32</span><span class=p>;</span> <span class=k>break</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_OperatingSystem</span><span class=p>).</span><span class=py>OSArchitecture</span> <span class=o>-replace</span> <span class=s1>&#39;\D&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c># Or do any of these:</span>
</span></span><span class=line><span class=cl>      <span class=c># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c># (Get-WmiObject -Class Win32_Processor).AddressWidth # This is slow...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-e92e90aab99c80cbe09fc79f07579e72 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p><h3>Результат</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-ad6dc4ea89dbc53cabd9b8c444c1c235 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-ad6dc4ea89dbc53cabd9b8c444c1c235><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>arch</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=mf>64</span></span></span></code></pre></div></div></div></div><h2>Разрядность ОС и PowerShell</h2><p>Расширенная версия, которая позволяет определить разрядность ОС и процесса PowerShell, под которым выполняется функция.</p><div class="shortcode shortcode-codeblock shortcode-codeblock-2 shortcode-codeblock-powershell"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-55f45c69e59071840c9a28994aec2d8b><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-Architecture</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c># What bitness does Windows use.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$windowsBitness</span> <span class=p>=</span> <span class=k>switch</span> <span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>Is64BitOperatingSystem</span><span class=p>)</span> <span class=p>{</span> <span class=c># Needs &#39;.NET 4&#39;.</span>
</span></span><span class=line><span class=cl>    <span class=vm>$true</span>   <span class=p>{</span> <span class=mf>64</span><span class=p>;</span> <span class=k>break</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=vm>$false</span>  <span class=p>{</span> <span class=mf>32</span><span class=p>;</span> <span class=k>break</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_OperatingSystem</span><span class=p>).</span><span class=py>OSArchitecture</span> <span class=o>-replace</span> <span class=s1>&#39;\D&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c># Or do any of these:</span>
</span></span><span class=line><span class=cl>      <span class=c># (Get-WmiObject -Class Win32_ComputerSystem).SystemType -replace &#39;\D&#39; -replace &#39;86&#39;, &#39;32&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c># (Get-WmiObject -Class Win32_Processor).AddressWidth # Slow...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># What bitness does this PowerShell process use.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$processBitness</span> <span class=p>=</span> <span class=p>[</span><span class=no>IntPtr</span><span class=p>]::</span><span class=n>Size</span> <span class=p>*</span> <span class=mf>8</span>
</span></span><span class=line><span class=cl>  <span class=c># Or do any of these:</span>
</span></span><span class=line><span class=cl>  <span class=c># $processBitness = $env:PROCESSOR_ARCHITECTURE -replace &#39;\D&#39; -replace &#39;86|ARM&#39;, &#39;32&#39;</span>
</span></span><span class=line><span class=cl>  <span class=c># $processBitness = if ([Environment]::Is64BitProcess) { 64 } else { 32 }</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Return the info as object.</span>
</span></span><span class=line><span class=cl>  <span class=nb>New-Object</span> <span class=n>-TypeName</span> <span class=n>PSObject</span> <span class=n>-Property</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;ProcessArchitecture&#39;</span> <span class=p>=</span> <span class=s2>&#34;{0} bit&#34;</span> <span class=o>-f</span> <span class=nv>$processBitness</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;WindowsArchitecture&#39;</span> <span class=p>=</span> <span class=s2>&#34;{0} bit&#34;</span> <span class=o>-f</span> <span class=nv>$windowsBitness</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-55f45c69e59071840c9a28994aec2d8b role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Можно записать эту функцию в файл и запустить файл в терминале, или же внедрить в крупный проект и вызывать по имени <code>Get-Architecture</code>.</p><h3>Результат</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-3 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-7cf9cc05258cdac7ff113866cdf6cced role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-7cf9cc05258cdac7ff113866cdf6cced><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>arch</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ProcessArchitecture</span> <span class=n>WindowsArchitecture</span>
</span></span><span class=line><span class=cl><span class=p>-------------------</span> <span class=p>-------------------</span>
</span></span><span class=line><span class=cl><span class=mf>64</span> <span class=n>bit</span>              <span class=mf>64</span> <span class=n>bit</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-21T17:42:05Z data-fn=date-local>2023/10/21 17:42:05 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="PowerShell Vault" class=d-block href=/ru/articles/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/ data-bs-toggle=modal data-bs-target=#modal-7211caa07067ed9fd33cc9db16b800da><picture><source srcset='https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1609358905581-e5381612486e?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="PowerShell Vault"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/ data-bs-toggle=modal data-bs-target=#modal-7211caa07067ed9fd33cc9db16b800da>PowerShell Vault</a></h2></div></header><div class=node-body><p>На работе в локальной сети использовалась задача, которая перемещала старые, по долгу не использовавшиеся, файлы из главного файлового хранилища в резервное. Но так как организация являлась проектной, то старые файлы могли понадобиться в любое время.</p></div></article><div class="modal fade" id=modal-7211caa07067ed9fd33cc9db16b800da tabindex=-1 aria-labelledby=modal-7211caa07067ed9fd33cc9db16b800da-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-7211caa07067ed9fd33cc9db16b800da-label><a href=/ru/articles/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/>PowerShell Vault</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>На работе в локальной сети использовалась задача, которая перемещала старые, по долгу не использовавшиеся, файлы из главного файлового хранилища в резервное. Но так как организация являлась проектной, то старые файлы могли понадобиться в любое время.</p><p>Задача использовала простой скрипт с фильтрацией файлов по параметрам <em>время создания</em> и <em>время изменения</em>. Я чуть доработали скрипт и решил опубликовать его для других администраторов. Вдруг, пригодится. Только перед использованием прошу проверить скрипт в какой-нибудь песочнице.</p><div class="shortcode shortcode-alert"><div class="alert alert-danger d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-circle-radiation fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Есть вероятность, что скрипт удалит все файлы в вашем файловом хранилище, из-за того, что автор может оказаться <em>рукожопом</em>! Поэтому, перед боевой задачей, проверьте скрипт в какой-нибудь песочнице. А кто хорошо разбирается в PowerShell - автор будет благодарен за оптимизацию и корректировку скрипта.</p></div></div></div><h2>Параметры</h2><ul><li><code>-M</code> <code>-P_Mode</code> - режим работы скрипта. По умолчанию <code>'MV'</code>.<ul><li><code>'CP'</code> - копировать файлы из источника в хранилище.</li><li><code>'MV'</code> - перемещать файлы из источника в хранилище.</li><li><code>'RM'</code> - только удалять файлы из источника без копирования или перемещения куда-либо.</li></ul></li><li><code>-SRC</code> <code>-P_Source</code> - путь к директории откуда перемещать файлы. Например, <code>-SRC 'C:\Data\Source'</code>. По умолчанию: <code>${PSScriptRoot}\Source</code>.</li><li><code>-DST</code> <code>-P_Vault</code> - путь к директории куда перемещать файлы. Например, <code>-DST 'C:\Data\Vault'</code>. По умолчанию: <code>${PSScriptRoot}\Vault</code>.</li><li><code>-CT</code> <code>-P_CreationTime</code> - время создания файла в секундах. Например, <code>-CT 5270400</code>. По умолчанию: <code>5270400</code> (61 день).</li><li><code>-WT</code> <code>-P_LastWriteTime</code> - время изменения файла в секундах. Например, <code>-WT 5270400</code>. По умолчанию: <code>${P_CreationTime}</code>.</li><li><code>-FS</code> <code>-P_FileSize</code> - размер файла. Например, <code>-FS '5kb'</code> или <code>-FS '12mb'</code>. По умолчанию: <code>'0kb'</code>.</li><li><code>-E</code> <code>-P_Exclude</code> - путь к файлу с исключениями. Например, <code>-E 'C:\Data\exclude.txt'</code>. По умолчанию: <code>${PSScriptRoot}\vault.exclude.txt</code>.</li><li><code>-L</code> <code>-P_Logs</code> - путь к директории с журналами работы скрипта. Например, <code>-L 'C:\Data\Logs'</code>. По умолчанию: <code>${PSScriptRoot}\Logs</code>.</li><li><code>-RD</code> <code>-P_RemoveDirs</code> - удалять пустые каталоги.</li><li><code>-O</code> <code>-P_Overwrite</code> - перезаписать файлы в Vault.</li></ul><h2>Примеры</h2><p>Запустить перемещение файлов из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f583e78bcf53fedcba2874db5b5b3a90 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-f583e78bcf53fedcba2874db5b5b3a90><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>vault</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-SRC</span> <span class=s1>&#39;C:\Data\Source&#39;</span> <span class=n>-DST</span> <span class=s1>&#39;C:\Data\Vault&#39;</span></span></span></code></pre></div></div></div></div><p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-195128edf36d14edf9adb9dba687a6ae role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-195128edf36d14edf9adb9dba687a6ae><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>vault</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-SRC</span> <span class=s1>&#39;C:\Data\Source&#39;</span> <span class=n>-DST</span> <span class=s1>&#39;C:\Data\Vault&#39;</span> <span class=n>-CT</span> <span class=s1>&#39;864000&#39;</span> <span class=n>-WT</span> <span class=s1>&#39;864000&#39;</span></span></span></code></pre></div></div></div></div><p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>) и размером более 32 мегабайта (<code>32mb</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-2 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-9f08372e92242bf87c87820b88ad5485 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-9f08372e92242bf87c87820b88ad5485><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>vault</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-SRC</span> <span class=s1>&#39;C:\Data\Source&#39;</span> <span class=n>-DST</span> <span class=s1>&#39;C:\Data\Vault&#39;</span> <span class=n>-CT</span> <span class=s1>&#39;864000&#39;</span> <span class=n>-WT</span> <span class=s1>&#39;864000&#39;</span> <span class=n>-FS</span> <span class=s1>&#39;32mb&#39;</span></span></span></code></pre></div></div></div></div><p>Запустить перемещение файлов с временем создания и изменения от 10 дней (<code>864000</code>), и с перезаписью файлов с одинаковыми названиями (<code>-O</code>) из <code>Source</code> в <code>Vault</code> с сохранением структуры директорий:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-3 shortcode-codeblock-terminal
shortcode-codeblock-terminal-windows
shortcode-codeblock-terminal-windows"><div class="card mb-3 overflow-hidden" data-bs-theme=dark><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="fas fa-terminal fa-fw"></i></div><div class="flex-grow-1 mx-2"><h5 class=mb-0>Терминал</h5></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f565275fa896e6e1e679ac8af2be5cd4 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><div class="card-body p-0" id=clipboard-f565275fa896e6e1e679ac8af2be5cd4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=n>pwsh</span><span class=p>.</span><span class=py>vault</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-SRC</span> <span class=s1>&#39;C:\Data\Source&#39;</span> <span class=n>-DST</span> <span class=s1>&#39;C:\Data\Vault&#39;</span> <span class=n>-CT</span> <span class=s1>&#39;864000&#39;</span> <span class=n>-WT</span> <span class=s1>&#39;864000&#39;</span> <span class=n>-O</span></span></span></code></pre></div></div></div></div><p>Параметр <code>-O</code> означает, что не нужно архивировать старый файл при перемещении нового с таким же названием. Старый файл в хранилище перезапишется новым.</p><h2>Алгоритм работы</h2><p>Скрипт создаёт хранилище старых файлов. Это, своего рода, аналог резервного копирования. При перемещении файлов из источника в хранилище, скрипт обрабатывает несколько заданных параметров и фильтров. Всё настроить можно под себя. По умолчанию, скрипт перемещает файлы из источника в хранилище, и если в хранилище уже имеется старый файл с названием кау у нового перемещаемого, то старый файл архивируется с меткой <code>.[UnixTime].7z</code>.</p><div class="shortcode shortcode-alert"><div class="alert alert-warning d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-exclamation-triangle fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Для работы скрипта необходим архиватор <strong>7-Zip</strong>, а конкретно его облегчённая версия <code>7za.exe</code> с библиотеками из <strong>7-Zip Extra</strong>. Скачать можно с <a title href=https://www.7-zip.org/download.html target=_blank rel="noopener noreferrer nofollow">официального сайта</a>. После скачивания архива, файлы <code>7za.exe</code>, <code>7za.dll</code> и <code>7zxa.dll</code> нужно разместить рядом со скриптом, или в любую дочернюю директорию. Скрипт сам найдёт путь к <code>7za.exe</code>.</p></div></div></div><h2>Скрипт</h2><div class="shortcode shortcode-file mb-3"><div class="card overflow-hidden"><div class=card-header><div class="d-flex align-items-center"><div class=flex-shrink-0><i class="far fa-file-code fa-fw"></i></div><div class="flex-grow-1 mx-2"><code>pwsh.vault.ps1</code></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-fd9cfd0b65e8196b26a4b6f5d007fb47 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Скачать><a class=text-body href=pwsh.vault.ps1 download role=button aria-label=Скачать><i class="fas fa-download fa-fw"></i></a></li><li class=list-inline-item data-bs-tooltip data-bs-title=Открыть><a class=text-body href=pwsh.vault.ps1 target=_blank role=button aria-label=Открыть><i class="fas fa-arrow-up-right-from-square fa-fw"></i></a></li></ul></div></div></div><div class=card-body id=clipboard-fd9cfd0b65e8196b26a4b6f5d007fb47><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>  .VERSION      0.1.4
</span></span></span><span class=line><span class=cl><span class=cm>  .GUID         8fd0ce2c-0288-4d9c-805f-703a0c659ade
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOR       Kitsune Solar
</span></span></span><span class=line><span class=cl><span class=cm>  .AUTHOREMAIL  mail@kitsune.solar
</span></span></span><span class=line><span class=cl><span class=cm>  .COMPANYNAME  iHub TO
</span></span></span><span class=line><span class=cl><span class=cm>  .COPYRIGHT    2023 iHub TO. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=cm>  .LICENSEURI   https://choosealicense.com/licenses/mit/
</span></span></span><span class=line><span class=cl><span class=cm>  .PROJECTURI   https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#</span><span class=k>Requires</span><span class=w> </span><span class=kd>-Version</span><span class=na> 7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  PowerShell &#34;Vault&#34;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  The script moves files to Vault based on various criteria.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Mode
</span></span></span><span class=line><span class=cl><span class=cm>  Script operation mode.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;MV&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Source
</span></span></span><span class=line><span class=cl><span class=cm>  Path to the source. E.g.: &#39;C:\Data\Source&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;${PSScriptRoot}\Source&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Vault
</span></span></span><span class=line><span class=cl><span class=cm>  Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;${PSScriptRoot}\Vault&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_CreationTime
</span></span></span><span class=line><span class=cl><span class=cm>  Time since file creation (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;5270400&#39; (61 day).
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_LastWriteTime
</span></span></span><span class=line><span class=cl><span class=cm>  Time since file modification (in seconds). E.g.: &#39;5270400&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;${P_CreationTime}&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_FileSize
</span></span></span><span class=line><span class=cl><span class=cm>  File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;0kb&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Exclude
</span></span></span><span class=line><span class=cl><span class=cm>  Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;${PSScriptRoot}\vault.exclude.txt&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Logs
</span></span></span><span class=line><span class=cl><span class=cm>  Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;${PSScriptRoot}\Logs&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_RemoveDirs
</span></span></span><span class=line><span class=cl><span class=cm>  Removing empty directories.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;false&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .PARAMETER P_Overwrite
</span></span></span><span class=line><span class=cl><span class=cm>  Overwrite existing files in Vault.
</span></span></span><span class=line><span class=cl><span class=cm>  Default: &#39;false&#39;.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .\pwsh.vault.ps1 -SRC &#39;C:\Data&#39; -DST &#39;C:\Vault&#39; -CT &#39;864000&#39; -WT &#39;864000&#39; -FS &#39;32mb&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  .</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  https://lib.onl/ru/posts/2023/10/4c7aba7c-f5a6-589a-9975-fdb16f2e2862/
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Script operation mode. Default: &#39;MV&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s1>&#39;CP&#39;</span><span class=p>,</span> <span class=s1>&#39;MV&#39;</span><span class=p>,</span> <span class=s1>&#39;RM&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Mode</span> <span class=p>=</span> <span class=s1>&#39;MV&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Path to the source. E.g.: &#39;C:\Data\Source&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;SRC&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Source</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>\Source&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Path to the Vault. E.g.: &#39;C:\Data\Vault&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;DST&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Vault</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>\Vault&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Time since file creation (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (5270400 sec.).&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;CT&#39;</span><span class=p>)][</span><span class=no>long</span><span class=p>]</span><span class=nv>$P_CreationTime</span> <span class=p>=</span> <span class=mf>5270400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Time since file modification (in seconds). E.g.: &#39;5270400&#39;. Default: 61 day (&#39;5270400&#39; sec.).&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;WT&#39;</span><span class=p>)][</span><span class=no>long</span><span class=p>]</span><span class=nv>$P_LastWriteTime</span> <span class=p>=</span> <span class=nv>$P_CreationTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;File size check. E.g.: &#39;5kb&#39; / &#39;12mb&#39;. Default: &#39;0kb&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;FS&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_FileSize</span> <span class=p>=</span> <span class=s1>&#39;0kb&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Path to the file with exceptions. E.g.: &#39;C:\Data\exclude.txt&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;E&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Exclude</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>\vault.exclude.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Path to the directory with logs. E.g.: &#39;C:\Data\Logs&#39;.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$P_Logs</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>\Logs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Removing empty directories.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;RD&#39;</span><span class=p>)][</span><span class=no>switch</span><span class=p>]</span><span class=nv>$P_RemoveDirs</span> <span class=p>=</span> <span class=vm>$false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Overwrite existing files in Vault.&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;O&#39;</span><span class=p>)][</span><span class=no>switch</span><span class=p>]</span><span class=nv>$P_Overwrite</span> <span class=p>=</span> <span class=vm>$false</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CONFIGURATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Timestamp.</span>
</span></span><span class=line><span class=cl><span class=nv>$TS</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nb>Get-Date</span> <span class=n>-Format</span> <span class=s1>&#39;yyyy-MM-dd.HH-mm-ss&#39;</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$UTS</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$([</span><span class=no>DateTimeOffset</span><span class=p>]::</span><span class=n>Now</span><span class=p>.</span><span class=py>ToUnixTimeSeconds</span><span class=p>())</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># New line separator.</span>
</span></span><span class=line><span class=cl><span class=nv>$NL</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>NewLine</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># INITIALIZATION.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-Script</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-TestVault</span>
</span></span><span class=line><span class=cl>  <span class=nb>Start-MoveFiles</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$P_RemoveDirs</span><span class=p>)</span> <span class=p>{</span> <span class=nb>Start-RemoveDirs</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># CREATING VAULT DIRECTORIES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-TestVault</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Dirs</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;</span><span class=nv>${P_Source}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${P_Vault}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Files</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;</span><span class=nv>${P_Exclude}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=nv>$Dir</span> <span class=k>in</span> <span class=nv>$Dirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=p>(</span><span class=nb>Test-Data</span> <span class=n>-T</span> <span class=s1>&#39;D&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${Dir}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span> <span class=nb>New-Data</span> <span class=n>-T</span> <span class=s1>&#39;D&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${Dir}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>Out-Null</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=nv>$File</span> <span class=k>in</span> <span class=nv>$Files</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=p>(</span><span class=nb>Test-Data</span> <span class=n>-T</span> <span class=s1>&#39;F&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span> <span class=nb>New-Data</span> <span class=n>-T</span> <span class=s1>&#39;F&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${File}</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>Out-Null</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># MOVING FILES TO VAULT.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-MoveFiles</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s1>&#39;Moving Files to Vault&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Files</span> <span class=p>=</span> <span class=p>((</span><span class=nb>Get-ChildItem</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${P_Source}</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=o>-File</span> <span class=n>-Exclude</span> <span class=p>(</span><span class=nb>Get-Content</span> <span class=s2>&#34;</span><span class=nv>${P_Exclude}</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>CreationTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$P_CreationTime</span><span class=p>)))</span> <span class=p>`</span>
</span></span><span class=line><span class=cl>      <span class=o>-and</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>LastWriteTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$P_LastWriteTime</span><span class=p>)))</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span> <span class=o>-ge</span> <span class=s2>&#34;</span><span class=nv>${P_FileSize}</span><span class=s2>&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$Files</span><span class=p>)</span> <span class=p>{</span> <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;Required files were not found in the &#39;</span><span class=nv>${P_Source}</span><span class=s2>&#39;!&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>$Files</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$File</span> <span class=p>=</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nv>$File</span><span class=p>.</span><span class=py>FullName</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span> <span class=o>-ge</span> <span class=mf>245</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;W&#39;</span> <span class=n>-M</span> <span class=s2>&#34;Over 250 characters in path! Skip:</span><span class=nv>${NL}</span><span class=s2>&#39;</span><span class=nv>${File}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$PathSRC</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$File</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$PathDST</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$File</span><span class=p>.</span><span class=n>FullName</span><span class=p>)</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$File</span><span class=p>.</span><span class=n>DirectoryName</span><span class=p>)</span><span class=s2>&#34;</span><span class=p>).</span><span class=k>ForEach</span><span class=p>({</span> <span class=nv>$_</span><span class=p>.</span><span class=py>Remove</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span> <span class=nv>$P_Source</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>]</span> <span class=p>=</span> <span class=p>(${</span><span class=n>P_Vault</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Join-Path</span> <span class=n>-ChildPath</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nv>$P_Mode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;CP&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>New-Data</span> <span class=n>-T</span> <span class=s1>&#39;D&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${P_Vault}</span><span class=s2>&#34;</span> <span class=n>-N</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>1</span><span class=p>])</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl>        <span class=nb>Compress-Data</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span> <span class=n>-N</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>.</span><span class=nv>${UTS}</span><span class=s2>.7z&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;[CP] &#39;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#39; -&gt; &#39;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>Copy-Data</span> <span class=n>-S</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span> <span class=n>-D</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;MV&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>New-Data</span> <span class=n>-T</span> <span class=s1>&#39;D&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${P_Vault}</span><span class=s2>&#34;</span> <span class=n>-N</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>1</span><span class=p>])</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl>        <span class=nb>Compress-Data</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span> <span class=n>-N</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>.</span><span class=nv>${UTS}</span><span class=s2>.7z&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;[MV] &#39;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#39; -&gt; &#39;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>Move-Data</span> <span class=n>-S</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span> <span class=n>-D</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathDST</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;RM&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;[RM] &#39;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>Remove-Data</span> <span class=n>-p</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$PathSRC</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># REMOVING EMPTY DIRECTORIES FROM SOURCE.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-RemoveDirs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;HL&#39;</span> <span class=n>-M</span> <span class=s1>&#39;Removing Empty Directories&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Dirs</span> <span class=p>=</span> <span class=p>((</span><span class=nb>Get-ChildItem</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${P_Source}</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=n>-Directory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>CreationTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$P_CreationTime</span><span class=p>)))</span> <span class=p>`</span>
</span></span><span class=line><span class=cl>        <span class=o>-and</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=n>LastWriteTime</span><span class=p>)</span> <span class=o>-lt</span> <span class=p>((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>AddSeconds</span><span class=p>(-</span><span class=nv>$P_LastWriteTime</span><span class=p>)))</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>((</span><span class=nb>Get-ChildItem</span> <span class=nv>$_</span><span class=p>.</span><span class=py>FullName</span> <span class=n>-Force</span><span class=p>).</span><span class=n>Count</span><span class=p>)</span> <span class=o>-eq</span> <span class=mf>0</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-ExpandProperty</span> <span class=s1>&#39;FullName&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$Dirs</span><span class=p>)</span> <span class=p>{</span> <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;No empty directories were found in the &#39;</span><span class=nv>${P_Source}</span><span class=s2>&#39;!&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$Dirs</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$Dir</span> <span class=p>=</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Msg</span> <span class=n>-M</span> <span class=s2>&#34;[RM] &#39;</span><span class=nv>${Dir}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nb>Remove-Data</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${Dir}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span> <span class=p>(</span> <span class=nv>$Dirs</span><span class=p>.</span><span class=py>Count</span> <span class=o>-gt</span> <span class=mf>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># ------------------------------------------------&lt; COMMON FUNCTIONS &gt;------------------------------------------------ #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># WORKING WITH ELEMENTS.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Test-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Container&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;F&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Leaf&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Test-Path</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-PathType</span> <span class=s2>&#34;</span><span class=nv>${Type}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>New-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;SilentlyContinue&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;Directory&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;F&#39;</span> <span class=p>{</span> <span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;File&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>New-Item</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span> <span class=n>-ItemType</span> <span class=s2>&#34;</span><span class=nv>${Type}</span><span class=s2>&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Copy-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;S&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;D&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Dst</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Copy-Item</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Src}</span><span class=s2>&#34;</span> <span class=n>-Destination</span> <span class=s2>&#34;</span><span class=nv>${Dst}</span><span class=s2>&#34;</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Move-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;S&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;D&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Dst</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Move-Item</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Src}</span><span class=s2>&#34;</span> <span class=n>-Destination</span> <span class=s2>&#34;</span><span class=nv>${Dst}</span><span class=s2>&#34;</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Remove-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>Remove-Item</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Compress-Data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Name</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=nv>$P_Overwrite</span> <span class=o>-and</span> <span class=p>(</span><span class=nb>Test-Data</span> <span class=n>-T</span> <span class=s1>&#39;F&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Start</span><span class=p>-</span><span class=n>7z</span> <span class=n>-T</span> <span class=s1>&#39;7z&#39;</span> <span class=n>-L</span> <span class=mf>9</span> <span class=n>-I</span> <span class=s2>&#34;</span><span class=nv>${Path}</span><span class=s2>&#34;</span> <span class=n>-O</span> <span class=s2>&#34;</span><span class=nv>${Name}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># SYSTEM MESSAGES.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Write-Msg</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Action</span> <span class=p>=</span> <span class=s1>&#39;Continue&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nv>$Type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;HL&#39;</span>    <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${NL}</span><span class=s2>--- </span><span class=nv>${Message}</span><span class=s2>&#34;</span><span class=p>.</span><span class=py>ToUpper</span><span class=p>()</span> <span class=n>-ForegroundColor</span> <span class=n>Blue</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;I&#39;</span>     <span class=p>{</span> <span class=nb>Write-Information</span> <span class=n>-MessageData</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-InformationAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;W&#39;</span>     <span class=p>{</span> <span class=nb>Write-Warning</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-WarningAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;E&#39;</span>     <span class=p>{</span> <span class=nb>Write-Error</span> <span class=n>-Message</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=n>-ErrorAction</span> <span class=s2>&#34;</span><span class=nv>${Action}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span> <span class=p>{</span> <span class=nb>Write-Host</span> <span class=s2>&#34;</span><span class=nv>${Message}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># APP: 7-ZIP.</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Start-7z</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$In</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;O&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Out</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s1>&#39;7z&#39;</span><span class=p>,</span> <span class=s1>&#39;BZIP2&#39;</span><span class=p>,</span> <span class=s1>&#39;GZIP&#39;</span><span class=p>,</span> <span class=s1>&#39;TAR&#39;</span><span class=p>,</span> <span class=s1>&#39;WIM&#39;</span><span class=p>,</span> <span class=s1>&#39;XZ&#39;</span><span class=p>,</span> <span class=s1>&#39;ZIP&#39;</span><span class=p>)][</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)][</span><span class=no>string</span><span class=p>]</span><span class=nv>$Type</span> <span class=p>=</span> <span class=s1>&#39;7z&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>ValidateRange</span><span class=p>(</span><span class=mf>1</span><span class=p>,</span><span class=mf>9</span><span class=p>)][</span><span class=nb>Alias</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)][</span><span class=no>int</span><span class=p>]</span><span class=nv>$Level</span> <span class=p>=</span> <span class=mf>5</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># File list for &#39;7za.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$7z</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;7za.exe&#39;</span><span class=p>,</span> <span class=s1>&#39;7za.dll&#39;</span><span class=p>,</span> <span class=s1>&#39;7zxa.dll&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Search &#39;7za.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$7zExe</span> <span class=p>=</span> <span class=p>((</span><span class=nb>Get-ChildItem</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${PSScriptRoot}</span><span class=s2>&#34;</span> <span class=n>-Filter</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$7z</span><span class=p>[</span><span class=mf>0</span><span class=p>])</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=o>-File</span><span class=p>)</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-First</span> <span class=mf>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Getting &#39;7za.exe&#39; directory.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$7zDir</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$7zExe</span><span class=p>.</span><span class=n>DirectoryName</span><span class=p>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Checking the location of files.</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=nv>$File</span> <span class=k>in</span> <span class=nv>$7z</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>-not</span> <span class=p>(</span><span class=nb>Test-Data</span> <span class=n>-T</span> <span class=s1>&#39;F&#39;</span> <span class=n>-P</span> <span class=s2>&#34;</span><span class=nv>${7zDir}</span><span class=s2>\</span><span class=nv>${File}</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>Write-Msg</span> <span class=n>-T</span> <span class=s1>&#39;W&#39;</span> <span class=n>-A</span> <span class=s1>&#39;Stop&#39;</span> <span class=n>-M</span> <span class=p>(</span><span class=s2>&#34;&#39;</span><span class=nv>${File}</span><span class=s2>&#39; not found!</span><span class=nv>${NL}${NL}</span><span class=s2>&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;1. Download 7-Zip Extra from &#39;https://www.7-zip.org/download.html&#39;.</span><span class=nv>${NL}</span><span class=s2>&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;2. Extract all the contents of the archive into a directory &#39;</span><span class=nv>${PSScriptRoot}</span><span class=s2>&#39;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Specifying &#39;7za.exe&#39; parameters.</span>
</span></span><span class=line><span class=cl>  <span class=nv>$Params</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s2>&#34;-t</span><span class=nv>${Type}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;-mx</span><span class=nv>${Level}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${Out}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=nv>${In}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c># Running &#39;7za.exe&#39;.</span>
</span></span><span class=line><span class=cl>  <span class=p>&amp;</span> <span class=s2>&#34;</span><span class=nv>${7zExe}</span><span class=s2>&#34;</span> <span class=nv>$Params</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------&lt; RUNNING SCRIPT &gt;------------------------------------------------- #</span>
</span></span><span class=line><span class=cl><span class=c># -------------------------------------------------------------------------------------------------------------------- #</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Start-Transcript</span> <span class=n>-LiteralPath</span> <span class=s2>&#34;</span><span class=nv>${P_Logs}</span><span class=s2>\</span><span class=p>$((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=n>Year</span><span class=p>)</span><span class=s2>\</span><span class=p>$((</span><span class=nb>Get-Date</span><span class=p>).</span><span class=n>Month</span><span class=p>)</span><span class=s2>\</span><span class=nv>${TS}</span><span class=s2>.log&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Start-Script</span>
</span></span><span class=line><span class=cl><span class=nb>Stop-Transcript</span></span></span></code></pre></div></div></div></div></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-warning" data-bs-tooltip data-bs-title='Уровень сложности: Средний'><i class="far fa-face-meh fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-20T09:57:21Z data-fn=date-local>2023/10/20 09:57:21 UTC</time></li></ul></div></div></div></div></div><div class=col><article class=node-articles><header><div class="node-cover mb-3"><a title="Дефрагментация в ОС Windows" class=d-block href=/ru/articles/2023/10/eb39e3f7-b194-53d4-8bad-01edf9fdac47/ data-bs-toggle=modal data-bs-target=#modal-7ee46f5afcb8efcf647b56ad0cfd905c><picture><source srcset='https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=640&amp;h=360&amp;fit=crop&amp;auto=compress,format 640w,https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=768&amp;h=432&amp;fit=crop&amp;auto=compress,format 768w,https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=1024&amp;h=576&amp;fit=crop&amp;auto=compress,format 1024w,https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=1280&amp;h=720&amp;fit=crop&amp;auto=compress,format 1280w,https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format 1600w' sizes="(min-width: 576px) 100vw"><img class="d-block w-100 h-100 rounded" src="https://images.unsplash.com/photo-1591913139332-f8172ef511da?crop=entropy&amp;w=1600&amp;h=900&amp;fit=crop&amp;auto=compress,format" width=1600 height=900 alt="Дефрагментация в ОС Windows"></picture></a></div><div class=node-title><h2 class=h5><a href=/ru/articles/2023/10/eb39e3f7-b194-53d4-8bad-01edf9fdac47/ data-bs-toggle=modal data-bs-target=#modal-7ee46f5afcb8efcf647b56ad0cfd905c>Дефрагментация в ОС Windows</a></h2></div></header><div class=node-body><p>При работе с оборудованием, мне приходится сталкиваться с довольно старыми устройствами, их их работу нужно как-нибудь оптимизировать. Одним из вариантов оптимизации является дефрагментация HDD.</p></div></article><div class="modal fade" id=modal-7ee46f5afcb8efcf647b56ad0cfd905c tabindex=-1 aria-labelledby=modal-7ee46f5afcb8efcf647b56ad0cfd905c-label aria-hidden=true><div class="modal-dialog modal-fullscreen"><div class=modal-content><div class=modal-header><h2 class="modal-title fs-5 text-truncate" id=modal-7ee46f5afcb8efcf647b56ad0cfd905c-label><a href=/ru/articles/2023/10/eb39e3f7-b194-53d4-8bad-01edf9fdac47/>Дефрагментация в ОС Windows</a></h2><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class=modal-body><div class=node-body><p>При работе с оборудованием, мне приходится сталкиваться с довольно старыми устройствами, их их работу нужно как-нибудь оптимизировать. Одним из вариантов оптимизации является дефрагментация HDD.</p><h2>PowerShell</h2><p>Командлет по дефрагментации для PowerShell называется <code>Optimize-Volume</code> и может принимать следующие параметры:</p><ul><li><code>-Analyze</code> - выполнение анализа указанного тома.</li><li><code>-Defrag</code> - выполнение дефрагментации указанного тома.</li><li><code>-DriveLetter</code> - буква тома.</li><li><code>-NormalPriority</code> - выполнение процесса с нормальным приоритетом (по умолчанию приоритет пониженный).</li><li><code>-ReTrim</code> - выполнение TRIM-операции для SSD.</li></ul><p>Это наиболее востребованные параметры. Остальные параметры можно посмотреть в <a title href=https://learn.microsoft.com/en-us/powershell/module/storage/optimize-volume target=_blank rel="noopener noreferrer nofollow">официальной документации</a>.</p><div class="shortcode shortcode-alert"><div class="alert alert-success d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-lightbulb fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Для всех команд можно добавить параметр <code>-Verbose</code>, который выводит подробную информацию о происходящем процессе.</p></div></div></div><h3>Анализ тома</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-0 shortcode-codeblock-powershell"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-63480de7eff3174bd6ed11276f333098><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Optimize-Volume</span> <span class=n>-DriveLetter</span> <span class=n>C</span> <span class=n>-Analyze</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-63480de7eff3174bd6ed11276f333098 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>-DriveLetter C</code> - буква тома (диск C:).</li><li><code>-Analyze</code> - анализ.</li></ul><h3>Дефрагментация</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-1 shortcode-codeblock-powershell"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-22467129bb3dc58bdea60e73bac916a2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Optimize-Volume</span> <span class=n>-DriveLetter</span> <span class=n>C</span> <span class=n>-Defrag</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-22467129bb3dc58bdea60e73bac916a2 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>-DriveLetter C</code> - буква тома (диск C:).</li><li><code>-Defrag</code> - дефрагментация.</li></ul><h3>TRIM-операция для SSD</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-2 shortcode-codeblock-powershell"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-748357a37096118f204f1db15dcbd6e4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Optimize-Volume</span> <span class=n>-DriveLetter</span> <span class=n>C</span> <span class=n>-ReTrim</span></span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-748357a37096118f204f1db15dcbd6e4 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>-DriveLetter C</code> - буква тома (диск C:).</li><li><code>-ReTrim</code> - на дисках SSD запускает TRIM-операцию.</li></ul><h2>CMD Defrag</h2><p>Утилита <code>defrag.exe</code> выполняет анализ и оптимизацию томов через командную строку. Утилита может принимать следующие параметры:</p><ul><li>Тома:<ul><li><code>/c</code> - выполнение операции на всех томах.</li><li><code>/e</code> - выполнение операции на всех томах, кроме указанных.</li></ul></li><li>Операции:<ul><li><code>/a</code> - анализ указанных томов.</li><li><code>/d</code> - выполнение традиционной дефрагментации (по умолчанию). На многоуровневом томе традиционная дефрагментация выполняется только на уровне ёмкости.</li><li><code>/l</code> - выполнение TRIM-операции для SSD.</li><li><code>/o</code> - выполнение правильной оптимизации для каждого типа носителя.</li><li><code>/u</code> - отображение хода операции.</li></ul></li></ul><div class="shortcode shortcode-alert"><div class="alert alert-success d-flex overflow-hidden" role=alert><div class="flex-shrink-0 align-self-center"><i class="fas fa-lightbulb fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Для всех команд можно добавить параметр <code>/v</code>, который выводит подробную информацию о происходящем процессе.</p></div></div></div><h3>Анализ тома</h3><p>Анализ тома, с отображением хода выполнения и выводом результатов в подробном формате:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-3 shortcode-codeblock-cmd"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-f77c8f729448c054a06ebe2b5eef45eb><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>defrag c: /u /a</span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f77c8f729448c054a06ebe2b5eef45eb role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>c:</code> - буква тома (диск <code>C:</code>).</li><li><code>/u</code> - отображение хода выполнения операции.</li><li><code>/a</code> - анализ.</li></ul><h3>Параллельная дефрагментация</h3><p>Параллельная дефрагментация томов <code>C:</code> и <code>D:</code> в фоновом режиме:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-4 shortcode-codeblock-cmd"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-f060ea8d4dc3a6e2de0a49aa384c4570><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>defrag c: d: /m</span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-f060ea8d4dc3a6e2de0a49aa384c4570 role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>c:</code> - буква тома (диск <code>C:</code>).</li><li><code>d:</code> - буква тома (диск <code>D:</code>).</li><li><code>/m</code> - выполнение операции с каждым томом параллельно в фоновом режиме.</li></ul><h3>Дефрагментация всех томах</h3><p>Выполнить дефрагментацию на всех локальных томах с нормальным приоритетом:</p><div class="shortcode shortcode-codeblock shortcode-codeblock-5 shortcode-codeblock-cmd"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-0afe36441d7002abc6b75a32892db65c><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>defrag /u /c /h</span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-0afe36441d7002abc6b75a32892db65c role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>/u</code> - отображение хода выполнения операции.</li><li><code>/c</code> - выполнение операции на всех томах.</li><li><code>/h</code> - выполнение операции с нормальным приоритетом (по умолчанию приоритет пониженный).</li></ul><h3>TRIM-операция для SSD</h3><div class="shortcode shortcode-codeblock shortcode-codeblock-6 shortcode-codeblock-cmd"><div class="d-flex mb-3 overflow-hidden"><div class="flex-grow-1 rounded overflow-hidden" id=clipboard-a1487667465c9ce34c33f1890af1ad8b><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>defrag /u /c /l</span></span></code></pre></div></div><div class=flex-shrink-0><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=Копировать><a class=text-body href=# data-fn="clipboard preventDefault" data-clipboard-target=#clipboard-a1487667465c9ce34c33f1890af1ad8b role=button aria-label=Копировать><i class="fas fa-copy fa-fw"></i></a></li></ul></div></div></div><p>Где:</p><ul><li><code>/u</code> - отображение хода выполнения операции.</li><li><code>/c</code> - выполнение операции на всех томах.</li><li><code>/l</code> или <code>/retrim</code> - на дисках SSD запускает TRIM-операцию.</li></ul></div></div><div class=modal-footer><ul class="list-inline text-center text-body-secondary small"><li class=list-inline-item><a href=https://lib.onl/ru/tags/hdd/>#hdd</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/ssd/>#ssd</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/powershell/>#powershell</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/cmd/>#cmd</a></li><li class=list-inline-item><a href=https://lib.onl/ru/tags/defrag/>#defrag</a></li><li class=list-inline-item>&bull;</li><li class="list-inline-item text-success" data-bs-tooltip data-bs-title='Уровень сложности: Простой'><i class="far fa-face-smile fa-fw"></i></li><li class=list-inline-item>&bull;</li><li class=list-inline-item><time datetime=2023-10-20T00:46:16Z data-fn=date-local>2023/10/20 00:46:16 UTC</time></li></ul></div></div></div></div></div></div></div></div></div></div></main><footer class="mt-auto border-top bg-light"><div class="section py-5 border-bottom"><div class=container><div class="row g-3"><div class=col-lg><article><h2 class="h5 border-bottom pb-1 mb-3">О проекте</h2><div class=node-body><p>Заметки по системному администрированию и веб-разработкам.</p></div></article></div><div class=col-lg><article><h2 class="h5 border-bottom pb-1 mb-3">Ресурсы</h2><div class=node-body><ul><li><a title href=https://kitsune.solar/ target=_blank rel="noopener noreferrer nofollow">Kitsune Solar</a></li><li><a title href=https://uaik.github.io/ target=_blank rel="noopener noreferrer nofollow">UNIX AIK</a></li></ul></div></article></div><div class=col-lg><article><h2 class="h5 border-bottom pb-1 mb-3">Контакты</h2><div class=node-body><ul><li><a title href=mailto:mail@lib.onl target=_self rel>Email</a></li></ul></div></article></div></div></div></div><div class="section py-3"><div class=container><div class="row row-cols-1 row-cols-lg-2 small text-body-secondary align-items-center"><div class="col text-center text-lg-start"><ul class="list-inline mb-0"><li class=list-inline-item><div>Library Online &copy; 2023</div><div>Заметки на тему администрирования и разработки различных систем, приложений и серверов.</div></li></ul></div><div class="col text-center text-lg-end"><ul class="list-inline mb-0"><li class=list-inline-item data-bs-tooltip data-bs-title=RSS><a class="btn btn-light btn-sm" href=/ru/index.xml target=_blank aria-label=RSS><i class="fas fa-rss fa-fw"></i></a></li><li class="list-inline-item dropup" data-bs-tooltip data-bs-title=Языки><a class="dropdown-toggle btn btn-light btn-sm" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false aria-label=Языки><i class="fas fa-language fa-fw"></i></a><div class="dropdown-menu dropdown-menu-end shadow"><a class=dropdown-item href=/ru/ hreflang=ru>Русский
</a><a class=dropdown-item href=/en/ hreflang=en>English</a></div></li></ul></div></div></div></div></footer><div class="modal fade" id=search-modal tabindex=-1 aria-labelledby=searchModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-xl"><div class=modal-content><div class=modal-header><h5 class=modal-title id=searchModalLabel>Поиск</h5><button type=button class=btn-close data-bs-dismiss=modal aria-label=Закрыть></button></div><div class="modal-body node-body"><div class="row row-cols-1 g-3"><div class=col><div class="row g-3"><div class=col-lg><form action=https://google.com/search method=get class=d-flex target=_blank><input type=hidden name=domains value=lib.onl>
<input type=hidden name=sitesearch value=lib.onl><div class=input-group><span class=input-group-text><i class="fas fa-search fa-fw"></i></span>
<input type=search class=form-control name=q placeholder='Поиск Google' aria-label='Поиск Google'>
<span class=input-group-text><i class="fab fa-google fa-fw"></i></span></div></form></div><div class=col-lg><form action=https://ya.ru/search method=get class=d-flex target=_blank><input type=hidden name=site value=lib.onl><div class=input-group><span class=input-group-text><i class="fas fa-search fa-fw"></i></span>
<input type=search class=form-control name=text placeholder='Поиск Яндекс' aria-label='Поиск Яндекс'>
<span class=input-group-text><i class="fab fa-yandex fa-fw"></i></span></div></form></div></div></div><div class=col><form id=search-form method=get class=d-flex autocomplete=off><div class=input-group><span class=input-group-text><i class="fas fa-search fa-fw"></i></span>
<input id=search-input type=search class=form-control name=q placeholder='Внутренний поиск' aria-label='Внутренний поиск'>
<span class=input-group-text><i class="fas fa-brain fa-fw"></i></span></div></form></div><div class=col><div class="list-group list-group-flush d-none overflow-auto" id=search-results></div><div id=search-help><div class="alert alert-info d-flex align-items-center overflow-hidden node-body" id=alert-e7d48c9fcf92cda6c322db4056817848 role=alert><div class=flex-shrink-0><i class="fas fa-search fa-fw fa-2x"></i></div><div class="flex-grow-1 ms-3 overflow-hidden"><p>Используется нечёткий поиск (приблизительное сопоставление строк).
Это метод поиска строк, которые приблизительно соответствуют поисковому шаблону.</p><p>Результаты поиска сортируются по точности совпадения с поисковым шаблоном.
Результаты поиска, наиболее точно соответствующие запросу, находятся сверху, приблизительные результаты - снизу.</p></div></div></div></div></div></div></div></div></div><script src=/js/vendor.bundle.min.js defer></script><script src=/ru/js/system.bundle.min.js defer></script></body></html>